<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTCD · Revisión de Facturas</title>
  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- JSZip + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@0.453.0/font/lucide.css">
  <style>
    :root{
      --sidebar-bg:#0F1B2D;
      --sidebar-hover:#122239;
      --primary:#0FA47E;
      --primary-600:#0b8466;
      --surface:#F3F5F7;
      --card:#FFFFFF;
      --text:#0b1220;
      --muted:#6b7280;
      --ring:rgba(15,164,126,.35);
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      color:var(--text);
      background:var(--surface);
    }
    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 100vh;
      gap:0;
    }
    .sidebar{
      background:var(--sidebar-bg);
      color:#dbeafe;
      display:flex;
      flex-direction:column;
      padding:18px 14px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      background:#0FA47E10; border:1px solid #0FA47E40;
      color:#d1fae5; padding:8px 10px; border-radius:12px; font-weight:700;
      letter-spacing:.2px;
    }
    .brand .logo{
      width:46px;height:28px;border-radius:8px;
      background:linear-gradient(135deg,#11c29a,#0e9e79);
      display:grid;place-items:center;color:white; font-weight:800;
    }
    .brand .caption{display:flex;flex-direction:column;line-height:1}
    .brand small{opacity:.8; font-weight:600}
    nav{margin-top:18px;display:flex;flex-direction:column;gap:6px}
    .nav-btn{
      color:#dbeafe; border-radius:10px; padding:10px 12px;
      display:flex;align-items:center;gap:10px; text-decoration:none;
      transition: background .15s ease;
    }
    .nav-btn:hover{background:var(--sidebar-hover)}
    .nav-btn.active{background:#ffffff10; border:1px solid #ffffff1f}
    .spacer{flex:1}
    .copyright{font-size:12px; color:#93a3b8; opacity:.7}

    /* Main */
    .main{
      padding:22px 24px;
      overflow:auto;
    }
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;
    }
    .toolbar h1{font-size:22px; margin:0}
    .actions{display:flex; gap:10px}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb;
      background:var(--card); cursor:pointer; font-weight:600;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
    }
    .btn:focus{outline:2px solid var(--ring); outline-offset:2px}
    .btn-primary{ background:var(--primary); color:white; border-color:transparent}
    .btn-primary:hover{ background:var(--primary-600)}
    .btn-ghost{ background:transparent; border-color:#e5e7eb}
    .btn-danger{ background:var(--danger); color:white; border-color:transparent }
    /* Grid */
    .grid{
      display:grid; gap:14px;
    }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .card{
      background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:16px;
    }
    .kpi{
      display:flex; flex-direction:column; gap:4px;
    }
    .kpi .label{ color:var(--muted); font-size:13px; font-weight:600}
    .kpi .value{ font-size:28px; font-weight:800}
    .filters{
      display:grid; grid-template-columns: 180px 180px 1fr 220px auto; gap:10px; align-items:center;
      margin-top:10px;
    }
    .input, select{
      width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:white;
      font-size:14px;
    }
    .input:focus, select:focus{ outline:2px solid var(--ring); outline-offset:2px}
    .table-wrap{ margin-top:8px }
    .tabulator{ border-radius:14px; border:1px solid #e5e7eb }
    .muted{ color:var(--muted) }
    /* Overlay */
    .overlay{
      position: fixed; inset:0; display:none; place-items:center; background:rgba(15, 18, 30, .35); z-index:50;
    }
    .overlay .bubble{
      background:white; border-radius:12px; border:1px solid #e5e7eb; padding:10px 14px;
      display:flex; align-items:center; gap:10px; font-weight:600;
      box-shadow: 0 10px 20px rgba(2,8,23,.20);
    }
    .spinner{ width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:#0FA47E;border-radius:50%; animation:spin .9s linear infinite }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    /* Utilities */
    .hidden{ display:none !important }
    @media (max-width:1024px){
      .app{ grid-template-columns: 82px 1fr}
      .brand .caption{display:none}
      .nav-btn span{ display:none }
      .filters{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">UTCD</div>
        <div class="caption">
          <span>Aplicativo</span>
          <small>de Facturas</small>
        </div>
      </div>

      <nav>
        <a class="nav-btn active" href="#revision"><i class="lucide-list"></i><span>Revisión de Facturas</span></a>
        <a class="nav-btn" href="#pago"><i class="lucide-wallet"></i><span>Pago</span></a>
        <a class="nav-btn" href="#anticipos"><i class="lucide-coins"></i><span>Anticipos</span></a>
      </nav>
      <div class="spacer"></div>
      <div class="copyright">© UTCD 2025</div>
    </aside>

    <main class="main">
      <div class="toolbar">
        <h1>Revisión de Facturas</h1>
        <div class="actions">
          <button id="btnActualizar" class="btn"><i class="lucide-rotate-cw"></i> Actualizar</button>
          <button id="btnDescargar" class="btn btn-primary"><i class="lucide-file-down"></i> Descargar PDFs</button>
        </div>
      </div>

      <div class="grid cols-3">
        <div class="card kpi">
          <span class="label">Registradas</span>
          <span id="kpiRegistradas" class="value">0</span>
        </div>
        <div class="card kpi">
          <span class="label">Revisadas</span>
          <span id="kpiRevisadas" class="value">0</span>
        </div>
        <div class="card kpi">
          <span class="label">Anuladas</span>
          <span id="kpiAnuladas" class="value">0</span>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="filters">
          <select id="fSector">
            <option value="">Todos</option>
          </select>
          <select id="fEstado">
            <option value="">Todos</option>
          </select>
          <input id="fNumero" class="input" placeholder="Nº Factura…"/>
          <input id="fFecha" class="input" placeholder="Rango"/>
          <button id="btnLimpiar" class="btn btn-ghost"><i class="lucide-broom"></i> Limpiar</button>
        </div>
        <div class="table-wrap">
          <div id="tablaRevision"></div>
        </div>
      </div>

      <p class="muted" style="margin-top:10px;">Consejo: usa los filtros para reducir el conjunto y luego “Descargar PDFs”.</p>
    </main>
  </div>

  <div id="overlay" class="overlay">
    <div class="bubble"><div class="spinner"></div><span id="overlayMsg">Cargando facturas…</span></div>
  </div>

<script>
/** =========================
 *  Configuración
 *  ========================= */
const Config = {
  // Ajusta estas URLs a tu despliegue (coinciden con tu arquitectura actual)
  api: {
    leerFacturas: "https://repositorio-de-pruebas.pages.dev/api/leer",
    guardar: "/api/guardar",
    anticipos: "/api/Anticipos",
    guardarAnti: "/api/GuardarAnti",
    // Proxy para PDFs
    proxyBase: "https://repositorio-de-pruebas.pages.dev/api",
  },
  tablaHeight: "560px",
};

/** =========================
 *  Utilidades de UI
 *  ========================= */
const $ = (sel)=>document.querySelector(sel);
const overlay = {
  show(msg="Cargando…"){ $("#overlayMsg").textContent = msg; $("#overlay").style.display="grid"; },
  hide(){ $("#overlay").style.display="none"; }
};
const fmt = {
  money(v){ const n=Number(v||0); return n.toLocaleString("es-CO",{style:"currency",currency:"COP",maximumFractionDigits:0}); },
  dateISO(d){ const x = new Date(d); if(isNaN(x)) return ""; return x.toISOString().slice(0,10); },
};

/** Mapea alias de campos al esquema esperado por la tabla */
function normalizeRow(src){
  if(!src || typeof src!=="object") return null;
  const g = (keys, fallback="")=>{
    for(const k of keys){
      if(src[k]!=null && src[k]!=="" ) return src[k];
    }
    return fallback;
  };
  const row = {
    Sector:    g(["Sector","SECTOR","sector"]),
    Placa:     g(["Placa","PLACA","placa","Dato Placa","DatoPlaca"]),
    Fecha:     g(["Fecha","Fecha Factura","FECHA","fecha"]),
    "Nº Factura": g(["Nº Factura","NoFactura","No Factura","Numero","NroFactura","Nro Factura","Factura","No_Factura"]),
    Proveedor: g(["Proveedor","PROVEEDOR","proveedor","Razon Social","RazonSocial"]),
    Total:     g(["Total","TOTAL","VALOR","Valor","Importe","Monto"], 0),
    Estado:    g(["Estado","ESTADO","estado"], "Registrada"),
    Enlace:    g(["Enlace","URL","Pdf","PDF","Link","Archivo","Ruta","Documento","DocumentoURL"]),
    PDF:       g(["PDF","pdf","EnlacePDF","DocumentoPDF"]),
  };
  return row;
}

/** =========================
 *  Capa de datos (API)
 *  ========================= */
const API = {
  async getFacturas(){
    const res = await fetch(Config.api.leerFacturas, {cache:"no-store", mode:"cors"});
    if(!res.ok) throw new Error("No se pudo leer facturas");
    const data = await res.json();
    const arr = Array.isArray(data)? data : [];
    console.log("Facturas recibidas:", arr.length);
    return arr.map(normalizeRow).filter(r=>r); // no filtramos por nº factura todavía
  },
  proxied(url){
    const base = Config.api.proxyBase.replace(/\/$/,"");
    const u = encodeURIComponent(url);
    return `${base}/proxy?url=${u}`;
  },
  async fetchPdfBlob(url){
    // Intenta por proxy, valida header %PDF
    const tryFetch = async (u)=>{
      const r = await fetch(u);
      if(!r.ok) throw new Error("HTTP "+r.status);
      const b = await r.blob();
      // Chequeo básico de PDF
      const head = await b.slice(0,5).text().catch(()=>null);
      if(head && head.startsWith("%PDF")) return b;
      // Si el content-type ya es application/pdf, también lo aceptamos
      const ctype = r.headers.get("content-type")||"";
      if(ctype.includes("application/pdf")) return b;
      throw new Error("El recurso no parece ser un PDF");
    };
    try{
      return await tryFetch(API.proxied(url));
    }catch(e){
      console.warn("Proxy falló, intentando directo:", e);
      return await tryFetch(url);
    }
  }
};

/** =========================
 *  Estado
 *  ========================= */
const State = {
  raw: [],
  get filtered(){
    const s = $("#fSector").value.trim();
    const e = $("#fEstado").value.trim();
    const n = $("#fNumero").value.trim().toLowerCase();
    const dr = $("#fFecha")._range || null;

    return State.raw.filter(row=>{
      const sector = (row.Sector||"").toString();
      const estado = (row.Estado||"").toString();
      const numero = (row["Nº Factura"]||row.NoFactura||"").toString();
      const fecha  = (row.Fecha||row["Fecha Factura"]||row["FechaFactura"]||"").toString();

      if(s && sector !== s) return false;
      if(e && estado !== e) return false;
      if(n && !numero.toLowerCase().includes(n)) return false;

      if(dr){
        const f = new Date(fecha);
        if(isNaN(f)) return false;
        if(f < dr[0] || f > dr[1]) return false;
      }
      return true;
    });
  }
};

/** =========================
 *  Tabulator
 *  ========================= */
let table;
let tableBuilt = false;

function buildTable(){
  if(table){ return; }
  table = new Tabulator("#tablaRevision", {
    height: Config.tablaHeight,
    data: State.filtered,
    layout:"fitColumns",
    placeholder:"Sin datos",
    selectable:true,
    pagination:false,
    reactiveData:false,
    columns:[
      {title:"Sector", field:"Sector", width:120, headerSort:true},
      {title:"Placa", field:"Placa", width:110},
      {title:"Fecha", field:"Fecha", width:120},
      {title:"Nº Factura", field:"Nº Factura", width:150},
      {title:"Proveedor", field:"Proveedor", width:220},
      {title:"Total", field:"Total", hozAlign:"right", width:130, formatter:(c)=>fmt.money(c.getValue())},
      {title:"Estado", field:"Estado", width:130, headerSort:true, formatter:(c)=>{
        const v = c.getValue()||"Registrada";
        const color = v==="Anulada" ? "var(--danger)" : (v==="Revisada"?"#2563eb": "#0FA47E");
        return `<span style="font-weight:700;color:${color}">${v}</span>`;
      }},
      {title:"PDF", field:"Enlace", width:90, formatter:(cell)=>{
        const url = cell.getValue() || cell.getRow().getData().PDF || "";
        if(!url) return "";
        return `<a href="${API.proxied(url)}" target="_blank" title="Abrir PDF"><i class="lucide-file-text"></i></a>`;
      }}
    ],
    dataLoaded:updateKpis,
    dataFiltered:updateKpis,
    rowSelectionChanged:updateButtons,
  });
  table.on("tableBuilt", ()=>{
    tableBuilt = true;
    // Al construirse por primera vez, aseguramos KPIs y botones
    updateKpis();
    updateButtons();
  });
}

function updateButtons(){
  // En esta vista descargamos por el conjunto filtrado; el botón siempre activo si hay filas
  const hasRows = (table?.getDataCount()||0) > 0;
  $("#btnDescargar").disabled = !hasRows;
}

function updateKpis(){
  const rows = table? table.getData("active") : [];
  const total = rows.length;
  const revisadas = rows.filter(r=> (r.Estado||"") === "Revisada").length;
  const anuladas  = rows.filter(r=> (r.Estado||"") === "Anulada").length;
  $("#kpiRegistradas").textContent = total;
  $("#kpiRevisadas").textContent = revisadas;
  $("#kpiAnuladas").textContent  = anuladas;
  updateButtons();
}

/** =========================
 *  Filtros
 *  ========================= */
function initFilters(){
  // Flatpickr range
  const fp = flatpickr("#fFecha", {
    mode:"range",
    dateFormat:"Y-m-d",
    onChange(selectedDates){
      if(selectedDates.length===2){
        // normalizamos a extremos del día
        selectedDates[0].setHours(0,0,0,0);
        selectedDates[1].setHours(23,59,59,999);
        $("#fFecha")._range = selectedDates;
      }else{
        $("#fFecha")._range = null;
      }
      applyFilters();
    }
  });
  // Inputs
  $("#fSector").addEventListener("change", applyFilters);
  $("#fEstado").addEventListener("change", applyFilters);
  const debouncedNumero = debounce(applyFilters, 250);
  $("#fNumero").addEventListener("input", debouncedNumero);
  $("#btnLimpiar").addEventListener("click", clearFilters);
}

function clearFilters(){
  $("#fSector").value = "";
  $("#fEstado").value = "";
  $("#fNumero").value = "";
  $("#fFecha").value = "";
  $("#fFecha")._range = null;
  applyFilters();
}

function applyFilters(){
  if(!table){ return; }
  if(!tableBuilt){
    // Deferir hasta que la tabla esté lista
    (function(){
    const handler = ()=>{
      try{ table.off("tableBuilt", handler); }catch(e){}
      table.replaceData(State.filtered);
    };
    table.on("tableBuilt", handler);
  })();
    return;
  }
  table.replaceData(State.filtered);
}

/** =========================
 *  Descarga de PDFs (ZIP)
 *  ========================= */
async function descargarZip(){
  const rows = table? table.getData("active") : [];
  if(!rows.length) return;

  overlay.show("Descargando PDFs…");
  const zip = new JSZip();

  // Descargamos en serie-controlada para no saturar el proxy
  const chunk = 5;
  for(let i=0; i<rows.length; i+=chunk){
    const slice = rows.slice(i,i+chunk);
    await Promise.all(slice.map(async (r, idx)=>{
      const url = r.Enlace || r.PDF;
      if(!url) return;
      try{
        const blob = await API.fetchPdfBlob(url);
        const fecha = (r.Fecha || "").toString().slice(0,10).replaceAll("/","-");
        const placa = (r.Placa||"NA").toString().replace(/\s+/g,"");
        const num   = (r["Nº Factura"]||r.NoFactura||"NA").toString().replace(/[^\w\-]/g,"");
        const name  = `${fecha}_${placa}_${num}.pdf`;
        zip.file(name, blob);
      }catch(e){
        console.warn("Fallo PDF para", url, e);
      }
    }));
  }

  const content = await zip.generateAsync({type:"blob"});
  saveAs(content, `Facturas_UTCD_${new Date().toISOString().slice(0,10)}.zip`);
  overlay.hide();
}

/** =========================
 *  Helpers
 *  ========================= */
function debounce(fn, wait=200){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), wait); };
}

/** =========================
 *  Bootstrap
 *  ========================= */
async function bootstrap(){
  initFilters();
  $("#btnActualizar").addEventListener("click", loadData);
  $("#btnDescargar").addEventListener("click", descargarZip);
  overlay.show("Cargando facturas…");
  await loadData();
  overlay.hide();
}

async function loadData(){
  overlay.show("Cargando facturas…");
  try{
    const data = await API.getFacturas();
    State.raw = data;
    // poblar selects dinámicamente
    const sectores = Array.from(new Set(data.map(r=>r.Sector).filter(Boolean))).sort();
    const estados  = Array.from(new Set(data.map(r=>r.Estado||"Registrada"))).sort();
    $("#fSector").innerHTML = '<option value="">Todos</option>' + sectores.map(s=>`<option>${s}</option>`).join("");
    $("#fEstado").innerHTML = '<option value="">Todos</option>' + estados.map(s=>`<option>${s}</option>`).join("");
    buildTable();
    if(tableBuilt){ applyFilters(); } else {
      (function(){
        const handler = ()=>{
          try{ table.off("tableBuilt", handler); }catch(e){}
          applyFilters();
        };
        table.on("tableBuilt", handler);
      })();
    }
    console.log("Filas normalizadas:", State.raw.length);
  }catch(e){
    console.error(e);
    alert("No fue posible cargar las facturas.");
  }finally{
    overlay.hide();
  }
}

window.addEventListener("DOMContentLoaded", bootstrap);
</script>
</body>
</html>
