<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTCD ¬∑ Revisi√≥n de Facturas</title>
  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- JSZip + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@0.453.0/font/lucide.css">
  <style>
    :root{
      --sidebar-bg:#0F1B2D;
      --sidebar-hover:#122239;
      --primary:#0FA47E;
      --primary-600:#0b8466;
      --surface:#F3F5F7;
      --card:#FFFFFF;
      --text:#0b1220;
      --muted:#6b7280;
      --ring:rgba(15,164,126,.35);
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      color:var(--text);
      background:var(--surface);
    }
    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 100vh;
      gap:0;
    }
    .sidebar{
      background:var(--sidebar-bg);
      color:#dbeafe;
      display:flex;
      flex-direction:column;
      padding:18px 14px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      background:#0FA47E10; border:1px solid #0FA47E40;
      color:#d1fae5; padding:8px 10px; border-radius:12px; font-weight:700;
      letter-spacing:.2px;
    }
    .brand .logo{
      width:46px;height:28px;border-radius:8px;
      background:linear-gradient(135deg,#11c29a,#0e9e79);
      display:grid;place-items:center;color:white; font-weight:800;
    }
    .brand .caption{display:flex;flex-direction:column;line-height:1}
    .brand small{opacity:.8; font-weight:600}
    nav{margin-top:18px;display:flex;flex-direction:column;gap:6px}
    .nav-btn{
      color:#dbeafe; border-radius:10px; padding:10px 12px;
      display:flex;align-items:center;gap:10px; text-decoration:none;
      transition: background .15s ease;
    }
    .nav-btn:hover{background:var(--sidebar-hover)}
    .nav-btn.active{background:#ffffff10; border:1px solid #ffffff1f}
    .spacer{flex:1}
    .copyright{font-size:12px; color:#93a3b8; opacity:.7}

    /* Main */
    .main{
      padding:22px 24px;
      overflow:auto;
    }
    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;
    }
    .toolbar h1{font-size:22px; margin:0}
    .actions{display:flex; gap:10px}

    .last-updated{
      font-size:12px; color:#6b7280; font-weight:600;
      border:1px dashed #e5e7eb; border-radius:10px; padding:6px 8px;
    }
    .actions{ display:flex; gap:10px; align-items:center }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb;
      background:var(--card); cursor:pointer; font-weight:600;
      box-shadow: 0 1px 0 rgba(15,23,42,.03);
    }
    .btn:focus{outline:2px solid var(--ring); outline-offset:2px}
    .btn-primary{ background:var(--primary); color:white; border-color:transparent}
    .btn-primary:hover{ background:var(--primary-600)}
    .btn-ghost{ background:transparent; border-color:#e5e7eb}
    .btn-danger{ background:var(--danger); color:white; border-color:transparent }
    /* Grid */
    .form-grid{ display:grid; grid-template-columns: 160px 1fr 1fr 1fr 1fr 140px auto auto; gap:10px; align-items:center }
    .grid{
      display:grid; gap:14px;
    }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .grid.cols-4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    .card{
      background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:16px;
    }
    .kpi{
      display:flex; flex-direction:column; gap:4px;
    }
    .kpi .label{ color:var(--muted); font-size:13px; font-weight:600}
    .kpi .value{ font-size:28px; font-weight:800}
    .filters{
      display:grid; grid-template-columns: 180px 180px 160px 1fr 220px auto; gap:10px; align-items:center;
      margin-top:10px;
    }
    .input, select,.choices__inner{
      width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:white;
      font-size:14px;
    }
    .input:focus, select:focus{ outline:2px solid var(--ring); outline-offset:2px}
    .choices.is-open .choices__inner{ border-color: var(--ring); box-shadow: 0 0 0 2px var(--ring); }
    .table-wrap{ margin-top:8px }
    .tabulator{ border-radius:14px; border:1px solid #e5e7eb }
    .muted{ color:var(--muted) }

    /* MultiSelect (checkbox dropdown) */
    /* Estado editor (inline dropdown) */
    .status-pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:700; cursor:pointer; border:1px solid #e5e7eb; background:#fff; }
    .status-pill.disabled{ opacity:.6; cursor:not-allowed; }
    .status-pill .dot{ width:8px; height:8px; border-radius:50% }
    .status-menu{
      position:absolute; z-index:2000; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 24px rgba(2,8,23,.18);
      padding:6px; display:none; min-width:180px;
    }
    .status-menu.open{ display:block }
    .status-item{ display:flex; align-items:center; gap:8px; padding:8px 8px; border-radius:8px; cursor:pointer; }
    .status-item:hover{ background:#f3f4f6 }
    .status-item .dot{ width:8px; height:8px; border-radius:50% }

    .msel{ position:relative; }
    .msel-toggle{
      width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:white;
      display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer; font-size:14px;
    }
    .msel-toggle .label{ color:#9ca3af }
    .msel-toggle .value{ color:var(--text) }
    .msel.open .msel-toggle{ outline:2px solid var(--ring); outline-offset:2px }
    .msel-panel{
      position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:40;
      background:white; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 12px 24px rgba(2,8,23,.18);
      padding:8px; max-height:240px; overflow:auto; display:none;
    }
    .msel.open .msel-panel{ display:block }
    .msel-option{ display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; user-select:none; }
    .msel-option:hover{ background:#f3f4f6 }
    .msel-option input{ width:16px; height:16px }
    /* Overlay */
    /* Progress in overlay */
    .progress-wrap{ display:none; align-items:center; gap:10px; margin-left:8px; }
    .progress{ width:240px; height:8px; background:#e5e7eb; border-radius:9999px; overflow:hidden; }
    .progress .bar{ height:100%; width:0%; background:#2563eb; transition: width .15s ease; }
    .progress-text{ font-size:12px; color:#6b7280; font-weight:700; }

    .overlay{
      position: fixed; inset:0; display:none; place-items:center; background:rgba(15, 18, 30, .35); z-index:50;
    }
    .overlay .bubble{
      background:white; border-radius:12px; border:1px solid #e5e7eb; padding:10px 14px;
      display:flex; align-items:center; gap:10px; font-weight:600;
      box-shadow: 0 10px 20px rgba(2,8,23,.20);
    }
    .spinner{ width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:#0FA47E;border-radius:50%; animation:spin .9s linear infinite }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    /* Utilities */
    .hidden{ display:none !important }
    @media (max-width:1024px){
      .app{ grid-template-columns: 82px 1fr}
      .brand .caption{display:none}
      .nav-btn span{ display:none }
      .filters{ grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">UTCD</div>
        <div class="caption">
          <span>Aplicativo</span>
          <small>de Facturas</small>
        </div>
      </div>

      <nav>
        <a class="nav-btn active" href="#revision"><i class="lucide-list"></i><span>Revisi√≥n de Facturas</span></a>
        <a class="nav-btn" href="#pago"><i class="lucide-wallet"></i><span>Pago</span></a>
        <a class="nav-btn" href="#anticipos"><i class="lucide-coins"></i><span>Anticipos</span></a>
        <a class="nav-btn" href="#placas"><i class="lucide-car"></i><span>Placas</span></a>
      </nav>
      <div class="spacer"></div>
      <div class="copyright">¬© UTCD 2025</div>
    </aside>

    <main class="main">
  <section id="secRevision">
      <div class="toolbar">
        <h1>Revisi√≥n de Facturas</h1>
        <div class="actions">
          <span id="lastUpdated" class="last-updated" title="√öltima actualizaci√≥n">‚Äî</span>
          <button id="btnActualizar" class="btn"><i class="lucide-rotate-cw"></i> Actualizar</button>
          <button id="btnAgrupar" class="btn btn-ghost"><i class="lucide-layers-2"></i> Agrupar por colaborador</button>          <button id="btnExportXLSX" class="btn btn-ghost"><i class="lucide-download"></i> Excel</button>
          <button id="btnDescargar" class="btn btn-primary"><i class="lucide-file-down"></i> Descargar PDFs</button>
        </div>
      </div>

      <div class="grid cols-4">
        <div class="card kpi">
          <span class="label">Registradas</span>
          <span id="kpiRegistradas" class="value">0</span>
        </div>
        <div class="card kpi">
          <span class="label">Revisadas</span>
          <span id="kpiRevisadas" class="value">0</span>
        </div>
        <div class="card kpi">
          <span class="label">Anuladas</span>
          <span id="kpiAnuladas" class="value">0</span>
        </div>
        <div class="card kpi">
          <span class="label">Pagadas</span>
          <span id="kpiPagadas" class="value">0</span>
        </div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="filters">
          <div id="msSector" class="msel" data-placeholder="Sector"></div>
          <div id="msEstado" class="msel" data-placeholder="Estado"></div>
          <input id="fNumero" class="input" placeholder="N¬∫ Factura‚Ä¶"/>
          <input id="fFecha" class="input" placeholder="Rango de fechas"/>
          <button id="btnLimpiar" class="btn btn-ghost"><i class="lucide-broom"></i> Limpiar</button>
        </div>
        <div class="table-wrap">
          <div id="tablaRevision"></div>
        </div>
      </div>

      <p class="muted" style="margin-top:10px;">Consejo: usa los filtros para reducir el conjunto y luego ‚ÄúDescargar PDFs‚Äù.</p>
  </section>

  <!-- ============== Secci√≥n Pago (placeholder) ============== -->
  <section id="secPago" style="display:none;">
    <div class="card"><h2>Pago</h2><p class="muted">Secci√≥n en preparaci√≥n.</p></div>
  </section>

  <!-- ============== Secci√≥n Anticipos (placeholder) ============== -->
  <section id="secAnticipos" style="display:none;">
    <div class="card"><h2>Anticipos</h2><p class="muted">Secci√≥n en preparaci√≥n.</p></div>
  </section>

  <!-- ============== Secci√≥n Placas ============== -->
  <section id="secPlacas" style="display:none;">
    <div class="header-row" style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;">
      <h2 class="title" style="margin:0;display:flex;align-items:center;gap:8px;"><i class="lucide-car"></i> Placas</h2>
      <div class="actions" style="display:flex;gap:10px;">
        <button id="btnPlacasActualizar" class="btn"><i class="lucide-rotate-cw"></i> Actualizar</button>
        <button id="btnPlacasActivar" class="btn btn-ghost"><i class="lucide-check-circle-2"></i> Activar</button>
        <button id="btnPlacasInactivar" class="btn btn-ghost"><i class="lucide-x-circle"></i> Inactivar</button>
        <button id="btnPlacasNueva" class="btn btn-primary"><i class="lucide-plus"></i> Nueva placa</button>
      </div>
    </div>

    <div class="grid cols-3">
      <div class="card kpi"><span class="label">Total</span><span id="kpiPlacasTotal" class="value">0</span></div>
      <div class="card kpi"><span class="label">Activas</span><span id="kpiPlacasActivas" class="value">0</span></div>
      <div class="card kpi"><span class="label">Inactivas</span><span id="kpiPlacasInactivas" class="value">0</span></div>
    </div>


    <div id="placasFormWrap" class="card" style="margin-top:10px; display:none;">
  <div class="form-grid">
    <div style="display:flex; flex-direction:column; gap:4px;">
      <small id="npPlacaLimit" class="muted">Hasta 17 caracteres</small>
      <input id="npPlaca" class="input" placeholder="Placa o VIN (requerido)"/>
      <small id="npPlacaHint" class="muted">Ingresar Placa/VIN sin Guiones</small>
      <small id="npPlacaDup" style="display:none;color:#b91c1c;font-weight:600;">Esta placa/VIN ya existe.</small>
    </div>
    <input id="npNombre" class="input" placeholder="Nombre (Conductor)"/>
    <select id="npSector" class="input"><option value="">Sector‚Ä¶</option></select>
    <select id="npProceso" class="input"><option value="">Proceso‚Ä¶</option></select>
    <input id="npDesignacion" class="input" placeholder="Designaci√≥n (Cargo)"/>
    <select id="npEstado" class="input">
      <option value="Activa">Activa</option>
      <option value="Inactiva">Inactiva</option>
    </select>
    <button id="btnPlacaGuardar" class="btn btn-primary"><i class="lucide-save"></i> Guardar</button>
    <button id="btnPlacaCancelar" class="btn btn-ghost"><i class="lucide-x"></i> Cancelar</button>
  </div>
</div>
        
<div class="card" style="margin-top:10px;">
      <div class="filters" style="grid-template-columns: 180px 1fr 1fr auto;">
        <select id="fPlacasEstado">
          <option value="">Estado</option>
          <option value="Activa">Activa</option>
          <option value="Inactiva">Inactiva</option>
        </select>
        <input id="fPlacasPlaca" class="input" placeholder="Placa o VIN‚Ä¶"/>
        <input id="fPlacasNombre" class="input" placeholder="Nombre Colaborador‚Ä¶"/>
        <div style="display:flex; gap:10px; align-items:center;">
          <button id="btnPlacasLimpiar" class="btn btn-ghost"><i class="lucide-broom"></i> Limpiar</button>
          <span id="placasNotice" class="muted" style="font-size:12px; display:none;">Configura Config.api.placas (un solo endpoint).</span>
        </div>
      </div>
      <div id="tablaPlacas" class="tabulator" style="margin-top:8px;"></div>
    </div>
  </section>

    </main>
  </div>

  <div id="overlay" class="overlay">
    <div class="bubble"><div class="spinner"></div><span id="overlayMsg">Cargando facturas‚Ä¶</span>
      <div class="progress-wrap">
        <div class="progress"><div id="overlayBar" class="bar"></div></div>
        <div class="progress-text" id="overlayCount">0/0</div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  Configuraci√≥n
 *  ========================= */
const Config = {
  // Ajusta estas URLs a tu despliegue (coinciden con tu arquitectura actual)
  api: {
    leerFacturas: "https://repositorio-de-pruebas.pages.dev/api/leer",
    guardar: "/api/guardar",
    anticipos: "/api/Anticipos",
    procesos: "/api/procesos",
    guardarAnti: "/api/GuardarAnti",
    // Proxy para PDFs
    proxyBase: "https://repositorio-de-pruebas.pages.dev/api",
      placas: "/api/placas",
},
  tablaHeight: "560px",
};

/** =========================
 *  Utilidades de UI
 *  ========================= */
const $ = (sel)=>document.querySelector(sel);

const overlay = {
  done: 0, total: 0,
  show(msg="Cargando‚Ä¶"){
    $("#overlayMsg").textContent = msg;
    $("#overlay").style.display = "grid";
    const pw = document.getElementById("overlay")?.querySelector(".progress-wrap");
    const b  = $("#overlayBar"); const c = $("#overlayCount");
    if (pw) pw.style.display = "none";
    if (b) b.style.width = "0%";
    if (c) c.textContent = "0/0";
  },
  startProgress(total){
    this.done = 0; this.total = total || 0;
    const pw = document.getElementById("overlay")?.querySelector(".progress-wrap");
    const b  = $("#overlayBar"); const c = $("#overlayCount");
    if (pw) pw.style.display = "flex";
    if (b) b.style.width = "0%";
    if (c) c.textContent = `0/${this.total}`;
  },
  step(){
    this.done++;
    const b = $("#overlayBar"); const c = $("#overlayCount");
    const pct = this.total ? Math.round(Math.min(100, (this.done/this.total)*100)) : 0;
    if (b) b.style.width = pct + "%";
    if (c) c.textContent = `${this.done}/${this.total}`;
  },
  hide(){
    $("#overlay").style.display = "none";
    this.done = 0; this.total = 0;
    const pw = document.getElementById("overlay")?.querySelector(".progress-wrap");
    const b  = $("#overlayBar"); const c = $("#overlayCount");
    if (pw) pw.style.display = "none";
    if (b) b.style.width = "0%";
    if (c) c.textContent = "0/0";
  }
};

const fmt = {
  money(v){ const n=Number(v||0); return "L " + n.toLocaleString("es-HN",{minimumFractionDigits:2, maximumFractionDigits:2}); },
  dateISO(d){ const x = new Date(d); if(isNaN(x)) return ""; return x.toISOString().slice(0,10); },
};

/** Mapea alias de campos al esquema esperado por la tabla */
function normalizeRow(src){
  if(!src || typeof src!=="object") return null;
  const g = (keys, fallback="")=>{
    for(const k of keys){
      if(src[k]!=null && src[k]!=="" ) return src[k];
    }
    return fallback;
  };
  const row = {
    fila:      g(["fila","_fila","Fila","row","Row","RowIndex","rowIndex"]),
    Sector:    g(["Sector","SECTOR","sector"]),
    Placa:     g(["Placa","PLACA","placa","Dato Placa","DatoPlaca"]),
    Proceso:   g(["Proceso","PROCESO","proceso"]),
    Nombre:    g(["Nombre","NOMBRE","nombre"]),
    Identidad: g(["Identidad","IDENTIDAD","DNI","Cedula","Documento","NIT"]),
    Fecha:     g(["Fecha","Fecha Factura","FECHA","fecha"]),
    "N¬∫ Factura": g(["N¬∫ Factura","NoFactura","No Factura","Numero","NroFactura","Nro Factura","Factura","No_Factura"]),
    "Numero de Factura": g(["Numero de Factura","N√∫mero de Factura","N¬∞ Factura","N¬∫ Factura","NoFactura","Factura"]),
    "Nombre del comercio": g(["Nombre del comercio","Comercio","Proveedor","Razon Social","RazonSocial"]),
    "Enlace PDF": g(["Enlace PDF","Enlace","URL","Pdf","PDF","Link","Archivo","Ruta","Documento","DocumentoURL"]),
    Enlace:    g(["Enlace","URL","Pdf","PDF","Link","Archivo","Ruta","Documento","DocumentoURL"]),
    PDF:       g(["PDF","pdf","EnlacePDF","DocumentoPDF"]),
    "Km Actual": g(["Km Actual","KM","Km","Kilometraje"]),
    "Litros Consumidos": g(["Litros Consumidos","Litros","Consumo (L)","ConsumoL"]),
    Total:     g(["Total Gastado","Total","TOTAL","VALOR","Valor","Importe","Monto"], 0),
    Estado:    g(["Estado","ESTADO","estado"], "Registrada"),
  };
  return row;
}
/** Convierte enlaces de Google Drive a descarga directa */
function toDirectDriveUrl(url){
  if(!url) return url;
  try{
    const u = String(url);
    // https://drive.google.com/file/d/FILE_ID/view?usp=sharing
    const m1 = u.match(/drive\.google\.com\/file\/d\/(.*?)(?:\/|\?|$)/);
    if(m1 && m1[1]) return `https://drive.google.com/uc?export=download&id=${m1[1]}`;
    // https://drive.google.com/open?id=FILE_ID
    const m2 = u.match(/[?&]id=([\w-]+)/);
    if(m2 && m2[1]) return `https://drive.google.com/uc?export=download&id=${m2[1]}`;
    return url;
  }catch(_){ return url; }
}

/** =========================
 *  Capa de datos (API)
 *  ========================= */
const API = {
  async getFacturas(){
    const res = await fetch(Config.api.leerFacturas, {cache:"no-store", mode:"cors"});
    if(!res.ok) throw new Error("No se pudo leer facturas");
    const data = await res.json();
    const arr = Array.isArray(data)? data : [];
return arr.map(normalizeRow).filter(r=>r); // no filtramos por n¬∫ factura todav√≠a
  },
  proxied(url){
    const base = Config.api.proxyBase.replace(/\/$/,"");
    const u = encodeURIComponent(url);
    return `${base}/proxy?url=${u}`;
  },
  async updateEstado(rowData, nuevoEstado){
    // Backend original espera: { actualizarEstado:true, fila, nuevoEstado }
    const filaId = rowData.fila || rowData._fila;
    if(!filaId){
      throw new Error("No se encontr√≥ 'fila' para actualizar (el dataset debe incluir 'fila' o '_fila').");
    }
    const payload = { actualizarEstado:true, fila: filaId, nuevoEstado: nuevoEstado };
    const res = await fetch(Config.api.guardar, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload),
    });
    if(!res.ok){
      const txt = await res.text().catch(()=>"");
      throw new Error("Error HTTP al guardar: "+res.status+" "+txt);
    }
    const json = await res.json().catch(()=>({status:"ERROR"}));
    if(json.status !== "OK"){
      throw new Error(json.message || "El backend no confirm√≥ el cambio.");
    }
    return json;
  },
  async fetchPdfBlob(url){
    // Intenta por proxy, valida header %PDF
    const tryFetch = async (u)=>{
      const r = await fetch(u);
      if(!r.ok) throw new Error("HTTP "+r.status);
      const b = await r.blob();
      // Chequeo b√°sico de PDF
      const head = await b.slice(0,5).text().catch(()=>null);
      if(head && head.startsWith("%PDF")) return b;
      // Si el content-type ya es application/pdf, tambi√©n lo aceptamos
      const ctype = r.headers.get("content-type")||"";
      if(ctype.includes("application/pdf")) return b;
      throw new Error("El recurso no parece ser un PDF");
    };
    try{
      return await tryFetch(API.proxied(url));
    }catch(e){
return await tryFetch(url);
    }
  }
};

/** ========= MultiSelect ========= */
function createMultiSelect(selector, placeholder="Seleccione‚Ä¶", onChange=()=>{}){
  const root = document.querySelector(selector);
  root.classList.add("msel");
  const toggle = document.createElement("button");
  toggle.type = "button";
  toggle.className = "msel-toggle";
  toggle.innerHTML = `<span class="label">${placeholder}</span><i class="lucide-chevron-down"></i>`;
  const panel = document.createElement("div");
  panel.className = "msel-panel";
  root.appendChild(toggle);
  root.appendChild(panel);

  let items = [];
  const selected = new Set();

  function render(){
    // Update toggle text
    if(selected.size === 0){
      toggle.innerHTML = `<span class="label">${placeholder}</span><i class="lucide-chevron-down"></i>`;
    }else{
      const vals = Array.from(selected);
      const summary = vals.length<=2 ? vals.join(", ") : `${vals.length} seleccionados`;
      toggle.innerHTML = `<span class="value">${summary}</span><i class="lucide-chevron-down"></i>`;
    }
    // Render options
    panel.innerHTML = "";
    for(const val of items){
      const id = `${selector.replace('#','')}_${val}`.replace(/\s+/g,'_');
      const lab = document.createElement("label");
      lab.className = "msel-option";
      lab.htmlFor = id;
      lab.innerHTML = `<input id="${id}" type="checkbox" value="${val}"> <span>${val}</span>`;
      const input = lab.querySelector("input");
      input.checked = selected.has(val);
      input.addEventListener("change", ()=>{
        if(input.checked) selected.add(val); else selected.delete(val);
        render();
        onChange();
      });
      panel.appendChild(lab);
    }
  }

  function open(){ root.classList.add("open"); }
  function close(){ root.classList.remove("open"); }
  toggle.addEventListener("click", ()=>{
    if(root.classList.contains("open")) close(); else open();
  });
  document.addEventListener("click", (e)=>{
    if(!root.contains(e.target)) close();
  });

  return {
    setItems(arr){
      items = Array.from(new Set((arr||[]).filter(Boolean)));
      // si una selecci√≥n previa ya no existe, la removemos
      for(const v of Array.from(selected)){ if(!items.includes(v)) selected.delete(v); }
      render();
    },
    getSelected(){ return Array.from(selected); },
    clear(){ selected.clear(); render(); onChange(); },
    select(vals=[]){ selected.clear(); (vals||[]).forEach(v=> items.includes(v)&&selected.add(v)); render(); onChange(); }
  };
}

/** =========================
 *  Estado
 *  ========================= */
const State = {
  raw: [],
  get filtered(){
    const sVals = sectorMS? sectorMS.getSelected() : [];
    const eVals = estadoMS? estadoMS.getSelected() : [];
    const p = ($("#fPlaca")?.value || "").trim().toLowerCase();
    const n = $("#fNumero").value.trim().toLowerCase();
    const dr = $("#fFecha")._range || null;

    return State.raw.filter(row=>{
      const sector = (row.Sector||"").toString();
      const estado = (row.Estado||"").toString();
      const numero = (row["N¬∫ Factura"]||row["Numero de Factura"]||row.NoFactura||"").toString();
      const placa  = (row.Placa||"").toString();
      const fecha  = (row.Fecha||row["Fecha Factura"]||row["FechaFactura"]||"").toString();

      if(sVals.length && !sVals.includes(sector)) return false;
      if(eVals.length && !eVals.includes(estado)) return false;
      if(p && !placa.toLowerCase().includes(p)) return false;
      if(n && !numero.toLowerCase().includes(n)) return false;

      if(dr){
        const f = new Date(fecha);
        if(isNaN(f)) return false;
        if(f < dr[0] || f > dr[1]) return false;
      }
      return true;
    });
  }
};

/** Opciones de estado a partir de datos o valores por defecto */
function getEstadoOptions(){
  const vals = Array.from(new Set(State.raw.map(r=>r.Estado).filter(Boolean)));
  // Orden sugerido
  const def = ["Registrada","Revisada","Anulada"];
  const full = def.concat(vals.filter(v=>!def.includes(v)));
  return full;
}
function estadoColor(v){
  if(v==="Anulada") return "var(--danger)";
  if(v==="Revisada") return "#2563eb";
  if(v==="Pagada") return "#0FA47E";
  return "#111827";
}

/** =========================
 *  Tabulator
 *  ========================= */
let table;
let tableBuilt = false;

function buildTable(){
  if(table){ return; }
  table = new Tabulator("#tablaRevision", {
    height: Config.tablaHeight,
    data: State.filtered,
    layout:"fitColumns",
    placeholder:"Sin datos",
    selectable:true,
    pagination:false,
    reactiveData:false,
    groupStartOpen:false,
    groupHeader:function(value, count, data, group){
      // value = Identidad
      const nombre = (data && data[0] && (data[0].Nombre||data[0].Identidad)) || value;
      const suma = (data||[]).reduce((acc,r)=> acc + (Number(r.Total)||0), 0);
      const totalTxt = new Intl.NumberFormat("es-HN",{minimumFractionDigits:2, maximumFractionDigits:2}).format(suma);
      // data-group-key: usamos value (Identidad) + un hash simple para evitar colisiones visuales
      const key = String(value ?? "").replace(/"/g,"&quot;");
      return `<label class="group-toggle">
                <input type="checkbox" class="group-select" data-group-key="${key}">
                <span>${nombre} (${count})</span>
              </label>
              <span class="kpi-mini">L ${totalTxt}</span>`;
    },
    columns:[
      { formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:40 },
      { title:"Sector", field:"Sector", width:120 },
      { title:"Placa", field:"Placa", width:110 },
      { title:"Proceso", field:"Proceso", width:130 },
      { title:"Nombre", field:"Nombre", width:180 },
      { title:"Identidad", field:"Identidad", width:150 },
      { title:"Total Gastado", field:"Total", hozAlign:"right", width:140, formatter:(c)=>fmt.money(c.getValue())},
      { title:"Fecha", field:"Fecha", width:120, formatter:(c)=>{ const v=c.getValue(); return v? String(v).slice(0,10):""; }, accessorDownload:(value)=>{  if(!value) return "";  const s = String(value);  if(s.includes("T")) return s.slice(0,10);  try{ const d=new Date(value); if(!isNaN(d)) return d.toISOString().slice(0,10);}catch(e){}  return s.length>=10? s.slice(0,10): s; } },
      { title:"Nombre del comercio", field:"Nombre del comercio", width:220, tooltip:true, formatter:(cell)=>{
          const v = String(cell.getValue() ?? ""); const max = 28; return v.length>max? v.slice(0,max)+"‚Ä¶": v;
      }},
      { title:"N√∫mero de Factura", field:"Numero de Factura", width:150 },
      { title:"Enlace PDF", field:"Enlace PDF", width:110, formatter:(cell)=>{
          const v = cell.getValue() || cell.getRow().getData().Enlace || cell.getRow().getData().PDF || "";
          return v? `<a href="${API.proxied(v)}" target="_blank" title="Abrir PDF">üìÑ</a>` : "";
      }},
      { title:"Km Actual", field:"Km Actual", width:110, hozAlign:"right" },
      { title:"Litros Consumidos", field:"Litros Consumidos", width:160, hozAlign:"right" },
      { title:"Estado", field:"Estado", width:150, formatter:(c)=>{
          const v = c.getValue()||"Registrada";
          const color = estadoColor(v);
          const disabled = (v === "Pagada");
          const cls = disabled? "status-pill disabled" : "status-pill";
          const title = disabled? "No editable cuando est√° Pagada" : "Cambiar estado";
          return `<span class=\"${cls}\" title=\"${title}\"><span class=\"dot\" style=\"background:${color}\"></span>${v}</span>`;
      } }
    ],
    dataLoaded:()=>{ updateKpis(); },
    dataFiltered:()=>{ updateKpis(); },
    rowSelectionChanged:()=>{ updateButtons(); },
  });
  table.on("tableBuilt", ()=>{
    // Fallback: delegado por si el cellClick no se dispara en algunos navegadores
    const root = document.getElementById("tablaRevision");
    root.addEventListener("click", (ev)=>{
    // Cerrar men√∫ al hacer scroll horizontal/vertical en la tabla
    const closeMenuIfOpen = ()=>{ if(statusMenuEl){ statusMenuEl.classList.remove("open"); } };
    const tableHolder = root.querySelector(".tabulator-tableholder");
    const tabScrollArea = tableHolder || root;
    tabScrollArea.addEventListener("scroll", closeMenuIfOpen, {passive:true});
    window.addEventListener("scroll", closeMenuIfOpen, {passive:true});
    window.addEventListener("resize", closeMenuIfOpen);

      const cellEl = ev.target.closest(".tabulator-cell");
      if(!cellEl) return;
      if(cellEl.getAttribute("tabulator-field") !== "Estado") return;
      // Evitar abrir si la fila est√° Pagada
      const rowEl = cellEl.closest(".tabulator-row");
      const rowCompTmp = (function(){
        const rows = table.getRows ? table.getRows() : [];
        for(const r of rows){ if(r.getElement && r.getElement() === rowEl) return r; }
        return null;
      })();
      if(rowCompTmp){ const d = rowCompTmp.getData ? rowCompTmp.getData() : {}; if((d.Estado||"") === "Pagada") return; }
      try{
        // Fallback robusto: localizar el row component comparando elementos
        if(ev && ev.stopPropagation) ev.stopPropagation();
        const rowEl = cellEl.closest(".tabulator-row");
        let rowComp = null;
        const rows = table.getRows ? table.getRows() : [];
        for(const r of rows){
          if(r.getElement && r.getElement() === rowEl){ rowComp = r; break; }
        }
        if(!rowComp) throw new Error("Row no encontrado");
        const cellComp = rowComp.getCell ? rowComp.getCell("Estado") : null;
        if(!cellComp) throw new Error("Cell Estado no encontrado");
        openEstadoMenu(cellComp);
      }catch(e){
}
    });

    tableBuilt = true;
    // Al construirse por primera vez, aseguramos KPIs y botones
    updateKpis();
    updateButtons();
  });
}

let statusMenuEl;
let statusMenuJustOpened = false;
function ensureStatusMenu(){
  if(statusMenuEl) return statusMenuEl;
  statusMenuEl = document.createElement("div");
  statusMenuEl.className = "status-menu";
  document.body.appendChild(statusMenuEl);
  document.addEventListener("click", (ev)=>{
    if(statusMenuJustOpened){ statusMenuJustOpened = false; return; }
    if(!statusMenuEl.contains(ev.target)) statusMenuEl.classList.remove("open");
  });
  document.addEventListener("keydown", (ev)=>{
    if(ev.key === "Escape" && statusMenuEl){ statusMenuEl.classList.remove("open"); }
  });
  return statusMenuEl;
}

function openEstadoMenu(cell){
  const menu = ensureStatusMenu();
  const row = cell.getRow();
  const data = row.getData();
  const current = data.Estado || "Registrada";
  // No permitir edici√≥n si est√° Pagada
  if(current === "Pagada"){ return; }
  const options = getEstadoOptions();
  menu.innerHTML = "";
  options.forEach(opt=>{
    const div = document.createElement("div");
    div.className = "status-item";
    div.innerHTML = `<span class="dot" style="background:${estadoColor(opt)}"></span><span>${opt}</span>`;
    div.addEventListener("click", async ()=>{
      try{
        // Cerrar el men√∫ inmediatamente al seleccionar
        menu.classList.remove("open"); statusMenuAnchor = null;
        overlay.show("Guardando estado...");
        // Optimista
        row.update({Estado: opt});
        updateKpis();
        await API.updateEstado(data, opt);
      }catch(err){
// rollback visual si falla
        row.update({Estado: current});
        updateKpis();
        alert("No se pudo guardar el estado. Intenta de nuevo.");
      }finally{
        overlay.hide();
        menu.classList.remove("open");
      }
    });
    menu.appendChild(div);
  });
  // Posicionar junto a la celda
  const rect = cell.getElement().getBoundingClientRect();
  const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
  const menuWidth = 220;
  let top = rect.bottom + 6;
  let left = rect.left;
  if(left + menuWidth > vw - 8){ left = Math.max(8, vw - menuWidth - 8); }
  menu.style.top = top + "px";
  menu.style.left = left + "px";
  statusMenuJustOpened = true;
  menu.classList.add("open");
}

function updateButtons(){
  // En esta vista descargamos por el conjunto filtrado; el bot√≥n siempre activo si hay filas
  const hasRows = (table?.getDataCount()||0) > 0;
  $("#btnDescargar").disabled = !hasRows;
}

function updateKpis(){
  const rows = table? table.getData("active") : [];
  const total = rows.length;
  const revisadas = rows.filter(r=> (r.Estado||"") === "Revisada").length;
  const pagadas   = rows.filter(r=> (r.Estado||"") === "Pagada").length;
  const anuladas  = rows.filter(r=> (r.Estado||"") === "Anulada").length;
  $("#kpiRegistradas").textContent = total;
  $("#kpiRevisadas").textContent = revisadas;
  $("#kpiPagadas").textContent   = pagadas;
  $("#kpiAnuladas").textContent  = anuladas;
  updateButtons();
}

/** =========================
 *  Filtros
 *  ========================= */

let sectorMS, estadoMS;

function initFilters(){
  // Flatpickr range
  const fp = flatpickr("#fFecha", {
    mode:"range",
    dateFormat:"Y-m-d",
    onChange(selectedDates){
      if(selectedDates.length===2){
        // normalizamos a extremos del d√≠a
        selectedDates[0].setHours(0,0,0,0);
        selectedDates[1].setHours(23,59,59,999);
        $("#fFecha")._range = selectedDates;
      }else{
        $("#fFecha")._range = null;
      }
      applyFilters();
    }
  });
  // MultiSelect con checkboxes
  sectorMS = createMultiSelect("#msSector", "Sector", applyFilters);
  estadoMS = createMultiSelect("#msEstado", "Estado", applyFilters);

  // Asegurar input de Placa
  const filtersRow = document.querySelector(".filters");
  if(!document.getElementById("fPlaca") && filtersRow){
    const placaEl = document.createElement("input");
    placaEl.id = "fPlaca";
    placaEl.className = "input";
    placaEl.placeholder = "Placa‚Ä¶";
    // Insertar antes del N¬∫ Factura si existe
    const numeroEl = document.getElementById("fNumero");
    if(numeroEl && numeroEl.parentElement === filtersRow){
      filtersRow.insertBefore(placaEl, numeroEl);
    }else{
      filtersRow.insertBefore(placaEl, filtersRow.children[2] || null);
    }
  }
  const debouncedPlaca = debounce(applyFilters, 250);
  const placaInput = document.getElementById("fPlaca");
  if(placaInput){ placaInput.addEventListener("input", debouncedPlaca); }
  const debouncedNumero = debounce(applyFilters, 250);
  $("#fNumero").addEventListener("input", debouncedNumero);
  $("#btnLimpiar").addEventListener("click", clearFilters);
}

function clearFilters(){
  if(statusMenuEl){ statusMenuEl.classList.remove('open'); }
  if(sectorMS){ sectorMS.clear(); }
  if(estadoMS){ estadoMS.clear(); }
  const placaInput = document.getElementById("fPlaca"); if(placaInput){ placaInput.value = ""; }
  $("#fNumero").value = "";
  $("#fFecha").value = "";
  $("#fFecha")._range = null;
  applyFilters();
}

function applyFilters(){
  if(!table){ return; }
  const doReplace = ()=>{
    const maybePromise = table.replaceData(State.filtered);
    if(maybePromise && typeof maybePromise.then === "function"){
      maybePromise.then(()=>{ updateKpis(); updateButtons(); }).catch(()=>{ updateKpis(); updateButtons(); });
    }else{
      // fallback si la versi√≥n de Tabulator no retorna promesa
      setTimeout(()=>{ updateKpis(); updateButtons(); }, 0);
    }
  };
  if(!tableBuilt){
    (function(){
      const handler = ()=>{
        try{ table.off("tableBuilt", handler); }catch(e){}
        doReplace();
      };
      table.on("tableBuilt", handler);
    })();
    return;
  }
  doReplace();
}

/** =========================
 *  Exportaciones CSV/XLSX
 *  ========================= */
function exportXLSX(){
  if(!table) return;
  const fname = `Facturas_UTCD_${new Date().toISOString().slice(0,10)}.xlsx`;
  // Usa el downloader nativo de Tabulator (requiere XLSX global)
  table.download("xlsx", fname, { sheetName:"Revisi√≥n", rowRange:"active" });
}

/** =========================
 *  Descarga de PDFs (ZIP)
 *  ========================= */
async function descargarZip(){
  const sel = table? (table.getSelectedData? table.getSelectedData() : []) : [];
  const rows = (sel && sel.length)? sel : (table? table.getData("active") : []);
  if(!rows.length) return;

  overlay.show("Descargando PDFs‚Ä¶");
  overlay.startProgress(rows.length);
  const zip = new JSZip();

  // Descargamos en serie-controlada para no saturar el proxy
  const chunk = 5;
  for(let i=0; i<rows.length; i+=chunk){
    const slice = rows.slice(i,i+chunk);
    await Promise.all(slice.map(async (r, idx)=>{
      const rawUrl = r.Enlace || r["Enlace PDF"] || r.PDF;
      const url = toDirectDriveUrl(rawUrl);
      if(!url) return;
      try{
        const blob = await API.fetchPdfBlob(url);
        const fecha = (r.Fecha || "").toString().slice(0,10).replaceAll("/","-");
        const placa = (r.Placa||"NA").toString().replace(/\s+/g,"_");
        const num   = ((r["Numero de Factura"] ?? r["N√∫mero de Factura"]) ?? "NA").toString().trim().replace(/[^\w\-]/g,"");
        const name  = `${fecha}_${placa}_${num}.pdf`;
        zip.file(name, blob);
      }catch(e){
} finally {
        overlay.step();
      }
    }));
  }

  const content = await zip.generateAsync({type:"blob"});
  saveAs(content, `Facturas_UTCD_${new Date().toISOString().slice(0,10)}.zip`);
  overlay.hide();
}

/** =========================
 *  Helpers
 *  ========================= */
function debounce(fn, wait=200){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), wait); };
}

function resetTableScroll(){
  const root = document.getElementById("tablaRevision");
  if(!root) return;
  const holder = root.querySelector(".tabulator-tableholder");
  if(holder){
    holder.scrollTop = 0;
    holder.scrollLeft = 0;
  }
}

function setLastUpdatedNow(){
  const el = document.getElementById("lastUpdated");
  if(!el) return;
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  const hh = String(now.getHours()).padStart(2,"0");
  const mi = String(now.getMinutes()).padStart(2,"0");
  el.textContent = `Actualizado: ${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}

let isGrouped = false;
function toggleGrouping(){
  if(!table) return;
  isGrouped = !isGrouped;
  if(isGrouped){
    table.setGroupBy(["Identidad"]);
    const btn = document.getElementById("btnAgrupar");
    if(btn) btn.innerHTML = '<i class="lucide-layers-2"></i> Desagrupar';
  }else{
    table.setGroupBy(false);
    const btn = document.getElementById("btnAgrupar");
    if(btn) btn.innerHTML = '<i class="lucide-layers-2"></i> Agrupar por colaborador';
  }
}


/** =========================
 *  Navegaci√≥n (overlay al cambiar de secci√≥n)
 *  ========================= */
function showOnly(sectionId){
  document.querySelectorAll('main > section').forEach(s => s.style.display='none');
  const tgt = document.getElementById(sectionId);
  if(tgt) tgt.style.display = 'block';
  document.querySelectorAll('.sidebar .nav-btn').forEach(a=>a.classList.remove('active'));
  const map = {secRevision:'#revision', secPago:'#pago', secAnticipos:'#anticipos', secPlacas:'#placas'};
  const sel = map[sectionId]; if(sel){
    const a = document.querySelector(`.sidebar .nav-btn[href="${sel}"]`);
    if(a) a.classList.add('active');
  }
}
async function navigateTo(sectionId, loader){
  overlay.show("Cambiando de secci√≥n‚Ä¶");
  try{
    showOnly(sectionId);
    if(typeof loader === 'function'){ await loader(); }
  }finally{
    overlay.hide();
  }
}
document.querySelectorAll('.sidebar .nav-btn').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    const href = a.getAttribute('href')||'';
    if(href==='#revision') return navigateTo('secRevision');
    if(href==='#pago')     return navigateTo('secPago');
    if(href==='#anticipos')return navigateTo('secAnticipos');
    if(href==='#placas')   return navigateTo('secPlacas', async()=>{ await cargarPlacas(); });
  });
});
/** =========================
 *  Placas (single endpoint)
 *  ========================= */
const Placas = { table:null, data:[], filtered:[], _loaded:false };
function placasEndpointsReady(){ return !!Config.api.placas; }

function fillSectorOptions(){
  const sel = document.getElementById("npSector");
  if(!sel) return;
  // construir lista √∫nica de sectores desde los datos cargados
  const sectors = Array.from(new Set((Placas.data||[]).map(r => String(r.Sector||"").trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const current = sel.value;
  sel.innerHTML = '<option value="">Sector‚Ä¶</option>' + sectors.map(s => `<option value="${s}">${s}</option>`).join('');
  // reponer selecci√≥n si sigue existiendo
  if(sectors.includes(current)) sel.value = current;
}

async function loadProcesosOptions(){
  const sel = document.getElementById("npProceso");
  if(!sel) return;
  try{
    const res = await fetch(Config.api.procesos, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    let procesos = [];
    if(Array.isArray(data)){
      procesos = data.map(item => {
        if(typeof item === "string") return item;
        if(item == null) return "";
        return item.Proceso || item.proceso || item.Nombre || item.nombre || item.name || "";
      }).filter(Boolean);
    }else if(data && Array.isArray(data.procesos)){
      procesos = data.procesos.filter(x=>typeof x==="string");
    }
    procesos = Array.from(new Set(procesos)).sort((a,b)=>a.localeCompare(b));
    const current = sel.value;
    sel.innerHTML = '<option value="">Proceso‚Ä¶</option>' + procesos.map(p => `<option value="${p}">${p}</option>`).join('');
    if(procesos.includes(current)) sel.value = current;
  }catch(e){
    // si falla, dejamos el select con opci√≥n manual libre
    sel.innerHTML = '<option value="">Proceso‚Ä¶</option>';
    // Dejar posibilidad de teclear manualmente: convertimos a input fallback si deseas (por ahora no)
    console.warn("No se pudo cargar procesos:", e);
  }
}

async function cargarPlacas(){
  overlay.show("Cargando placas‚Ä¶");
  try{
    let rows = [];
    if(placasEndpointsReady()){
      const res = await fetch(Config.api.placas, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      rows = await res.json();
    }
    Placas.data = rows.map(r=>({
      IDvehiculo: r.IDvehiculo || r.Id || "",
      Estado: r.Estado || r.ESTADO || "Activa",
      Placa: r.Placa || r.PLACA || "",
      Sector: r.Sector || r.SECTOR || "",
      Nombre: r.Nombre || r.CONDUCTOR || "",
      Proceso: r.Proceso || r.PROCESO || "",
      JefeInmediato: r.JefeInmediato || r["Jefe inmediato"] || r["JEFE INMEDIATO"] || "",
      Designacion: r.Designacion || r["DESIGNACI√ìN"] || r.DESIGNACION || "",
      FechaAlta: r.FechaAlta || r.Fecha || r.FECHA || ""
    }));
    aplicarFiltrosPlacas();
    if(Placas.table){ Placas.table.replaceData(Placas.filtered); }
    else{
      // intenta precargar procesos en paralelo (no bloqueante)
      loadProcesosOptions().catch(()=>{});
      Placas.table = new Tabulator("#tablaPlacas", {
        data: Placas.filtered,
        selectable: true,
        height: 520,
        layout: "fitColumns",
        columns: [
          { title:"ID", field:"IDvehiculo", width:120 },
          { title:"Placa", field:"Placa", width:140 },
          { title:"Estado", field:"Estado", width:120, formatter:(c)=>{
              const v = c.getValue() || "Activa";
              return `<span class="status-pill ${v==="Activa"?"":"disabled"}"><span class="dot" style="background:${v==="Activa"?"#10b981":"#f59e0b"}"></span>${v}</span>`;
            }},
          { title:"Nombre", field:"Nombre" },
          { title:"Sector", field:"Sector", width:140 , editor:"list" , editorParams:function(){ return {values:getUniqueSectors()}; } , cellEdited:onSectorEdited },
          { title:"Proceso", field:"Proceso", width:180 },
          { title:"Jefe inmediato", field:"JefeInmediato", width:200 },
          { title:"Designaci√≥n", field:"Designacion", width:200 },
          { title:"Fecha Alta", field:"FechaAlta", width:120, formatter:(c)=>{ const v=c.getValue(); return v? String(v).slice(0,10) : ""; } },
        ]
      });
      // Eventos UI
      document.getElementById("btnPlacasActualizar").addEventListener("click", cargarPlacas);
      document.getElementById("btnPlacasActivar").addEventListener("click", ()=> cambiarEstadoPlacas("Activa"));
      document.getElementById("btnPlacasInactivar").addEventListener("click", ()=> cambiarEstadoPlacas("Inactiva"));
      document.getElementById("btnPlacasNueva").addEventListener("click", async ()=> { toggleFormPlaca(true); fillSectorOptions(); await loadProcesosOptions(); });
      document.getElementById("btnPlacaCancelar").addEventListener("click", ()=> toggleFormPlaca(false));
      
      // === Formato y validaci√≥n de Placa/VIN ===
      const inpPlaca = document.getElementById("npPlaca");
if (inpPlaca) { inpPlaca.setAttribute("maxlength","17"); }
      const dupMsg = document.getElementById("npPlacaDup");
      const btnGuardar = document.getElementById("btnPlacaGuardar");

      function normalizeAlnum(str){ return String(str||"").toUpperCase().replace(/[^A-Z0-9]/g,""); }
      function formatPlacaOrVin(raw){
        let v = normalizeAlnum(raw);
        // VIN si supera 8 caracteres (sin subrayado)
        if(v.length > 8){
          // VIN: m√°ximo 17, s√≥lo alfanum√©rico
          return v.slice(0,17);
        } else {
          // Placa: insertar "_" despu√©s de 3; mostrar hasta 8 alfanum√©ricos (3 + "_" + hasta 4)
          if(v.length <= 3) return v;
          const left = v.slice(0,3);
          const right = v.slice(3, Math.min(v.length, 8));
          return left + "_" + right;
        }
      }
      function currentInputIsVIN(val){
        const only = normalizeAlnum(val);
        return only.length > 8; // criterio pedido
      }
      function checkDuplicate(val){
        const norm = normalizeAlnum(val);
        if(!norm) return false;
        const exists = (Placas.data||[]).some(r=> normalizeAlnum(r.Placa||r.PLACA||"") === norm);
        dupMsg.style.display = exists ? "inline" : "none";
        btnGuardar.disabled = exists;
        return exists;
      }

      inpPlaca.addEventListener("input", () => {
        const pos = inpPlaca.selectionStart;
        const before = inpPlaca.value;
        const formatted = formatPlacaOrVin(before);
        inpPlaca.value = formatted;
        // Ajuste simple del cursor (no perfecto pero aceptable para este caso)
        // Mover al final si hubo re-formateo dr√°stico
        if(inpPlaca.value !== before){
          inpPlaca.selectionStart = inpPlaca.selectionEnd = inpPlaca.value.length;
        }else{
          inpPlaca.selectionStart = inpPlaca.selectionEnd = pos;
        }
        checkDuplicate(inpPlaca.value);
      });
      inpPlaca.addEventListener("blur", ()=> { checkDuplicate(inpPlaca.value); });

      document.getElementById("btnPlacaGuardar").addEventListener("click", guardarNuevaPlaca);
      document.getElementById("btnPlacasLimpiar").addEventListener("click", limpiarFiltrosPlacas);
      document.getElementById("fPlacasEstado").addEventListener("change", ()=>{ aplicarFiltrosPlacas(); Placas.table.replaceData(Placas.filtered); actualizarKpisPlacas();
    try{ if(Placas.table){ const c=Placas.table.getColumn('Sector'); if(c){ c.updateDefinition({ editorParams:function(){ return {values:getUniqueSectors()}; } }); } } }catch(_){ } });
      document.getElementById("fPlacasPlaca").addEventListener("input", ()=>{ aplicarFiltrosPlacas(); Placas.table.replaceData(Placas.filtered); actualizarKpisPlacas();
    try{ if(Placas.table){ const c=Placas.table.getColumn('Sector'); if(c){ c.updateDefinition({ editorParams:function(){ return {values:getUniqueSectors()}; } }); } } }catch(_){ } });
      document.getElementById("fPlacasNombre").addEventListener("input", ()=>{ aplicarFiltrosPlacas(); Placas.table.replaceData(Placas.filtered); actualizarKpisPlacas();
    try{ if(Placas.table){ const c=Placas.table.getColumn('Sector'); if(c){ c.updateDefinition({ editorParams:function(){ return {values:getUniqueSectors()}; } }); } } }catch(_){ } });
    }
    actualizarKpisPlacas();
    try{ if(Placas.table){ const c=Placas.table.getColumn('Sector'); if(c){ c.updateDefinition({ editorParams:function(){ return {values:getUniqueSectors()}; } }); } } }catch(_){ }
    fillSectorOptions();
    document.getElementById("placasNotice").style.display = placasEndpointsReady()? "none":"inline-block";
  }catch(e){
    alert("No fue posible cargar las placas.");
    const n = document.getElementById("placasNotice"); if(n){ n.style.display="inline-block"; n.textContent="No fue posible cargar las placas. Intenta nuevamente."; }
  }finally{
    overlay.hide();
  }
}
function aplicarFiltrosPlacas(){
  const est = (document.getElementById("fPlacasEstado")?.value || "").trim();
  const placaQ = (document.getElementById("fPlacasPlaca")?.value || "").trim().toLowerCase();
  const normalize = (s)=> String(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
  const nombreQ = normalize(document.getElementById("fPlacasNombre")?.value || "");
  Placas.filtered = Placas.data.filter(r=>{
    if(est && r.Estado !== est) return false;
    if(placaQ && !String(r.Placa||"").toLowerCase().includes(placaQ)) return false;
    if(nombreQ && !normalize(r.Nombre).includes(nombreQ)) return false;
    return true;
  });
}
function actualizarKpisPlacas(){
  const total = Placas.filtered.length;
  const act = Placas.filtered.filter(r=> r.Estado==="Activa").length;
  const ina = Placas.filtered.filter(r=> r.Estado==="Inactiva").length;
  document.getElementById("kpiPlacasTotal").textContent = total;
  document.getElementById("kpiPlacasActivas").textContent = act;
  document.getElementById("kpiPlacasInactivas").textContent = ina;
}
function limpiarFiltrosPlacas(){
  document.getElementById("fPlacasEstado").value = "";
  document.getElementById("fPlacasPlaca").value = "";
  document.getElementById("fPlacasNombre").value = "";
  aplicarFiltrosPlacas();
  if(Placas.table) Placas.table.replaceData(Placas.filtered);
  actualizarKpisPlacas();
    try{ if(Placas.table){ const c=Placas.table.getColumn('Sector'); if(c){ c.updateDefinition({ editorParams:function(){ return {values:getUniqueSectors()}; } }); } } }catch(_){ }
}
function toggleFormPlaca(show){ document.getElementById("placasFormWrap").style.display = show? "block":"none"; }
async function guardarNuevaPlaca(){
let placa = document.getElementById("npPlaca").value.trim();
  // Normalizar antes de enviar
  const normOnly = placa.toUpperCase().replace(/[^A-Z0-9_]/g,"");
  // Si es VIN (m√°s de 8 alfanum√©ricos sin guion), quitar guion si lo tuviera
  const only = normOnly.replace(/_/g,"");
  if(only.length > 8){ placa = only.slice(0,17); 

} else {
    const al = only.slice(0,7); // 3 + 4
    const left = al.slice(0,3), right = al.slice(3,7);
    placa = right ? (left + "_" + right) : left;
  }
  // Duplicados en cliente
  const dupExists = (Placas.data||[]).some(r=> String((r.Placa||r.PLACA||"")).replace(/_/g,"").toUpperCase() === only.toUpperCase());
  if(dupExists){ alert("La placa/VIN ya existe en el registro."); return; }
  const nombre = document.getElementById("npNombre").value.trim();
  const sector = document.getElementById("npSector").value.trim();
  const proceso = document.getElementById("npProceso").value.trim();
  const designacion = document.getElementById("npDesignacion").value.trim();
  const estado = document.getElementById("npEstado").value;
  if(!placa){ alert("La placa es obligatoria."); return; }
  if(!placasEndpointsReady()){ alert("Configura el endpoint de Placas."); return; }
  try{
    overlay.show("Guardando placa‚Ä¶");
    const res = await fetch(Config.api.placas, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"crear", placa, nombre, sector, proceso, designacion, estado })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    await cargarPlacas();
    toggleFormPlaca(false);
    document.getElementById("npPlaca").value="";
    document.getElementById("npNombre").value="";
    document.getElementById("npSector").value="";
    document.getElementById("npProceso").value="";
    document.getElementById("npDesignacion").value="";
    document.getElementById("npEstado").value="Activa";
  }catch(e){
    alert("No fue posible guardar la placa.");
  }finally{ overlay.hide(); }
}
async function cambiarEstadoPlacas(nuevoEstado){
  if(!placasEndpointsReady()){ alert("Configura el endpoint de Placas."); return; }
  const rows = Placas.table ? (Placas.table.getSelectedData ? Placas.table.getSelectedData() : []) : [];
  if(!rows.length){ alert("Selecciona al menos una placa."); return; }
  try{
    overlay.show("Actualizando estado‚Ä¶");
    const placas = rows.map(r=> r.Placa).filter(Boolean);
    const res = await fetch(Config.api.placas, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ action:"cambiarEstado", placas, estado: nuevoEstado })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    await cargarPlacas();
  }catch(e){
    alert("No fue posible actualizar el estado.");
  }finally{ overlay.hide(); }
}

// Selecci√≥n masiva por grupo (checkbox en header)
document.addEventListener("change", (ev)=>{
  const chk = ev.target.closest(".group-select");
  if(!chk || !table) return;
  const key = chk.getAttribute("data-group-key") || "";
  // Encontrar el group component cuyo key (value) coincide
  const groups = table.getGroups ? table.getGroups() : [];
  let target = null;
  for(const g of groups){
    try{
      if(String(g.getKey ? g.getKey() : g.key) === String(key)){ target = g; break; }
    }catch(_){}
  }
  if(!target) return;

  const rows = target.getRows ? target.getRows() : [];
  if(chk.checked){
    rows.forEach(r => { try{ r.select && r.select(); }catch(_){ } });
  }else{
    rows.forEach(r => { try{ r.deselect && r.deselect(); }catch(_){ } });
  }
  // refrescar botones por si depende de selecci√≥n
  try{ updateButtons(); }catch(_){}
});

/** =========================
 *  Bootstrap
 *  ========================= */
async function hardRefresh(){
  // Limpia filtros, recarga y resetea scroll; luego muestra hora de actualizaci√≥n
  clearFilters();
  await loadData();
  resetTableScroll();
  setLastUpdatedNow();
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  }


function getUniqueSectors(){
  const all = (Placas.data || [])
    .map(r => String(r.Sector||"").trim())
    .filter(Boolean);
  return Array.from(new Set(all)).sort((a,b)=>a.localeCompare(b));
}
function getJefeBySector(sector){
  const s = String(sector||"").trim().toUpperCase();
  for(const r of (Placas.data||[])){
    if(String(r.Sector||"").trim().toUpperCase() === s){
      return r.JefeInmediato || r["Jefe inmediato"] || "";
    }
  }
  return "";
}


async function onSectorEdited(cell){
  try{
    const newSector = cell.getValue();
    const rowData   = cell.getRow().getData();
    const placaKey  = rowData.Placa || rowData.PLACA;
    if(!placaKey) throw new Error("Placa no disponible");

    const res = await fetch(Config.api.placas, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ action:"cambiarSector", placa: placaKey, sector: newSector })
    });
    const txt = await res.text();
    if(!res.ok) throw new Error("HTTP "+res.status+" - "+txt.slice(0,120));
    let data; try{ data = JSON.parse(txt); } catch { data = {}; }

    const jefe = (data && (data.JefeInmediato || data.jefe)) || getJefeBySector(newSector);
    const patch = { Sector: newSector };
    if(jefe) patch.JefeInmediato = jefe;
    cell.getRow().update(patch);

    const idx = (Placas.data||[]).findIndex(r => (r.Placa||r.PLACA) === placaKey);
    if(idx>=0){ Placas.data[idx].Sector = newSector; if(jefe) Placas.data[idx].JefeInmediato = jefe; }

    toast("Sector actualizado");
  }catch(err){
    console.error("No se pudo actualizar sector:", err);
    alert("No se pudo actualizar el sector: "+err.message);
    cell.restoreOldValue();
  }
}

async function bootstrap(){
  initFilters();
  $("#btnActualizar").addEventListener("click", hardRefresh);
  $("#btnAgrupar").addEventListener("click", toggleGrouping);
  $("#btnDescargar").addEventListener("click", descargarZip);  $("#btnExportXLSX").addEventListener("click", exportXLSX);
  overlay.show("Cargando facturas‚Ä¶");
  await loadData();
  resetTableScroll();
  setLastUpdatedNow();
  overlay.hide();
}

async function loadData(){
  overlay.show("Cargando facturas‚Ä¶");
  try{
    const data = await API.getFacturas();
    State.raw = data;
    // poblar selects din√°micamente
    const sectores = Array.from(new Set(data.map(r=>r.Sector).filter(Boolean))).sort();
    const estados  = Array.from(new Set(data.map(r=>r.Estado||"Registrada"))).sort();
    if(sectorMS){ sectorMS.setItems(sectores); }
    if(estadoMS){ estadoMS.setItems(estados); }
    buildTable();
    if(tableBuilt){ applyFilters(); } else {
      (function(){
        const handler = ()=>{
          try{ table.off("tableBuilt", handler); }catch(e){}
          applyFilters();
        };
        table.on("tableBuilt", handler);
      })();
    }
}catch(e){
alert("No fue posible cargar las facturas.");
  }finally{
    overlay.hide();
  }
}

window.addEventListener("DOMContentLoaded", bootstrap);
</script>
</body>
</html>
