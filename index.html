<!DOCTYPE html>

<html lang="es">
<head>

<style>
  #pasteArea {
    position: relative;
    border: 1px dashed #ccc;
    padding: 1rem;
    min-height: 150px;
    text-align: center;
  }
  #pasteArea .placeholder-top,
  #pasteArea .placeholder-bottom {
    pointer-events: none;
  }
  #pasteArea .placeholder-bottom {
    position: absolute;
    width: 100%;
    left: 0;
    color: #666;
    pointer-events: none;
  }
  #pasteArea .placeholder-top {
    top: 1rem;
  }
  #pasteArea .placeholder-bottom {
    bottom: 1rem;
  }
  #pasteArea img {
    max-width: 100%;
    max-height: 100%;
    margin: auto;
    display: block;
  }
  
</style>

<style>
  .btn-pagar {
    padding: 4px 8px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-pagar:hover {
    background-color: #0056b3;
  }
  /* Modal overlay */
  #modalPago {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  #modalPago .dialog {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    width: 100%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  } 
</style>

<script>
  const urlGuardarAnticipo = "/api/GuardarAnti";
  const urlLeerAnticipos = "/api/Anticipos";
  const urlGuardarFactura = "/api/guardar";
  const Envio_Correos = 'https://script.google.com/macros/s/AKfycbyxu18kQ-oUAXu188swhZUlOc7tgcmdJHsDoxnVTfJ3if-4rxaW1HUI2o4YYIh_Rql6/exec';
</script>
<!-- ==== unload listener interception Patch v26 ==== -->
<script>
// Intercept addEventListener to redirect 'unload' to 'pagehide' to avoid deprecation
(function(){
  const origAdd = EventTarget.prototype.addEventListener;
  EventTarget.prototype.addEventListener = function(type, listener, options){
    if(type === 'unload'){
      // Redirect to pagehide; duplicate prevention
      return origAdd.call(this, 'pagehide', listener, options);
    }
    return origAdd.call(this, type, listener, options);
  };

  // Handle direct property assignment window.onpagehide = fn;
  Object.defineProperty(window, 'onpagehide', {
    set: function(fn){
      if(typeof fn === 'function'){
        window.addEventListener('pagehide', fn);
      }
    },
    get: function(){ return null; },
    configurable: true
  });
})();
</script>
<!-- ==== end unload interception Patch v26 ==== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  /* Global button styles for mobile friendliness */
  button {
    padding: 1rem 1.5rem !important;
    font-size: 1.1rem !important;
    border-radius: 0.5rem !important;
    margin-bottom: 1rem !important;
  }

  /* Navigation buttons spacing */
  .nav-buttons button + button {
    margin-left: 0.5rem !important;
  }

  /* Signature buttons layout */
  .signature-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0 !important;
  }
  .signature-buttons button {
    flex: 1;
    margin: 0 !important;
  }

  /* Download confirmation modal readability */
  #downloadModal .modal-content {
    padding: 2rem !important;
  }
  #downloadModal .modal-content p {
    font-size: 1.1rem !important;
    line-height: 1.5 !important;
  }
  #downloadModal .modal-content button {
    padding: 1rem 1.5rem !important;
    font-size: 1.1rem !important;
    flex: 1 !important;
    margin: 0.5rem !important;
  }
</style>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Control de Combustible</title>
<style>
  /* Responsive layout */
  .form-steps {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  @media (max-width: 640px) {
    .form-steps {
      grid-template-columns: 1fr;
    }
  }

  /* Tap targets and spacing */
  input, select, textarea, button {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem !important;
    font-size: 1.1rem;
    border-radius: 0.5rem;
    box-sizing: border-box;
  }

  /* Full-screen camera preview */
  .camera-preview {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none; /* toggled on capture */
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .camera-preview.active {
    display: flex;
  }
  .camera-preview .overlay-controls {
    position: absolute;
    bottom: 1rem;
    width: 100%;
    display: flex;
    justify-content: space-around;
  }

  button { margin: 0 0 1rem !important; }
</style>
<style>
.photo-buttons {
  display: flex;
  gap: 1rem;
  padding: 0.75rem;
}
.photo-buttons button {
  flex: 1;
  margin: 0 !important;
}
</style>
<!-- Roboto font for consistent typography -->
<link href="https://fonts.googleapis.com/css2?family=Roboto&amp;display=swap" rel="stylesheet"/>
<style>
    /* Animaciones para transiciones */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Global page styles */
    /* Global page styles */
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .formulario {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover { background-color: #0056b3; }
    #mensaje_cargando {
      text-align: center;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 15px;
    }

    /* Styles for preview pages to mimic Letter dimensions */
    @page {
      size: letter;
      margin: 1.27cm;
    }
    .page {
      background: white;
      width: 216mm;           /* Carta: 8.5in = 216mm */
      height: 279mm;          /* Carta: 11in = 279mm */
      margin: 20px auto;      /* Separación entre páginas */
      padding: 1.27cm;        /* Márgenes internos de 1.27cm */
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;          /* Contenedor flex para extender contenido */
      flex-direction: column; /* Organizar header y contenido en columna */
      overflow: hidden;       /* Ocultar desbordes */
      page-break-after: always;
    }
    @media print {
      .page { page-break-after: always; margin: 0; box-shadow: none; }
      body { margin: 0; }
    }
    .format-header {
      text-align: center;
      font-weight: bold;
      border: 1px solid #000;
      padding: 5px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .preview-box {
      display: flex;
      gap: 10px; /* Gap between columns */
      flex: 1; /* Fill vertical space under header */
    }
    .invoice-box {
      flex: 0 0 55%; /* Width ratio for invoice box */
      height: 100%;  /* Fill parent height */
    }
    .summary-box {
      flex: 0 0 45%; /* Width ratio for summary box */
      height: 100%;  /* Fill parent height */
    }
    .invoice-box .placeholder {
      width: 100%; height: 100%;
      border: 2px dashed #666;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    .summary-box table {
      width: 100%; height: 100%;
      border-collapse: collapse;
    }
    .summary-box td:first-child { width: 30%; }
    .summary-box td:nth-child(2) { width: 70%; }
    .summary-box td {
      font-size: 14px;
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    /* Adjust page 2 to fill remaining height */
    #photos_table_container {
      flex: 1;               /* Fill vertical space under header */
      display: flex;
      flex-direction: column;
    }
    .photos-table {
      flex: 1;               /* Fill all available height */
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .photos-table td {
      border: 1px solid #ccc;
      padding: 4px;
      vertical-align: top;
      overflow: hidden;
      width: 45%;
      height: 300px; /* Ajustado a 300px según pedido */
    }
    .photos-table td[rowspan="2"] {
      width: 55%;
      height: 530px; /* Ajustado a 530px según pedido */
    }
    .photos-table img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .photo-title { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
    .photo-footer { font-size: 14px; font-weight: bold; text-align: left; padding: 6px; }
    /* Pie de página: altura fija distinta de las fotos */
    .photos-table tr:last-child td {
      height: 20px; /* Ajustado a 20px para el pie de página */ /* Ajusta este valor para cambiar el largo del pie de página */
    }
      /* Ensure preview content matches Letter width */
    html, body { box-sizing: border-box; }
    #preview_contenido {
      width: 216mm;       /* Match page width for PDF capture */
      margin: 0 auto;
      overflow: visible;
    }
  </style>
<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<style>
#toast-alert {
  visibility: hidden;
  min-width: 280px;
  background-color: #c62828;
  color: white;
  text-align: center;
  border-radius: 5px;
  padding: 14px 28px;
  position: fixed;
  z-index: 9999;
  left: 50%;
  bottom: 30px;
  font-size: 16px;
  transform: translateX(-50%);
}
#toast-alert.show {
  visibility: visible;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}
@keyframes fadein {
  from { bottom: 10px; opacity: 0; }
  to   { bottom: 30px; opacity: 1; }
}
@keyframes fadeout {
  from { bottom: 30px; opacity: 1; }
  to   { bottom: 10px; opacity: 0; }
}
</style>
<div id="toast-alert">⚠️ Hay campos obligatorios sin completar.</div>
<!-- ==== Registrar Anticipo ==== -->
<section id="registrarAnticipo" style="display:none;flex-direction:column;gap:1rem;padding:1rem;align-items:center;">
<button id="btnBackAnt" style="align-self:flex-start;">← Volver</button>
<h2>Registrar Anticipo</h2>
  <!-- Cortar desde aquí ↓↓ -->
  <div id="filtrosAnt" style="display:flex;gap:1rem;align-items:center;margin:1rem 0;">
    <label>
      Filtrar Sector:<br/>
      <select id="filterSectorAnt">
        <option value="">Todos</option>
        <!-- … -->
      </select>
    </label>
    <label>
      Filtrar Periodo:<br/>
      <select id="filterPeriodoAnt">
        <option value="">Todos</option>
        <!-- … -->
      </select>
    </label>
  </div>

<div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;">
  <button id="btnExportExcel"
    style="display:inline-flex;align-items:center;justify-content:center;
           height:1.8rem !important;
           line-height:1.8rem !important;
           padding:0 0.7rem !important;
           font-size:0.8rem !important;
           background:#217346;
           color:#fff;
           border:0;
           border-radius:.25rem;
           cursor:pointer;
           white-space:nowrap;">
    Exportar Excel
  </button>

  <button id="btnShowAnt"
    style="display:inline-flex;align-items:center;justify-content:center;
           height:1.8rem !important;
           line-height:1.8rem !important;
           padding:0 0.7rem !important;
           font-size:0.8rem !important;
           background:#0b6fff;
           color:#fff;
           border:0;
           border-radius:.25rem;
           cursor:pointer;
           white-space:nowrap;">
    Registrar nuevo Anticipo
  </button>
</div>

 <!-- Ahora sí comienza el mini-formulario, sin el Exportar Excel dentro -->
 <div id="anticipoMiniForm" style="display:none;flex-wrap:wrap;gap:.8rem;align-items:flex-end;display:flex;">

<div><label>Sector<br/><select id="antSector" required="">
<option value="">Seleccione</option>
<option value="SAN PEDRO SULA">SAN PEDRO SULA</option>
<option value="EL PROGRESO">EL PROGRESO</option>
<option value="STA. CRUZ">STA. CRUZ</option>
<option value="CHOLUTECA">CHOLUTECA</option>
<option value="COMAYAGUA">COMAYAGUA</option>
<option value="DANLI">DANLI</option>
<option value="GUANAJA">GUANAJA</option>
<option value="JUTICALPA">JUTICALPA</option>
<option value="LA CEIBA">LA CEIBA</option>
<option value="SANTA ROSA">SANTA ROSA</option>
<option value="TEGUCIGALPA">TEGUCIGALPA</option>
<option value="TOCOA">TOCOA</option>
<option value="BRUS LAGUNA">BRUS LAGUNA</option>
</select></label></div>
<div><label>Fondo<br/><select id="antFondo"><option value="">Seleccione</option><option value="Combustible">Combustible</option><option value="Poda">Poda</option></select></label></div>
<div><label>Depósito (L)<br/><input id="antDeposito" min="0" step="0.01" style="width:8rem;" type="number"/></label></div>
<div><label>Periodo<br/><select id="antPeriodo" style="width:8rem;"><option value="">Seleccione</option></select></label></div>
<button id="btnAddAnt"
        style="height:2.3rem; margin:1rem auto;
               display:flex; justify-content:center; align-items:center;">
	＋ Registrar
</div>
<div style="font-weight:bold;display:flex;gap:2rem;margin-top:.5rem;">
<span>Total anticipos: <span id="antTotal">L 0.00</span></span>
<span>Saldo disponible: <span id="antSaldo">L 0.00</span></span>
</div>
<div id="tablaAnticiposWrapper" style="position:relative;border:1px solid #ccc;border-radius:6px;overflow:hidden;width:100%;max-width:1200px;">
  <div id="tablaAnticipos"></div>
  <div id="overlayAnt" style="position:absolute;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;justify-content:center;align-items:center;background:rgba(255,255,255,0.8);z-index:1000;">
    <div style="width:3rem;height:3rem;border:.4rem solid #eee;border-top-color:#007bff;border-radius:50%;animation:spin .8s linear infinite;"></div>
    <span style="color:#333;font-weight:bold;margin-top:.5rem;">Cargando información</span>
  </div>
</div>
<style>@keyframes spin { to { transform: rotate(360deg); } }</style>
</section>
<style>
@keyframes fadeOutUp {
  from { opacity: 1; transform: translateY(0); }
  to   { opacity: 0; transform: translateY(-20px); }
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fade-out-up {
  animation: fadeOutUp 0.3s forwards;
}
.fade-in-down {
  animation: fadeInDown 0.3s ease-out forwards;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>
<!-- Custom Header Styles -->
<style>
    .custom-header {
      display: table;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    .custom-header > div {
      display: table-cell;
      border: 1px solid #000;
      vertical-align: middle;
      padding: 8px;
    }
    .custom-header .header-left img {
      max-height: 60px;
      display: block;
    }
    .custom-header .header-center h1 {
      font-size: 18px;
      margin: 0;
      text-align: center;
    }
      width: 100%;
      border-collapse: collapse;
    }
      border: 1px solid #000;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
<style>
  .header-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  .header-table td {
    border: 1px solid #000;
    padding: 4px;
    vertical-align: middle;
  }
  .header-table img {
    max-height: 60px;
    display: block;
  }
  .header-table .title-cell {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
  }
</style>
<!-- flatpickr CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Tabulator CSS & JS -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<style>
@keyframes spinner {
  to { transform: rotate(360deg); }
}
#overlayCambios {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
#overlayCambios .spinner {
  width: 4rem;
  height: 4rem;
  border: 0.5rem solid #ddd;
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spinner 0.75s linear infinite;
  margin-bottom: 1rem;
}
#overlayCambios .text {
  font-size: 1.25rem;
  color: white;
  font-weight: bold;
}
</style>

<style>
#countersContainer {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  justify-content: center;
}
.counter-box {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
  padding: 0.5rem 1rem;
  text-align: center;
  min-width: 8rem;
}
.counter-box .label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.25rem;
}
.counter-box .value {
  font-size: 1.25rem;
}
</style>
<style>
#countersRow, #filtersRow {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-bottom: 1rem;
}
#filtersRow label {
  white-space: nowrap;
  margin-right: 0.5rem;
}
#filtersRow select,
#filtersRow input[type="text"] {
  width: 200px;
  border-radius: 0.375rem;
  border: 1px solid #cbd5e0;
  padding: 0.5rem;
  background: #f7fafc;
}
.counter-box {
  background: #edf2f7;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  text-align: center;
}
.counter-box .label {
  display: block;
  font-size: 0.875rem;
  color: #4a5568;
}
.counter-box .value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #2d3748;
}
</style>
<style>
  /* Botón volver más compacto verticalmente */
  #seccionRevisionFacturas > button {
    padding: 0.25rem 1rem !important;
  }
  /* Contadores: menos alto */
  .counter-box {
    padding: 0.25rem 1rem !important;
  }
  /* Tabla: celdas más compactas */
  #tablaFacturas th,
  #tablaFacturas td {
    padding: 0.25rem 0.5rem !important;
  }
</style>
<style>
#tablaPagoWrapper { position: relative; }
#overlayPago { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;
  color: white; font-size: 1.2rem; font-weight: bold; }
</style>
<style id="excel-button-style">
#exportExcelBtn {
    margin-left: 0.25rem !important;
}
</style>

<style>
#overlayRevision { display:none; position:absolute; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:center; justify-content:center;
  color:white; font-size:1.2rem; font-weight:bold;}
</style>

<style>
  /* Compactar botón Pagar dentro de la tabla */
  #facturas-table .btn-pagar,
  .tabulator-cell .btn-pagar {
    padding: 2px 6px !important;
    font-size: 0.75rem !important;
    line-height: 1 !important;
    height: 22px !important; /* o auto */
    border-radius: 4px; /* opcional */
  }
</style>

</head>
<body>
<div id="overlayCambios">
<div class="spinner"></div>
<div class="text">Registrando Cambios...</div>
</div>
<div id="menuPrincipal" style="display: flex; flex-direction: column; align-items: center; margin-top: 50px; gap:20px;">
<h2>Seleccione una opción</h2>
<button onclick="cargarRevisionFacturas()" style="width: 250px;  padding: 10px;">🔍 Revisión de Facturas</button>
<button onclick="cargarPagoFacturas()" style="width: 250px;  padding: 10px;">💳 Pago de Facturas</button>
<button id="btnIrRegistrarAnticipo" style="width:250px;padding:10px;">💵 Registrar Anticipo</button></div><div id="seccionPagoFacturas" style="display: none;">
<button onclick="mostrarSeccion('menuPrincipal')" style="height:24px; line-height:1; padding: 0.25rem 0.5rem; display: flex; align-items: center; justify-content: center;"><span style="margin-right: 0.5rem;">←</span>Regresar al Menú Principal</button><h2>Pago de Facturas</h2>
<div id="countersContainer">
<div class="counter-box"><span class="label">Facturas Pendientes</span><span class="value" id="contadorPendientes">0</span></div>
<div class="counter-box"><span class="label">Facturas Pagadas</span><span class="value" id="contadorPagadas">0</span></div>
<div class="counter-box"><span class="label">Total Pendiente de Pagar</span><span class="value" id="totalRevisada">L 0.00</span></div>
<div class="counter-box"><span class="label">Total Pagado</span><span class="value" id="totalPagada">L 0.00</span></div>
</div>
<div id="filtersRow" style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
<label>Filtrar por sector:
    <select id="filtroSectorPago"><option value="Todos">Todos</option></select>
</label>
<label>Filtrar por estado:
    <select id="filtroEstadoPago">
<option value="Todos">Todos</option>
<option value="Revisada">Revisada</option>
<option value="Pagada">Pagada</option>
</select>
</label>
<label>Filtrar Nº de Factura:
    <input id="filtroNumeroPago" placeholder="Buscar factura…" style="padding:0.5rem;" type="text">
</input></label>
<label>Rango de Fechas:
    <input id="filtroFechaPago" placeholder="Selecciona rango" style="padding:0.5rem;" type="text"/>
</label>
</div>
<style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    </style>
<div id="tablaPagoWrapper" style="max-height: 500px; overflow: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
<button id="btn-pagar-facturas" style="display:none; margin-bottom:10px; font-size:0.8rem !important; padding:2px 6px !important; height:24px !important; line-height:1 !important;">Pagar Facturas</button>
<button class="boton" id="btnAgruparColaborador" style="display:inline-block; margin-left:10px; margin-bottom:10px; font-size:0.8rem !important; padding:2px 6px !important; height:24px !important; line-height:1 !important;">Agrupar por colaborador</button><button class="boton" id="exportExcelBtn" style="display:inline-block; margin-bottom:10px; font-size:0.8rem !important; padding:2px 6px !important; height:24px !important; line-height:1 !important; background-color: #217346; border-color: #1b5e33; color: white; margin-left: 1rem;">Exportar Excel</button>
<div id="overlayPago"><span id="overlayTextPago">Cargando información</span></div>
<div id="facturas-table" style="height:500px; display:none;"></div>
</div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<script>
    function mostrarSeccion(nombre) {
      // Ocultar todas las secciones
      document.getElementById('menuPrincipal').style.display = 'none';
      document.getElementById('seccionRevisionFacturas').style.display = 'none';
      document.getElementById('registrarAnticipo').style.display = 'none';
      document.getElementById('seccionPagoFacturas').style.display = 'none';

      // Mostrar la sección solicitada
      if (nombre === 'menuPrincipal') {
        document.getElementById('menuPrincipal').style.display = 'flex';
      } else if (nombre === 'revisionFacturas') {
        // Reset de filtros al entrar
        const filtroSectorElem = document.getElementById("filtroSector");
        if (filtroSectorElem) filtroSectorElem.value = "Todos";
        const filtroEstadoElem = document.getElementById("filtroEstado");
        if (filtroEstadoElem) filtroEstadoElem.value = "Todas";

        // Mostrar sección y recargar datos
        document.getElementById('seccionRevisionFacturas').style.display = 'block';
        
      } else if (nombre === 'registrarAnticipo') {
        document.getElementById('registrarAnticipo').style.display = 'block';
      }
    }

  </script>
<!-- Revisión de Facturas ACTIVA -->
<style>
  .tabla-responsive {
    overflow-x: auto;
    max-width: 100%;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  th {
    background-color: #f0f0f0;
    font-weight: bold;
  }
  th, td {
    padding: 8px 12px;
    border: 1px solid #ccc;
    text-align: left;
    white-space: nowrap;
  }
</style>
<div id="seccionRevisionFacturas" style="display: none; padding: 1rem;">
<button class="btn btn-secondary mb-3" onclick="regresarAlMenu()" type="button">
    ← Volver al Menú Principal
  </button>
<h2 style="margin-bottom: 1rem;">📄 Revisión de Facturas</h2>
<div id="countersRow">
<div class="counter-box">
<span class="label">Registradas</span><br>
<span class="value" id="counterRegistradas">0</span>
</br></div>
<div class="counter-box">
<span class="label">Revisadas</span><br>
<span class="value" id="counterRevisadas">0</span>
</br></div>
<div class="counter-box">
<span class="label">Anuladas</span><br>
<span class="value" id="counterAnuladas">0</span>
</br></div>
</div>
<div id="filtersRow">
<label for="filtroSector">Filtrar por sector:</label>
<select id="filtroSector" style="padding:0.5rem;">
<option value="">Todos</option>
</select>
<label for="filtroEstado">Filtrar por estado:</label>
<select id="filtroEstado" style="padding:0.5rem;">
<option value="">Todos</option>
</select>
<label for="filtroNumeroFactura">Filtrar Nº de Factura:</label>
<input id="filtroNumeroFactura" placeholder="Buscar factura…" style="padding:0.5rem;" type="text"/>
<label for="rangoFechas">Filtrar por rango de fechas:</label>
<input id="rangoFechas" placeholder="Desde - Hasta" readonly="" style="padding:0.5rem;" type="text"/>
</div>
<div id="toolbarRevision"
     style="display:flex;gap:.6rem;align-items:center;margin:.4rem 0 .8rem;">

  <!-- Botón visible: Agrupar / Desagrupar -->
  <button id="btnGroupColab"
    style="display:inline-flex;align-items:center;justify-content:center;
           height:1.8rem !important; line-height:1.8rem !important;
           padding:0 0.7rem !important; font-size:0.8rem !important;
           background:#6b7280; color:#fff; border:0; border-radius:.25rem;
           cursor:pointer; white-space:nowrap;">
    Agrupar por Colaborador
  </button>

  <!-- NUEVO: Exportar Excel (Revisión) -->
  <button id="btnExportRev"
    style="display:inline-flex;align-items:center;justify-content:center;
           height:1.8rem !important; line-height:1.8rem !important;
           padding:0 0.7rem !important; font-size:0.8rem !important;
           background:#217346; color:#fff; border:0; border-radius:.25rem;
           cursor:pointer; white-space:nowrap;">
    Exportar Excel
  </button>

  <!-- Botones masivos (ocultos hasta que haya ≥2 seleccionadas) -->
  <div id="accionesMasivas" style="display:none; gap:.6rem; align-items:center;">
    <button onclick="actualizarEstadoSeleccionados('Revisada')"
      style="display:inline-flex;align-items:center;justify-content:center;
             height:1.8rem !important; line-height:1.8rem !important;
             padding:0 0.7rem !important; font-size:0.8rem !important;
             background:#0b6fff; color:#fff; border:0; border-radius:.25rem;
             cursor:pointer; white-space:nowrap;">
      ✓ Marcar como Revisada
    </button>
    <button onclick="actualizarEstadoSeleccionados('Anulada')"
      style="display:inline-flex;align-items:center;justify-content:center;
             height:1.8rem !important; line-height:1.8rem !important;
             padding:0 0.7rem !important; font-size:0.8rem !important;
             background:#d32f2f; color:#fff; border:0; border-radius:.25rem;
             cursor:pointer; white-space:nowrap;">
      ✖ Marcar como Anulada
    </button>
  </div>
</div>


<div class="tabla-responsive" style="border: 1px solid #ccc; border-radius: 8px; overflow-x: auto; max-height: 60vh; padding: 1rem;">
<div id="tablaRevisionWrapper" style="position:relative;"><div id="tablaRevisionFacturas"></div><div id="overlayRevision"><span id="overlayTextRevision">Cargando información</span></div></div>
</div> <!-- Fin de contenedor scroll de tabla -->
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tablaRev = document.getElementById("tablaRevisionFacturas");
  if (!tablaRev) return;

  // Mostrar/ocultar los botones masivos SOLO en revisión
  function actualizarVisibilidadBotonesMasivosRevision() {
    const n = tablaRev.querySelectorAll('input[type="checkbox"]:checked').length;
    const cont = document.getElementById("accionesMasivas");
    if (cont) cont.style.display = (n >= 2) ? "block" : "none";
  }

  // Delegación: cualquier checkbox dentro de la tabla
  tablaRev.addEventListener("change", (e) => {
    if (e.target && e.target.matches('input[type="checkbox"]')) {
      actualizarVisibilidadBotonesMasivosRevision();
    }
  });
});
</script>

<script>
function regresarAlMenu() {
  // Oculta ambas secciones y muestra menú principal
  document.getElementById('seccionRevisionFacturas').style.display = 'none';
  document.getElementById('menuPrincipal').style.display = 'flex';
  // Limpia tablas y formularios
  const encabezado = document.getElementById('encabezadoTabla');
  const cuerpo = document.getElementById('cuerpoTabla');
  if (encabezado) encabezado.innerHTML = '';
  if (cuerpo) cuerpo.innerHTML = '';
  const form = document.getElementById('formulario_contenido');
  if (form) form.style.display = 'none';
}
</script>
<script>
function actualizarVisibilidadBotonesMasivos() {
  // contenedor de los botones masivos en Revisión
  const cont = document.getElementById("accionesMasivas");
  if (!cont) return;

  // contar checkboxes seleccionados en la tabla de Revisión
  const checks = document.querySelectorAll("#tablaRevisionFacturas input[type=checkbox]:checked");
  cont.style.display = (checks.length >= 2) ? "block" : "none";
}
</script>
<script>
function updateCounters() {
  const counts = { Registrada: 0, Revisada: 0, Anulada: 0 };
  document.querySelectorAll('#tablaFacturas tbody tr').forEach(tr => {
    const sel = tr.querySelector('select');
    const state = sel ? sel.value : tr.querySelector('td:last-child').textContent.trim();
    if (counts[state] !== undefined) counts[state]++;
  });
  document.getElementById('counterRegistradas').textContent = counts.Registrada;
  document.getElementById('counterRevisadas').textContent = counts.Revisada;
  document.getElementById('counterAnuladas').textContent = counts.Anulada;
}

document.addEventListener('DOMContentLoaded', () => {
  // Hook applyFiltros
  if (typeof aplicarFiltros === 'function') {
    const oldApply = aplicarFiltros;
    aplicarFiltros = function() {
      oldApply();
      updateCounters();
    }
  }
  // Hook cargarFacturasDesdeSheet if returns promise
  if (typeof cargarFacturasDesdeSheet === 'function') {
    const oldLoad = cargarFacturasDesdeSheet;
    cargarFacturasDesdeSheet = function() {
      const result = oldLoad();
      if (result && result.then) {
        return result.then(() => {
          updateCounters();
          return result;
        });
      } else {
        updateCounters();
        return result;
      }
    }
  }
  updateCounters();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnRegresarPago = document.querySelector("#seccionPagoFacturas button");
  if (btnRegresarPago && btnRegresarPago.textContent.includes("Regresar al Menú Principal")) {
    btnRegresarPago.addEventListener("click", () => {

      // Ocultar la sección de pago si sigue visible
      const pagoSection = document.getElementById("seccionPagoFacturas");
      if (pagoSection) {
        pagoSection.style.display = "none";
      }

      // Ocultar cualquier otra sección activa
      document.querySelectorAll(".seccion").forEach(seccion => {
        if (seccion !== pagoSection) {
          seccion.style.display = "none";
        }
      });

      // Mostrar el menú y restaurar su formato visual
      const menu = document.getElementById("menuPrincipal");
      if (menu) {
        menu.style.display = "flex";
        menu.style.flexDirection = "column";
        menu.style.alignItems = "center";
        menu.style.justifyContent = "center";
        menu.style.gap = "20px";
      }
    });
  }
});
</script><script>
function toggleAllPagoCheckboxes(source) {
  const checkboxes = document.querySelectorAll(".check-factura-pago");
  checkboxes.forEach(cb => cb.checked = source.checked);
}

function cargarPagoFacturas() {
  // Mostrar overlay con texto según carga
  const overlay = document.getElementById("overlayPago");
  const textEl = document.getElementById("overlayTextPago");
  textEl.textContent = window.isFirstLoadPagoFacturas ? "Cargando información" : "Actualizando información";
  overlay.style.display = "flex";
  window.isFirstLoadPagoFacturas = false;
  // Cargar datos y ocultar overlay
  if(window.loadDataPagoFacturas) {
    window.loadDataPagoFacturas()
      .then(() => { overlay.style.display = "none"; })
      .catch(() => { overlay.style.display = "none"; });
}

  
  
  
  // Resetear filtros al entrar en Pago de Facturas
  if (document.getElementById('filtroSectorPago')) document.getElementById('filtroSectorPago').value = 'Todos';
  if (document.getElementById('filtroEstadoPago')) document.getElementById('filtroEstadoPago').value = 'Todos';
  if (document.getElementById('filtroNumeroPago')) document.getElementById('filtroNumeroPago').value = '';
  if (window.flatpickrPago) flatpickrPago.clear();
  // Resetear contadores de cantidad
  if (document.getElementById('contadorPendientes')) document.getElementById('contadorPendientes').textContent = '0';
  if (document.getElementById('contadorPagadas')) document.getElementById('contadorPagadas').textContent = '0';
  // Resetear contadores de sumas
  if (document.getElementById('totalRevisada')) document.getElementById('totalRevisada').textContent = 'L 0.00';
  if (document.getElementById('totalPagada'))  document.getElementById('totalPagada').textContent  = 'L 0.00';

mostrarSeccion('seccionPagoFacturas');
  // Mostrar tabla y cargar datos
  var ft = document.getElementById('facturas-table'); if(ft) ft.style.display = 'block';
  if(window.tabulatorTable){ window.tabulatorTable.clearFilter(true); window.tabulatorTable.clearSort(); window.tabulatorTable.clearData(); }
  const seccion = document.getElementById("seccionPagoFacturas");
  if (seccion) seccion.style.display = "block";

  const spinner = document.getElementById("spinnerPago");
  const tabla = document.getElementById("facturas-table");
  const tbody = tabla ? tabla.querySelector("tbody") : null;

  if (!tabla || !tbody || !spinner) return;

  spinner.style.display = "block";
  tabla.style.display = "table";
  fetch("https://repositorio-de-pruebas.pages.dev/api/leer")
    .then(response => {
      if (!response.ok) throw new Error("HTTP " + response.status);
      return response.json();
    })
    .then(data => {
      if (!Array.isArray(data)) throw new Error("La respuesta no es un array válido");
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='12'>⚠️ No hay facturas para mostrar</td></tr>";
        return;
      
        // Limpiar filas previas sólo cuando llegan los datos nuevos
        tbody.innerHTML = "";
        }

      
      const filtradas = data.filter(factura => {
        const estado = (factura["Estado"] || "").toString().trim().toLowerCase();
        return estado === "revisada" || estado === "pagada";
      });
      // Cargar filtros de sector dinámicamente
      cargarFiltrosSectorPago(filtradas);
      // Actualizar contadores de Pago de Facturas
      const pendientes = filtradas.filter(f => f.Estado === 'Revisada').length;
      const pagadas = filtradas.filter(f => f.Estado === 'Pagada').length;
      document.getElementById('contadorPendientes').textContent = pendientes;
      document.getElementById('contadorPagadas').textContent = pagadas;

      
  // Actualizar totales según filtros
  let sumPend = 0, sumPag = 0;
  document.querySelectorAll('#tablaPagoFacturas tbody tr').forEach(tr => {
    if (tr.style.display === 'none') return;
    const sel = tr.querySelector('select.estado-select');
    const amount = parseFloat(tr.children[7].textContent.replace(/[^0-9.\-]/g, '')) || 0;
    if (sel && sel.value === 'Revisada') sumPend += amount;
    if (sel && sel.value === 'Pagada') sumPag += amount;
  });
  document.getElementById('totalRevisada').textContent = 'L ' + sumPend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('totalPagada').textContent   = 'L ' + sumPag.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

const totalRevisada = filtradas.filter(f => f.Estado === 'Revisada').reduce((s, f) => s + parseFloat(f['Total Gastado'] || 0), 0);
      const totalPagada  = filtradas.filter(f => f.Estado === 'Pagada').reduce((s, f) => s + parseFloat(f['Total Gastado'] || 0), 0);
      document.getElementById('totalRevisada').textContent = 'L ' + totalRevisada.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('totalPagada').textContent = 'L ' + totalPagada.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });


filtradas.forEach((f, index) => {
        const fila = document.createElement("tr");
        const fecha = f.Fecha ? new Date(f.Fecha).toLocaleDateString("es-ES") : "";
        const totalGastado = "L " + parseFloat(f["Total Gastado"] || 0).toFixed(2);
        const enlace = f["Enlace PDF"] ? `<a href="${f["Enlace PDF"]}" target="_blank">📄 Ver PDF</a>` : "";

        fila.innerHTML = `
          <td><input type="checkbox" class="check-factura-pago"></td>
          <td>${index + 1}</td>
          <td>${f.Sector || ""}</td>
          <td>${f.Placa || ""}</td>
          <td>${f.Proceso || ""}</td>
          <td>${f.Nombre || ""}</td>
          <td>${f.Identidad || ""}</td>
          <td style="text-align:right;">${totalGastado}</td>
          <td>${fecha}</td>
          <td>${f["Numero de Factura"] || ""}</td>
          <td>${enlace}</td>
          <td>
      <select class="estado-select" data-fila="${f.fila}">
        <option value="Revisada" ${f.Estado === 'Revisada' ? 'selected' : ''}>Revisada</option>
        <option value="Pagada"   ${f.Estado === 'Pagada'   ? 'selected' : ''}>Pagada</option>
      </select>
    </td>
        `;
        tbody.appendChild(fila);
      });

      // Asignar listener para actualizar estado en Pago de Facturas
      document.querySelectorAll('#tablaPagoFacturas .estado-select').forEach(sel => {
        sel.addEventListener('change', e => {
          actualizarEstadoIndividual(e.target.dataset.fila, e.target.value);
        });
      });
    })
    .catch(err => {
      tbody.innerHTML = "<tr><td colspan='12'>❌ Error cargando datos: " + err.message + "</td></tr>";
    })
    .finally(() => {
      spinner.style.display = "none";
    });
}
</script>
<script>
// Update counters based on Tabulator's internal data
function updateCountersPago() {
  const data = window.tabulatorTable.getData("active");
  let pendientes = 0, pagadas = 0;
  let sumPend = 0, sumPag = 0;
  data.forEach(f => {
    if (f.Estado === 'Revisada') {
      pendientes++;
      sumPend += parseFloat(f['Total Gastado'] || 0);
    }
    if (f.Estado === 'Pagada') {
      pagadas++;
      sumPag += parseFloat(f['Total Gastado'] || 0);
    }
  });
  document.getElementById('contadorPendientes').textContent = pendientes;
  document.getElementById('contadorPagadas').textContent = pagadas;
  document.getElementById('totalRevisada').textContent = 'L ' + sumPend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('totalPagada').textContent   = 'L ' + sumPag.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
</script>
<script>
// Aplica filtros sobre filas existentes de Pago de Facturas
function aplicarFiltrosPago() {
  const sector = document.getElementById('filtroSectorPago').value;
  const estado = document.getElementById('filtroEstadoPago').value;
  const numFact = document.getElementById('filtroNumeroPago').value.toLowerCase();
  const fechas = window.flatpickrPago ? window.flatpickrPago.selectedDates : [];
  let pendientes=0, pagadas=0;
  document.querySelectorAll('#tablaPagoFacturas tbody tr').forEach(tr => {
    const cols = tr.children;
    const rowSector = cols[2].textContent.trim();
    const rowEstado = cols[11].querySelector('select').value;
    const rowFactura = cols[9].textContent.toLowerCase();
    const rowFecha = new Date(cols[8].textContent.split('/').reverse().join('-'));
    let visible = true;
    if (sector !== 'Todos' && rowSector !== sector) visible = false;
    if (estado !== 'Todos' && rowEstado !== estado) visible = false;
    if (numFact && !rowFactura.includes(numFact)) visible = false;
    if (fechas.length === 2) {
      const [start, end] = fechas;
      if (!(rowFecha >= start && rowFecha <= end)) visible = false;
    }
    tr.style.display = visible ? '' : 'none';
    if (visible) {
      if (rowEstado === 'Revisada') pendientes++;
      if (rowEstado === 'Pagada') pagadas++;
    }
  });
  document.getElementById('contadorPendientes').textContent = pendientes;
  document.getElementById('contadorPagadas').textContent = pagadas;

  // Actualizar totales según filtros
  let sumPend = 0, sumPag = 0;
  document.querySelectorAll('#tablaPagoFacturas tbody tr').forEach(tr => {
    if (tr.style.display === 'none') return;
    const sel = tr.querySelector('select.estado-select');
    const amount = parseFloat(tr.children[7].textContent.replace(/[^0-9.\-]/g, '')) || 0;
    if (sel && sel.value === 'Revisada') sumPend += amount;
    if (sel && sel.value === 'Pagada') sumPag += amount;
  });
  document.getElementById('totalRevisada').textContent = 'L ' + sumPend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('totalPagada').textContent   = 'L ' + sumPag.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

}
// Inicializar filtros y flatpickr
document.addEventListener('DOMContentLoaded', () => {
  window.flatpickrPago = flatpickr('#filtroFechaPago', { mode:'range', dateFormat:'d/m/Y', locale:flatpickr.l10ns.es, onChange: aplicarFiltrosPago });
  document.getElementById('filtroSectorPago').addEventListener('change', aplicarFiltrosPago);
  document.getElementById('filtroEstadoPago').addEventListener('change', aplicarFiltrosPago);
  document.getElementById('filtroNumeroPago').addEventListener('input', aplicarFiltrosPago);
});
</script>
<script>
// Población de filtro de sector en Pago de Facturas
function cargarFiltrosSectorPago(data) {
  const filtro = document.getElementById("filtroSectorPago");
  if (!filtro) return;
  const sectores = Array.from(new Set(data.map(f => f.Sector))).sort();
  filtro.innerHTML = '<option value="Todos">Todos</option>';
  sectores.forEach(sector => {
    const opt = document.createElement("option");
    opt.value = sector;
    opt.textContent = sector;
    filtro.appendChild(opt);
  });
}
</script>
<script>
// Tabulator setup for Pago de Facturas
document.addEventListener("DOMContentLoaded", function(){
  var isGroupView = false;
  var btnGroup = document.getElementById("btnAgruparColaborador");
  if(btnGroup){
    btnGroup.addEventListener("click", function(){
      isGroupView = !isGroupView;
      if(isGroupView){
        table.setGroupBy("Identidad");
      } else {
        table.setGroupBy(false);
      }
      updateCounters();
    });
  }

  // Hide original elements
  var tbl = document.getElementById("facturas-table");
  if(tbl) tbl.style.display = "none";

  // Init flatpickr
  window.flatpickrPago = flatpickr("#filtroFechaPago", {
    mode: "range", dateFormat: "Y-m-d", locale: flatpickr.l10ns.es,
    onClose: function(){ window.applyFilters(); }
  });

  // Create Tabulator
  var table = new Tabulator("#facturas-table", {
    layout: "fitColumns", selectable: true, height: "500px", virtualDom: true, placeholder: "",
    
groupHeader:function(value, count, data, group){
      // Encontrar nombre completo
      let fullName = "";
      for(let r of data){
       if(r.Identidad === value && r.Nombre){
          fullName = r.Nombre;
          break;
        }
     }
      // Sumar total gastado
      const total = data.reduce((sum, row) => sum + (parseFloat(row["Total Gastado"])||0), 0);
      const formatted = total.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});

      // Construir cabecera con checkbox
      const container = document.createElement("div");
      container.style.display = "inline-flex";
      container.style.alignItems = "center";
      container.style.lineHeight = "1.2";
      container.style.padding = "2px 4px";
      container.style.justifyContent = "flex-start";
      container.style.margin         = "0"; 

     const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.style.transform = "scale(0.9)";
      cb.style.margin = "0 6px 0 0";
      cb.style.verticalAlign = "middle";
      cb.addEventListener("change", e => {
        group.getRows().forEach(row => e.target.checked ? row.select() : row.deselect());
      });
      container.appendChild(cb);

      const label = document.createElement("span");
      label.textContent = `${fullName} - ${value} - ${count} factura(s) - Total: L ${formatted}`;
      label.style.flexGrow = "1";     // para que el label use todo el espacio disponible
      label.style.textAlign = "left"; // y su texto quede a la izquierda
      container.appendChild(label);

      return container;
    },

    columns: [
      {formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false},
      {title:"#", formatter:"rownum", width:50},
      {title:"Sector", field:"Sector"},
      {title:"Placa", field:"Placa"},
      {title:"Proceso", field:"Proceso"},
      {title:"Nombre", field:"Nombre"},
      {title:"Identidad", field:"Identidad"},
      {
    title: "Total Gastado",
    field: "Total Gastado",
    sorter: "number",
    formatter: "money",
    formatterParams: {
        symbol: "L ",
        symbolAfter: false,
        thousand: ",",
        decimal: ".",
        precision: 2
    }
},
      {
    title: "Fecha",
    field: "Fecha", sorter:"string",
    formatter: function(cell) {
        var v = cell.getValue();
        return v ? v.split("T")[0] : "";
    }
},
	  {
  title: "Nombre del comercio",
  field: "Nombre del comercio",         // cámbialo si tu header es distinto
  width: 220,                      // ajusta el ancho a gusto
  formatter: (cell) => {
    const v = String(cell.getValue() ?? "");
    const max = 28;                // caracteres visibles
    return v.length > max ? v.slice(0, max) + "…" : v;
  },
  tooltip: true                    // muestra el valor completo al hover
},	
      {title:"Número de Factura", field:"Numero de Factura"},
      {title:"Enlace PDF", field:"Enlace PDF", formatter: cell => {
          var v = cell.getValue();
          return v?`<a href="${v}" target="_blank">📄</a>`:"";
      }},
        {title:"Estado", field:"Estado", hozAlign:"center",
            formatter:function(cell){
              var v = (cell.getValue()||"").toLowerCase();
              return v==="pagada" ? "Pagado" : '<button class="btn-pagar">Pagar</button>';
            },
            cellClick:function(e, cell){
              var v = (cell.getValue()||"").toLowerCase();
              if(v === "pagada"){
                // Ya pagada: no permitir acción
                return;
              }
                // Forzar modo INDIVIDUAL: limpiar arreglo masivo antes de abrir modal.
 // Limpia cualquier selección múltiple
 selectedPagoRows = [];
 // Guarda el RowComponent completo
 currentPagoRow = cell.getRow();
 // Abre el modal con sus datos
 showModalPago(currentPagoRow.getData(), currentPagoRow);
           }
        },
    ],
  });
  window.tabulatorTable = table;
    // Ocultar overlay cuando la tabla termine de renderizar datos
    table.on("dataRendered", function(){ document.getElementById("overlayPago").style.display = "none"; });

// Mostrar el botón solo si hay selección y ninguna está en "Pagada"
table.on("rowSelectionChanged", function (data, rows) {
  const btn = document.getElementById("btn-pagar-facturas");
  if (!btn) return;

  // Preferimos rows (RowComponents); si no vienen, caemos a data (objetos)
  const canPay = (rows && rows.length)
    ? rows.length > 0 && rows.every(r => String(r.getData().Estado || "").trim() !== "Pagada")
    : (data && data.length > 0 && data.every(d => String(d.Estado || "").trim() !== "Pagada"));

  btn.style.display = canPay ? "inline-block" : "none";
});



  // ==== Patch: función para pagos masivos ====
  window.actualizarEstadoMultiple = async function(filas, nuevoEstado, fondoPeriodo, fechaPago) {
  // Envía en paralelo todas las peticiones de pago con todos los datos
  await Promise.all(filas.map(fila =>
    fetch(urlGuardarFactura, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fila:         fila,
        nuevoEstado:  nuevoEstado,
        fondoPeriodo: fondoPeriodo,
        fechaPago:    fechaPago
      }),
    })
    .then(res => res.json())
    .then(result => {
      if (result.status !== "OK") {
        throw new Error(result.message || "Error al actualizar estados múltiples");
      }
    })
  ));
};

document.getElementById("btn-pagar-facturas").addEventListener("click", function(){
  const table = window.tabulatorTable || Tabulator.findTable("#facturas-table")[0];
  const rowsComps = table ? table.getSelectedRows() : [];
  if (!rowsComps.length) return;
  selectedPagoRows = rowsComps;
  const dataFirst = rowsComps[0].getData();
  showModalPago(dataFirst, rowsComps);
});
  

  // Load data function
  function loadDataPagoFacturas(){
  return fetch(urlLeerFacturas)
      .then(r=>r.json())
      .then(data=>{
        var rows = data.filter(f=>["Revisada","Pagada"].includes(f.Estado));
        window.facturasGlobal = rows;
        populateSector(rows);
        table.setData(rows).then(updateCounters);
      });
  window.loadDataPagoFacturas = loadDataPagoFacturas;
  }

  // Populate sector filter
  function populateSector(data){
    var sel = document.getElementById("filtroSectorPago");
    if(!sel) return;
    sel.innerHTML = '<option value="Todos">Todos</option>';
    Array.from(new Set(data.map(r=>r.Sector))).sort().forEach(s=>{
      sel.add(new Option(s,s));
    });
  }

  // Apply filters
  window.applyFilters = function(){
    var filters = [];
    var s = document.getElementById("filtroSectorPago").value;
    if(s!="Todos") filters.push({field:"Sector",type:"=",value:s});
    var e = document.getElementById("filtroEstadoPago").value;
    if(e!="Todos") filters.push({field:"Estado",type:"=",value:e});
    var n = document.getElementById("filtroNumeroPago").value;
    if(n) filters.push({field:"Numero de Factura",type:"like",value:n});
    var d = flatpickrPago.selectedDates || [];
    if (d.length) {
      var start = d[0].toISOString().split("T")[0];
      var end   = (d.length === 2) ? d[1].toISOString().split("T")[0] : start;
 
     if (start === end) {
       // un solo día: coincide cualquier hora de ese día
       filters.push({ field:"Fecha", type:"like", value:start });
     } else {
       // rango completo desde inicio hasta fin del día
       filters.push({ field:"Fecha", type:">=", value:start + "T00:00:00" });
       filters.push({ field:"Fecha", type:"<=", value:end   + "T23:59:59" });
     }
   }
    if(filters.length) table.setFilter(filters);
    else table.clearFilter(true);
    updateCounters();
  };

  // Update counters
  function updateCounters(){
    var data = table.getData("active"), p=0, g=0, sp=0, sg=0;
    data.forEach(r=>{
      if(r.Estado==="Revisada"){p++; sp+=parseFloat(r["Total Gastado"]||0);}
      if(r.Estado==="Pagada"){g++; sg+=parseFloat(r["Total Gastado"]||0);}
    });
    document.getElementById("contadorPendientes").textContent = p;
    document.getElementById("contadorPagadas").textContent   = g;
    document.getElementById("totalRevisada").textContent    = "L "+sp.toLocaleString("es-HN",{minimumFractionDigits:2});
    document.getElementById("totalPagada").textContent      = "L "+sg.toLocaleString("es-HN",{minimumFractionDigits:2});
  }

  // Hook filters
  ["filtroSectorPago","filtroEstadoPago"].forEach(id=>{
    document.getElementById(id).addEventListener("change",applyFilters);
  });
  document.getElementById("filtroNumeroPago").addEventListener("input",applyFilters);
  // Expose loadData for manual trigger
  window.loadDataPagoFacturas = loadDataPagoFacturas;
  // Initial load removed to defer loading until button click
});
</script>
<script>
// Exportar datos filtrados de la tabla a Excel
document.getElementById('exportExcelBtn').addEventListener('click', function() {
  window.tabulatorTable.download("xlsx", "facturas.xlsx", {
    sheetName: "Facturas",
    data: window.tabulatorTable.getData(true),
  });
});
</script>
<script>
  // Endpoints
  const urlLeerFacturas   = "https://repositorio-de-pruebas.pages.dev/api/leer";
  const urlGuardarReporte = "/api/guardar";

  document.addEventListener("DOMContentLoaded", function () {
    // === Tabla Revisión de Facturas ===
    var tableRevision = window.tableRevision = new Tabulator("#tablaRevisionFacturas", {
      layout: "fitColumns",
      height: "60vh",
      selectable: true,
      columns: [
        { formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false },
        { formatter:"rownum", title:"#", hozAlign:"center", width:40 },
        { title:"Sector", field:"Sector" },
        { title:"Placa", field:"Placa" },
        { title:"Proceso", field:"Proceso" },
        { title:"Nombre", field:"Nombre" },
        { title:"Identidad", field:"Identidad" },
        { title:"Total Gastado", field:"Total Gastado", formatter:"money",
          formatterParams:{ symbol:"L", symbolAfter:false, thousand:",", decimal:".", precision:2 } },
        { title:"Fecha", field:"Fecha",
          formatter:function(cell){
            var v = cell.getValue();
            return v ? v.split("T")[0] : "";
          } },
		{
  title: "Nombre del comercio",
  field: "Nombre del comercio",         // cámbialo si tu header es distinto
  width: 220,                      // ajusta el ancho a gusto
  formatter: (cell) => {
    const v = String(cell.getValue() ?? "");
    const max = 28;                // caracteres visibles
    return v.length > max ? v.slice(0, max) + "…" : v;
  },
  tooltip: true                    // muestra el valor completo al hover
},  
        { title:"Número de Factura", field:"Numero de Factura" },
        { title:"Enlace PDF", field:"Enlace PDF",
          formatter:function(cell){
            var v = cell.getValue();
            return v ? '<a href="'+v+'" target="_blank">📄</a>' : "";
          } },
        { title:"Estado", field:"Estado",
          editor:"list", editorParams:{ values:["Registrada","Revisada","Anulada"], autocomplete:true },
          cellEdited:function(cell){
            var d = cell.getRow().getData();
            if (typeof actualizarEstadoIndividual === "function"){
              actualizarEstadoIndividual(d.fila, cell.getValue());
            }
          }
        },
      ],
    });

    // Ocultar overlay cuando renderiza
    tableRevision.on("dataRendered", function(){
      var overlay = document.getElementById("overlayCambios");
      if (overlay) overlay.style.display = "none";
    });

    // Mostrar/ocultar acciones masivas (≥ 2 seleccionadas)
    tableRevision.on("rowSelectionChanged", function(data, rows){
      var cont = document.getElementById("accionesMasivas");
      if (!cont) return;
      cont.style.display = (rows && rows.length >= 2) ? "flex" : "none";
    });

    // --- Filtros (Estado / Sector / Número / Rango fechas) ---
    var filtroEstado = document.getElementById("filtroEstado");
    if (filtroEstado){
      filtroEstado.addEventListener("change", function(){
        if (this.value === "" || this.value === "Todas"){
          tableRevision.clearFilter(true);
        } else {
          tableRevision.setFilter("Estado", "=", this.value);
        }
      });
    }

    var sectorSelect = document.getElementById("filtroSector");
    if (sectorSelect){
      sectorSelect.addEventListener("change", function(){
        if (this.value === ""){
          tableRevision.clearFilter(true);
        } else {
          tableRevision.setFilter("Sector", "=", this.value);
        }
      });
    }

    var filtroNum = document.getElementById("filtroNumeroFactura");
    if (filtroNum){
      filtroNum.addEventListener("input", function(){
        var val = this.value;
        tableRevision.clearFilter(true);
        if (val){
          tableRevision.setFilter("Numero de Factura", "like", val);
        }
      });
    }

    // Poblar selects de filtros al cargar data y limpiar input de número
    tableRevision.on("dataLoaded", function(data){
      if (!Array.isArray(data)) return;

      // Poblar Sector
      var selSector = document.getElementById("filtroSector");
      if (selSector){
        for (var i = selSector.options.length - 1; i > 0; i--) selSector.remove(i);
        var sectores = data.map(r => r.Sector).filter((v,i,a)=>v && a.indexOf(v)===i).sort();
        sectores.forEach(function(s){
          var opt = document.createElement("option");
          opt.value = s; opt.text = s;
          selSector.add(opt);
        });
      }

      // Poblar Estado
      var selEstado = document.getElementById("filtroEstado");
      if (selEstado){
        for (var j = selEstado.options.length - 1; j > 0; j--) selEstado.remove(j);
        var estados = data.map(r => r.Estado).filter((v,i,a)=>v && a.indexOf(v)===i).sort();
        estados.forEach(function(e){
          var opt2 = document.createElement("option");
          opt2.value = e; opt2.text = e;
          selEstado.add(opt2);
        });
      }

      // Limpiar filtro de número al recargar
      if (filtroNum) filtroNum.value = "";
    });

    // Filtro por rango de fechas (flatpickr)
    var rangoInput = document.getElementById("rangoFechas");
    if (rangoInput && typeof flatpickr !== "undefined"){
      flatpickr("#rangoFechas", {
        mode: "range",
        dateFormat: "Y-m-d",
        locale: flatpickr.l10ns.es,
        onClose: function(selectedDates){
          tableRevision.clearFilter(true);
          if (selectedDates.length === 2){
            var start = selectedDates[0].toISOString().split("T")[0];
            var end   = selectedDates[1].toISOString().split("T")[0];
            tableRevision.addFilter("Fecha", ">=", start);
            tableRevision.addFilter("Fecha", "<=", end);
          }
        }
      });
    }

    // === Toggle: Agrupar por Colaborador (Identidad como clave) ===
    const btnGroup = document.getElementById("btnGroupColab");
    if (btnGroup){
      const moneyHN = v => new Intl.NumberFormat('es-HN',{style:'currency',currency:'HNL'}).format(v||0);
      let grouped = false;
      let built   = false;

      function applyGrouping(on){
        if (!built) return;                        // no agrupar antes de tableBuilt
        tableRevision._groupedByIdentidad = !!on;  // marca para exportación

        if (on){
          // Agrupar por Identidad (estable)
          tableRevision.setGroupBy(row => String(row.Identidad || "").trim());

          tableRevision.setGroupHeader([
            function(value, count, data){
              // primer Nombre no vacío del grupo
              const nombre = (data.find(r => r.Nombre && String(r.Nombre).trim())?.Nombre) || "(Sin nombre)";
              const identidad = value || "(Sin identidad)";
              const total = data.reduce((s, r) =>
                s + Number(r["Total Gastado"] ?? r.Total ?? r.Monto ?? 0), 0);

              return `${nombre} [${identidad}] — ${count} factura${count!==1?"s":""} — ${moneyHN(total)}`;
            }
          ]);

          tableRevision.setGroupStartOpen(false);
          btnGroup.textContent = "Quitar agrupación";
        } else {
          tableRevision.setGroupBy(false);
          btnGroup.textContent = "Agrupar por Colaborador";
        }
      }

      // Desactiva el botón hasta que la tabla esté lista
      btnGroup.disabled = true;

      // Habilita y aplica tras construir la tabla
      tableRevision.on("tableBuilt", function(){
        built = true;
        btnGroup.disabled = false;
        applyGrouping(grouped);

        // Reaplica al recargar datos (ya con tabla construida)
        tableRevision.on("dataLoaded", function(){
          applyGrouping(grouped);
        });
      });

      // Toggle manual
      btnGroup.addEventListener("click", function(){
        grouped = !grouped;
        applyGrouping(grouped);
      });
    }

    // === Exportar Excel (Revisión) ===
    const btnExportRev = document.getElementById("btnExportRev");
    if (btnExportRev){
      btnExportRev.addEventListener("click", function(){
        // Exporta lo visible (filtros aplicados)
        const rows = tableRevision.getData("active") || [];
        if (!rows.length){
          alert("No hay datos para exportar.");
          return;
        }

        const wb = XLSX.utils.book_new();

        // Si está agrupado por Identidad, crea hoja de Resumen
        if (tableRevision._groupedByIdentidad){
          const map = new Map();
          rows.forEach(r => {
            const id = String(r.Identidad || "").trim() || "(Sin identidad)";
            const g = map.get(id) || { Identidad:id, Nombre:"", Facturas:0, Total:0 };
            if (!g.Nombre && r.Nombre) g.Nombre = r.Nombre;
            g.Facturas += 1;
            g.Total += Number(r["Total Gastado"] ?? r.Total ?? r.Monto ?? 0);
            map.set(id, g);
          });
          const resumen = Array.from(map.values());
          const wsRes = XLSX.utils.json_to_sheet(resumen, {
            header: ["Identidad","Nombre","Facturas","Total"]
          });
          XLSX.utils.book_append_sheet(wb, wsRes, "Resumen");
        }

        // Hoja de Detalle
        const headers = [
          "Sector","Placa","Proceso","Nombre","Identidad",
          "Total Gastado","Fecha","Numero de Factura","Enlace PDF","Estado"
        ];
        const detalle = rows.map(r => ({
          "Sector":            r.Sector ?? "",
          "Placa":             r.Placa ?? "",
          "Proceso":           r.Proceso ?? "",
          "Nombre":            r.Nombre ?? "",
          "Identidad":         r.Identidad ?? "",
          "Total Gastado":     Number(r["Total Gastado"] ?? r.Total ?? r.Monto ?? 0),
		  "Fecha":             (r.Fecha ? String(r.Fecha).split("T")[0] : ""),
          "Nombre del comercio": r["Nombre del comercio"] ?? "",
		  "Numero de Factura": r["Numero de Factura"] ?? "",
          "Enlace PDF":        r["Enlace PDF"] ?? "",
          "Estado":            r.Estado ?? ""
        }));
        const wsDet = XLSX.utils.json_to_sheet(detalle, { header: headers });
        XLSX.utils.book_append_sheet(wb, wsDet, "Detalle");

        const fecha = new Date().toISOString().slice(0,10);
        XLSX.writeFile(wb, `revision_facturas_${fecha}.xlsx`);
      });
    }
  });
</script>

<!-- ==== Patch v20: cumulative filters + single-day fix === -->
<script>
document.addEventListener("DOMContentLoaded", function(){

  // Locate Tabulator instance for #tablaRevisionFacturas
  var tableElem = document.querySelector("#tablaRevisionFacturas");
  if(!tableElem){
    console.warn("Patch v20: table element #tablaRevisionFacturas not found");
    return;
  }
  var tableArray = Tabulator.findTable(tableElem);
  if(!tableArray.length){
    console.warn("Patch v20: Tabulator instance not yet available");
    return;
  }
  var table = tableArray[0];

  // Flatpickr setup (range mode)
  var dateInput = document.getElementById("rangoFechas");
  if(dateInput){
    if(!window.flatpickrRevision){
        window.flatpickrRevision = flatpickr(dateInput,{
          mode:"range",
          dateFormat:"Y-m-d",
          locale: flatpickr.l10ns.es,
          onClose: function(){ applyFiltersRevision(); }
        });
    }else{
        dateInput._flatpickr.set("onClose", [function(){ applyFiltersRevision(); }]);
    }
  }

  // Core function
  function applyFiltersRevision(){
      var filters = [];

      // Sector
      var sector = (document.getElementById("filtroSector")||{}).value || "";
      if(sector && sector !== "Todos") filters.push({field:"Sector", type:"=", value:sector});

      // Estado
      var estado = (document.getElementById("filtroEstado")||{}).value || "";
      if(estado && estado !== "Todos") filters.push({field:"Estado", type:"=", value:estado});

      // Numero Factura
      var num = (document.getElementById("filtroNumeroFactura")||{}).value || "";
      if(num) filters.push({field:"Numero de Factura", type:"like", value:num.trim()});

      // Fecha
      var dr = window.flatpickrRevision ? window.flatpickrRevision.selectedDates : [];
      if(dr && dr.length){
         var start = flatpickr.formatDate(dr[0],"Y-m-d");
         var end   = (dr.length === 2) ? flatpickr.formatDate(dr[1],"Y-m-d") : start;

         if(start === end){
           // Un solo día: usar LIKE para evitar problemas con hora
           filters.push({field:"Fecha", type:"like", value:start});
         }else{
           // Rango: usar >= y <= con tiempo definido
           filters.push({field:"Fecha", type:">=", value:start + "T00:00:00"});
           filters.push({field:"Fecha", type:"<=", value:end   + "T23:59:59"});
         }
      }

      // Aplicar o limpiar
      if(filters.length){
        table.setFilter(filters);
      }else{
        table.clearFilter(true);
      }
  }

  // Attach listeners (en fase capture para anular previos)
  ["filtroSector","filtroEstado"].forEach(id=>{
     var el = document.getElementById(id);
     if(el){
        el.addEventListener("change", function(e){
          e.stopImmediatePropagation();
          applyFiltersRevision();
        }, true);
     }
  });
  var numEl = document.getElementById("filtroNumeroFactura");
  if(numEl){
     numEl.addEventListener("input", function(e){
       e.stopImmediatePropagation();
       applyFiltersRevision();
     }, true);
  }

  // Expose for debugging
  window.applyFiltersRevision = applyFiltersRevision;
});
</script>
<!-- ==== End Patch v20 === -->
<!-- ==== Clean Counters Rebuild v25 ==== -->
<script>
(function(){
  const COUNTER_IDS = {
    "registrada":"counterRegistradas",
    "revisada":"counterRevisadas",
    "anulada":"counterAnuladas"
  };

  function recalc(tab){
    const data = tab.getData("active");
    const counts = {registrada:0,revisada:0,anulada:0};
    data.forEach(function(row){
      const est = String(row.Estado||"").trim().toLowerCase();
      if(counts.hasOwnProperty(est)) counts[est]++;
    });
    Object.keys(COUNTER_IDS).forEach(function(key){
      const el = document.getElementById(COUNTER_IDS[key]);
      if(el) el.textContent = counts[key];
    });
  }

  function init(){
    const tab = Tabulator.findTable("#tablaRevisionFacturas")[0];
    if(!tab){
      setTimeout(init, 300);
      return;
    }

    // Wait until data is present at least once
    (function waitData(){
      if(tab.getData().length === 0){
        setTimeout(waitData, 300);
      }else{
        recalc(tab);
      }
    })();

    // Hook events
    tab.on("dataFiltered", () => recalc(tab));
    tab.on("renderComplete", () => recalc(tab));
    tab.on("dataLoaded", () => recalc(tab));
    tab.on("cellEdited", () => recalc(tab));
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
<!-- ==== End Clean Counters Rebuild v25 ==== -->
<!-- ==== Patch v34: actualizar estado en Revisión de Facturas ==== -->
<script>
(function(){
  // Si ya existe actualizarEstadoIndividual, reutilizarlo
  if(typeof window.actualizarEstadoIndividual === "function") return;

  const ENDPOINT = typeof urlGuardarReporte !== "undefined" ? urlGuardarReporte : "/api/guardar";

  async function actualizarEstadoIndividual(fila, nuevoEstado){
    const overlay = document.getElementById("overlayCambios");
    if(overlay) overlay.style.display = "flex";
    try{
      const resp = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ actualizarEstado: true, fila: fila, nuevoEstado: nuevoEstado })
      });
      const result = await resp.json().catch(()=>({status:"ERROR"}));
      console.log("Respuesta actualización", result);
      if(result.status !== "OK"){
        alert("Error al actualizar estado: " + (result.message || JSON.stringify(result)));
        return;
      }
      // Sincronizar tabla Revisión si existe
      try{
        const tab = Tabulator.findTable("#tablaRevisionFacturas")[0];
        if(tab){
          // Buscar por campo fila
          const row = tab.getRows().find(r=>{
            const d = r.getData();
            return String(d.fila) === String(fila) || String(d._fila) === String(fila);
          });
          if(row) row.update({Estado: nuevoEstado});
        }
      }catch(e){}
    }catch(err){
      console.error("Falló la actualización de estado", err);
      alert("No se pudo guardar el cambio. Intenta nuevamente.");
    }finally{
      if(overlay) overlay.style.display = "none";
      if(typeof updateCountersRevision === "function") updateCountersRevision();
    }
  }

  // Exponer global
  window.actualizarEstadoIndividual = actualizarEstadoIndividual;
})();
</script>
<!-- ==== Fin Patch v34 ==== -->
<script>
(function(){
  // Usa el mismo endpoint que el patch v34
  const ENDPOINT = (typeof urlGuardarReporte !== "undefined")
      ? urlGuardarReporte : "/api/guardar";

  async function actualizarEstadoSeleccionados(nuevoEstado){
    const tab = Tabulator.findTable("#tablaRevisionFacturas")[0];
    if(!tab){ alert("Tabla no disponible"); return; }

    const rows = tab.getSelectedRows();
    if(rows.length < 2){
      alert("Selecciona al menos 2 facturas.");
      return;
    }

    const overlay = document.getElementById("overlayCambios");
    if(overlay) overlay.style.display = "flex";

    try {
      await Promise.all(rows.map(r => {
        const d = r.getData();
        const fila = d.fila ?? d._fila;
        return fetch(ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ actualizarEstado:true, fila, nuevoEstado })
        })
        .then(res => res.json())
        .then(result => {
          if(result.status !== "OK") throw new Error(result.message || "Error al actualizar");
          // refleja el cambio en la tabla
          r.update({ Estado: nuevoEstado });
        });
      }));

      // limpiar selección y ocultar botones masivos
      tab.deselectRow();
      const cont = document.getElementById("accionesMasivas");
      if (cont) cont.style.display = "none";

      // refrescar contadores (mismo criterio que tus patches)
      const data = tab.getData("active");
      const acc = {registrada:0,revisada:0,anulada:0};
      data.forEach(row=>{
        const est = String(row.Estado||"").trim().toLowerCase();
        if (acc.hasOwnProperty(est)) acc[est]++;
      });
      const set = (id,val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
      set("counterRegistradas", acc.registrada);
      set("counterRevisadas",   acc.revisada);
      set("counterAnuladas",    acc.anulada);

    } catch (e) {
      console.error(e);
      alert("No se pudo actualizar algunas filas: " + (e.message || e));
    } finally {
      if(overlay) overlay.style.display = "none";
    }
  }

  // Exponer global para los botones
  window.actualizarEstadoSeleccionados = actualizarEstadoSeleccionados;
})();
</script>

<!-- ==== Patch v36: Counters Pago live on Estado edit ==== -->
<script>
document.addEventListener("DOMContentLoaded", function(){
  function hookPago(){
    if(!window.tabulatorTable){ setTimeout(hookPago, 300); return; }
    if(window.tabulatorTable._pagoHookAttached) return;
    window.tabulatorTable._pagoHookAttached = true;

    // Recalculate counters when Estado changes
    window.tabulatorTable.on("cellEdited", function(cell){
      if(cell.getField() === "Estado" && typeof updateCountersPago === "function"){
        updateCountersPago();
      }
    });

    // Also recalc after filters applied via applyFiltrosPago if exists
    if(typeof aplicarFiltrosPago === "function"){
      const old = aplicarFiltrosPago;
      aplicarFiltrosPago = function(){
        old();
        if(typeof updateCountersPago === "function") updateCountersPago();
      };
    }
  }
  hookPago();
});
</script>
<!-- ==== End Patch v36 ==== -->
<script>
  async function registrar(){
  var ov = document.getElementById("overlayAnt");
  ov.querySelector("span").textContent = "Registrando cambios";
  ov.style.display = "flex";

     const payload = {
     accion: "registrarAnticipo",
     Sector:  document.getElementById("antSector").value,
     Fondo:   document.getElementById("antFondo").value,
     Deposito:Number(document.getElementById("antDeposito").value),
     Periodo: document.getElementById("antPeriodo").value
   };
   await fetch(urlGuardarAnticipo, {
     method:  "POST",
     headers: {"Content-Type": "application/json"},
     body:    JSON.stringify(payload)
   })
    .then(function(res){ return res.json(); })
    .then(function(res){ if(res.status !== "OK") throw new Error(res.message); })
    .catch(function(err){ console.error("Error al registrar:", err); })
    .finally(function(){ cargarAnticipos(); });
}
document.addEventListener('DOMContentLoaded',()=>{
  const $=id=>document.getElementById(id);
  const money=v=>'L '+Number(v||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  let tab;
  function overlay(s){$('overlayAnt').style.display=s?'flex':'none';}
  function cargar(){
    fetch(urlLeerAnticipos).then(r=>r.json()).then(d=>{
      if(tab){tab.replaceData(d);}else{
        tab=new Tabulator('#tablaAnticipos',{data:d,height:'55vh',layout:'fitColumns',columns:[
          {formatter:'rownum',width:50},
          {title:'Sector',field:'Sector'},
          {title:'Fondo',field:'Fondo'},
          {title:'Deposito',field:'Deposito',formatter:'money',formatterParams:{symbol:'L ',precision:2}},
          {title:'Periodo',field:'Periodo'},
          {title:'Estado',field:'Estado',editor:'list',editorParams:{values:['Vigente','Aplicado','Anulado']},
            cellEdited:c=>{const r=c.getRow().getData();actualizarEstado(r.fila||r._fila,c.getValue());}}
        ]});
      }
      resumen(d);
    });
  }
    function resumen(d){
    const t=d.reduce((s,r)=>s+Number(r.Deposito||0),0);
    const sld=d.filter(r=>r.Estado==='Vigente').reduce((s,r)=>s+Number(r.Deposito||0),0);
    $('antTotal').textContent=money(t); $('antSaldo').textContent=money(sld);
  }

  $('btnBackAnt').addEventListener('click',()=>{ $('registrarAnticipo').style.display='none'; $('menuPrincipal').style.display='flex';});
  
// populate periodo select
const perSel=document.getElementById('antPeriodo');
if(perSel && perSel.options.length<=1){
  const today=new Date();
  for(let i=0;i<18;i++){
    const d=new Date(today.getFullYear(), today.getMonth()-i,1);
    const val=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
    const opt=document.createElement('option');opt.value=val;opt.textContent=val;perSel.appendChild(opt);
  }
}
});
</script>
<script>

// Cargar sectores para anticipos (estático)
function cargarSectoresAnticipo() {
  const sel = document.getElementById('antSector');
  sel.innerHTML = '<option value="">Seleccione</option>';
  const opciones = ["SAN PEDRO SULA", "EL PROGRESO", "STA. CRUZ", "CHOLUTECA", "COMAYAGUA", "DANLI", "GUANAJA", "JUTICALPA", "LA CEIBA", "SANTA ROSA", "TEGUCIGALPA", "TOCOA", "BRUS LAGUNA"];
  opciones.forEach(s => sel.add(new Option(s, s)));
}

// Poner opciones de fondo
function poblarFondo() {
  const sel = document.getElementById('antFondo');
  sel.innerHTML = '<option value="">Seleccione</option><option value="Combustible">Combustible</option><option value="Poda">Poda</option>';
}
// Generar lista de últimos 12 periodos en formato yyyyMM
function poblarPeriodoAnticipo() {
  const sel = document.getElementById('antPeriodo');
  sel.innerHTML = '<option value="">Seleccione</option>';
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    let date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const ym = date.getFullYear().toString() + (date.getMonth() + 1).toString().padStart(2,'0');
    sel.add(new Option(ym, ym));
  }
}
// Mostrar sección al pulsar el botón y cargar datos
document.getElementById('btnIrRegistrarAnticipo').addEventListener('click', function(){
  document.getElementById('menuPrincipal').style.display = 'none';
  const sec = document.getElementById('registrarAnticipo');
  sec.style.display = 'flex';
  cargarSectoresAnticipo();
  poblarFondo();
  poblarPeriodoAnticipo();
});
</script>

<script>
// Flag de primera carga
window.isFirstLoadRevisionFacturas = true;

// Carga datos (fetch + setData) replicando lógica de sección Pago
function loadDataRevisionFacturas(){
 return fetch(urlLeerFacturas)
    .then(r => r.json())
    .then(function(data){
      // Solo facturas que NO estén pagadas
      var rows = data.filter(function(f){
        return (f.Estado || "").toLowerCase().trim() !== "pagada";
      });
      // Guarda en global si lo necesitas
      window.revisionFacturasGlobal = rows;
      // Carga en tabla
      if(window.tableRevision && window.window.tableRevision.setData){
        return window.tableRevision.setData(rows).then(updateCountersRevision);
      }
    });
}

// Overlay helper
function mostrarOverlayRevision(modo){
  var overlay = document.getElementById('overlayRevision');
  var textEl  = document.getElementById('overlayTextRevision');
  if(!overlay || !textEl) return;
  textEl.textContent = (modo === 'init') ? 'Cargando información' : 'Actualizando información';
  overlay.style.display = 'flex';
}

// Actualiza contadores de revisión
function updateCountersRevision(){
   var data = window.tableRevision ? window.tableRevision.getData("active") : window.revisionFacturasGlobal || [];
  var regs = 0, revisadas = 0, anuladas = 0;
  data.forEach(function(f){
    var e = (f.Estado || "").toLowerCase().trim();
    if(e === "registrada") regs++;
    else if(e === "revisada") revisadas++;
    else if(e === "anulada") anuladas++;
  });
  document.getElementById('counterRegistradas').textContent = regs;
  document.getElementById('counterRevisadas').textContent = revisadas;
  document.getElementById('counterAnuladas').textContent = anuladas;
}
// Botón o evento para entrar a sección
function cargarRevisionFacturas(){
  mostrarSeccion('revisionFacturas');
  const overlay = document.getElementById('overlayRevision');
  const textEl = document.getElementById('overlayTextRevision');
  textEl.textContent = window.isFirstLoadRevisionFacturas ? "Cargando información" : "Actualizando información";
  overlay.style.display = 'flex';
  window.isFirstLoadRevisionFacturas = false;

  
  // Limpiar datos previos en la tabla de revisión
  if(window.tableRevision){ window.tableRevision.clearData(); }
// Reset filtros
  document.getElementById('filtroSector').value = '';
  document.getElementById('filtroEstado').value = '';
  document.getElementById('filtroNumeroFactura').value = '';
  if(window.flatpickrRevision) flatpickrRevision.clear();

  // Reset contadores
  document.getElementById('counterRegistradas').textContent = '0';
  document.getElementById('counterRevisadas').textContent = '0';
  document.getElementById('counterAnuladas').textContent = '0';

  loadDataRevisionFacturas()
    .catch(function(err){ console.error('Error al cargar revisión de facturas:', err); })
    .finally(function(){
      overlay.style.display = 'none';
    });
}

// Ocultar overlay cuando datos renderizados (Tabulator event)
document.addEventListener('DOMContentLoaded', function(){
  if(window.tableRevision){
    tableRevision.on("dataRendered", function(){
      var overlay = document.getElementById('overlayRevision');
      if(overlay) overlay.style.display = 'none';
    });
  }
});
</script>



<script>
// Anticipos: Overlay y lógica de carga (tree-table con pagos)
window.isFirstLoadAnticipo = true;

document.addEventListener("DOMContentLoaded", function(){
  // utilidades para DOM y formato de moneda
  const $     = id => document.getElementById(id);
  const money = v  => new Intl.NumberFormat('es-HN', {
    style: 'currency', currency: 'HNL'
  }).format(v || 0);

  window.tabAnticipos = new Tabulator("#tablaAnticipos", {
    height: "55vh",
    layout: "fitColumns",
    placeholder: "No hay registros",
    dataTree: true,
    dataTreeChildField: "pagos",
    dataTreeElementColumn: "descripcion",
    dataTreeStartExpanded: false,
    columns: [
	  { title: "Periodo", field: "Periodo", hozAlign:"center" },	
      { title: "Sector",       field: "Sector",      hozAlign:"left" },
      { title: "Descripción", field: "descripcion", headerSort: false },
      { title: "Monto",       field: "monto",       hozAlign: "right", formatter: "money", formatterParams: { symbol: "L ", precision: 2 } },
      { title: "Saldo",       field: "saldo",       hozAlign: "right", formatter: "money", formatterParams: { symbol: "L ", precision: 2 } }
    ]
  });

  // 1) Obtener referencias
  const fSector = document.getElementById("filterSectorAnt");
  const fPeriod = document.getElementById("filterPeriodoAnt");

  // 2) Definir la función de filtrado
  function aplicarFiltros(){
    const sec = fSector.value;
    const per = fPeriod.value;
    tabAnticipos.clearFilter(true);
    if (sec) tabAnticipos.addFilter("Sector",  "=", sec);
    if (per) tabAnticipos.addFilter("Periodo","=", per);
  // Y actualizamos contadores conforme a los mismos criterios
   recalcularContadores();
  }

 // 5) Función para recalcular los contadores según los filtros
function recalcularContadores(){
  const sec = fSector.value;
  const per = fPeriod.value;

  // 1) Filtrar anticipos según sector y periodo (coerción de tipos)
  const filtrados = window.anticiposData.filter(a =>
    (!sec || a.Sector === sec) &&
    (!per  || String(a.Periodo) === per)   // <-- String() aquí
  );

  // 2) Calcular totales y saldos descontando pagos
  let total = 0, saldo = 0;
  filtrados.forEach(a => {
    const dep = Number(a.Deposito || 0);
    total += dep;

    // buscar pagos para este anticipo
    const key = `${a.Fondo}-${a.Periodo}`;
    const pagos = (window.facturasData || [])
      .filter(f => f.Fondo === key && (f.Estado||"").toLowerCase() === "pagada")
      .reduce((s, f) => s + Number(f["Total Gastado"]||0), 0);

    saldo += dep - pagos;
  });

  // 3) Actualizar la UI
  document.getElementById("antTotal").textContent = money(total);
  document.getElementById("antSaldo").textContent = money(saldo);
}
async function cargarAnticipos(){
  // 0) Al entrar, resetear filtros y contadores
  document.getElementById("filterSectorAnt").value   = "";
  document.getElementById("filterPeriodoAnt").value  = "";
  tabAnticipos.clearFilter(true);

  mostrarSeccion("registrarAnticipo");
  const ov = document.getElementById("overlayAnt");
  const span = ov.querySelector("span");
  span.textContent = window.isFirstLoadAnticipo ? "Cargando información" : "Actualizando información";
  ov.style.display = "flex";
  window.isFirstLoadAnticipo = false;

  document.getElementById("antTotal").textContent = "L 0.00";
  document.getElementById("antSaldo").textContent = "L 0.00";
  tabAnticipos.clearData();

  try {
    const [anticipos, facturas] = await Promise.all([
      fetch(urlLeerAnticipos + "?accion=leerAnticipos").then(r => r.json()),
      fetch(urlLeerFacturas + "?leerFacturas=true").then(r => r.json())
    ]);

 // Guardamos globalmente para usarlo en los filtros
 window.anticiposData = anticipos;
 window.facturasData  = facturas;
 window.cargarAnticipos = cargarAnticipos;

    // ↓↓↓ Pueblar filtros con los valores únicos de los anticipos ↓↓↓
  const sectorSel = document.getElementById("filterSectorAnt");
  const periodSel = document.getElementById("filterPeriodoAnt");

  // Obtener sets únicos
  const sectores = Array.from(new Set(anticipos.map(a => a.Sector)));
  const periodos = Array.from(new Set(anticipos.map(a => a.Periodo)));

  // Limpiar y rellenar
  sectorSel.innerHTML = '<option value="">Todos</option>';
  sectores.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s; opt.textContent = s;
    sectorSel.appendChild(opt);
  });

  periodSel.innerHTML = '<option value="">Todos</option>';
  periodos.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p; opt.textContent = p;
    periodSel.appendChild(opt);
  });
  // ↑↑↑ fin de población dinámica de filtros ↑↑↑

    let saldo = 0, totalAnt = 0;
    const treeData = anticipos.map(a => {
      const dep = Number(a.Deposito || a.deposito || 0);
      totalAnt += dep;
      saldo += dep;
      const key = `${a.Fondo}-${a.Periodo}`;
  const pagos = (facturas || []).filter(f =>
    f.Fondo === key &&
    (f.Estado  || "").toLowerCase() === "pagada"
  ).map(f => {
        const amt = Number(f["Total Gastado"] || 0);
        saldo -= amt;
        return {
          Periodo: a.Periodo,
          Sector: a.Sector, 
          id: f.fila,
          descripcion: `Pago factura #${f["Numero de Factura"] || ""}`,
          monto: -amt,
          saldo: saldo
        };
      });
  const nodo = {
    Periodo: a.Periodo,
    Sector: a.Sector,
    id: a.fila,
    descripcion: `Anticipo ${a.Fondo} (${a.Periodo})`,
    monto: dep,
    saldo: saldo,
  };
  if (pagos.length) {
    nodo.pagos = pagos;
  }
  return nodo;
    });

 window.treeData = treeData;
 tabAnticipos.setData(treeData);
 // Contadores iniciales (sin filtros)
 recalcularContadores();

    document.getElementById("antTotal").textContent =
      new Intl.NumberFormat('es-HN', {style: 'currency', currency: 'HNL'}).format(totalAnt);
    document.getElementById("antSaldo").textContent =
      new Intl.NumberFormat('es-HN', {style: 'currency', currency: 'HNL'}).format(saldo);

  } catch (error) {
    console.error("Error al cargar anticipos:", error);
  } finally {
    document.getElementById("overlayAnt").style.display = "none";
  }
}
  // 3) Enganchar los selects
  fSector.addEventListener("change", aplicarFiltros);
  fPeriod.addEventListener("change", aplicarFiltros);

  // 4) Resto de listeners de navegación…
  document.getElementById("btnIrRegistrarAnticipo")
    .addEventListener("click", cargarAnticipos);
  document.getElementById("btnBackAnt")
    .addEventListener("click", () => mostrarSeccion("menuPrincipal"));
}); 

document.getElementById("btnExportExcel").addEventListener("click", () => {
  // 0) Validar que SheetJS esté disponible
  if (typeof XLSX === "undefined") {
    alert("No se encontró la librería XLSX. Revisa el <script> de SheetJS.");
    return;
  }

  // 1) Tomar filtros actuales
  const sec = (document.getElementById("filterSectorAnt") || {}).value || "";
  const per = (document.getElementById("filterPeriodoAnt") || {}).value || "";

  // 2) Base de datos: preferimos el treeData que generas tú.
  //    Si por cualquier razón no existe/está vacío, usamos los datos de la tabla.
  const base =
    (Array.isArray(window.treeData) && window.treeData.length)
      ? window.treeData
      : (window.tabAnticipos && typeof window.tabAnticipos.getData === "function"
          ? window.tabAnticipos.getData()
          : []);

  // 3) Aplicar filtros (si hay)
  const data = base.filter(n =>
    (!sec || n.Sector === sec) &&
    (!per || String(n.Periodo) === per)
  );

  // 4) Aplanar padres + hijos (pagos)
  const flat = [];
  data.forEach(nodo => {
    // Padre (anticipo)
    flat.push({
      Periodo:     nodo.Periodo,
      Sector:      nodo.Sector,
      Descripción: nodo.descripcion,
      Monto:       Number(nodo.monto || 0),
      Saldo:       Number(nodo.saldo || 0)
    });
    // Hijos (pagos)
    (nodo.pagos || []).forEach(p => {
      flat.push({
        Periodo:     p.Periodo ?? nodo.Periodo,
        Sector:      p.Sector  ?? nodo.Sector,
        Descripción: p.descripcion,
        Monto:       Number(p.monto || 0),
        Saldo:       Number(p.saldo || 0)
      });
    });
  });

  if (!flat.length) {
    alert("No hay datos para exportar.");
    return;
  }

  // 5) Crear workbook y descargar
  const headers = ["Periodo","Sector","Descripción","Monto","Saldo"];
  const rows    = flat.map(r => headers.map(h => r[h]));
  const ws      = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb      = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Anticipos");
  XLSX.writeFile(wb, "anticipos.xlsx");
}); 

</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const showBtn = document.getElementById("btnShowAnt");
    const mini   = document.getElementById("anticipoMiniForm");
    const addBtn = document.getElementById("btnAddAnt");

    // Al entrar a la sección (ya se hace via btnIrRegistrarAnticipo), aseguramos estado inicial:
    showBtn.style.display = "inline-block";
    mini.style.display    = "none";

    // 1) Mostrar el mini-form al pulsar “Registrar nuevo Anticipo”
    showBtn.addEventListener("click", () => {
      showBtn.style.display = "none";
      mini.style.display    = "flex";
    });

    // 2) Después de registrar (tu lógica actual de registrarAnticipo)
    addBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      await registrar();  // tu función existente
      // Tras guardarlo, volvemos a ocultar form y volver a mostrar el botón
      mini.style.display    = "none";
      showBtn.style.display = "inline-block";
    });
  });
</script>


<!-- Modal para registrar pago -->
<div id="modalPago">
  <div class="dialog">
    <h3>Registrar Pago</h3>
    
<label>Comprobante de pago:</label>
<div id="pasteArea" contenteditable="true" spellcheck="false" tabindex="0" style="border:1px dashed #ccc;padding:1rem;min-height:150px;text-align:center;position:relative;">
  <div class="placeholder-top" contenteditable="false">Arrastra o presiona Ctrl+V</div>
  <div class="placeholder-bottom" contenteditable="false"></div>
</div>
<button id="btnSelectFile" style="display:block;margin:0.5rem auto;padding:0.25rem 0.5rem;height:2rem;font-size:0.875rem;">Seleccionar archivo</button>
<input type="file" id="inputPagoImagen" accept="image/*" style="display:none"/>
<label>Fondo – Periodo:<br>
      <select id="selectPagoFondo">
        <option value="">Seleccione</option>
      </select>
    </label>
    <div style="display:flex;justify-content:flex-end;gap:1rem">
      <button id="btnCancelarPago">Cancelar</button>
      <button id="btnAceptarPago">Aceptar</button>
    </div>
  </div>
</div>

<!-- Overlay “Registrando Pago…” -->
<div id="overlayPagoRegistrando" style="
  visibility: hidden;
  opacity: 0;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  transition: opacity 0.3s ease;
">
  <div class="spinner"></div>
  <div style="color:white; font-size:20px; font-weight:bold; margin-top:20px; text-align:center;">
    Registrando Pago...
  </div>
</div>

<script>
// Funciones para pago de facturas
let currentPagoRow = null;
// Filas seleccionadas cuando se usa el botón "Pagar Facturas" (pago masivo)
let selectedPagoRows = [];
 // Ahora recibe también el RowComponent real
  function showModalPago(data, rowComps) {
    const rowsArray = Array.isArray(rowComps) ? rowComps : [rowComps];
    currentPagoRow = rowsArray[0];
    selectedPagoRows = rowsArray;
    const rowData = data || currentPagoRow.getData();
  // Cargar fondos asociados al sector
  fetch(urlLeerAnticipos)
    .then(res => res.json())
    .then(rows => {
      const sel = document.getElementById("selectPagoFondo");
      sel.innerHTML = '<option value="">Seleccione</option>';
      rows.filter(r => r.Sector && data.Sector && r.Sector.trim().toLowerCase() === data.Sector.trim().toLowerCase())
          .forEach(r => {
            const val = `${r.Fondo}-${r.Periodo}`;
            sel.appendChild(new Option(val, val));
          });
    });
  document.getElementById("inputPagoImagen").value = "";
  document.getElementById("modalPago").style.display = "flex";
}

document.getElementById("btnCancelarPago").onclick = () => {
  // Limpiar campos del modal
  document.getElementById("inputPagoImagen").value = "";
  const sel = document.getElementById("selectPagoFondo");
  sel.innerHTML = '<option value="">Seleccione</option>';
  const pasteArea = document.getElementById("pasteArea");
  pasteArea.innerHTML = '<div class="placeholder-top" contenteditable="false">Arrastra o presiona Ctrl+V</div><div class="placeholder-bottom" contenteditable="false"></div>';
  // Ocultar modal
  document.getElementById("modalPago").style.display = "none";
      // Recargar tabla de pagos para mostrar facturas pendientes y pagadas
      };


</script>


<script>
document.addEventListener("DOMContentLoaded", function(){
  const pasteArea = document.getElementById("pasteArea");
  const fileInput = document.getElementById("inputPagoImagen");
  // Paste support
  pasteArea.addEventListener("paste", function(e){
    e.preventDefault();
    if (e.clipboardData) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();
          const dt = new DataTransfer();
          dt.items.add(blob);
          fileInput.files = dt.files;
          const url = URL.createObjectURL(blob);
          pasteArea.innerHTML = '<img src="'+url+'" style="max-width:100%;height:auto;"/>';
          // hide placeholders
          const top = pasteArea.querySelector(".placeholder-top");
          const bottom = pasteArea.querySelector(".placeholder-bottom");
          if (top) top.style.display = "none";
          if (bottom) bottom.style.display = "none";
          break;
        }
      }
    }
  });
  // Drag & drop support
  pasteArea.addEventListener("dragover", function(e){
    e.preventDefault();
  });
  pasteArea.addEventListener("drop", function(e){
    e.preventDefault();
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      const url = URL.createObjectURL(file);
      pasteArea.innerHTML = '<img src="'+url+'" style="max-width:100%;height:auto;"/>';
      const top = pasteArea.querySelector(".placeholder-top");
      const bottom = pasteArea.querySelector(".placeholder-bottom");
      if (top) top.style.display = "none";
      if (bottom) bottom.style.display = "none";
    }
  });
  // Button to open file selector
  const btn = document.getElementById("btnSelectFile");
  btn.addEventListener("click", function(){
    fileInput.click();
  });
   fileInput.addEventListener("change", function() {
   if (!this.files || !this.files.length) return;
   const file = this.files[0];
   if (!file.type.startsWith("image/")) return;

   // Renderizar preview
   const url = URL.createObjectURL(file);
   pasteArea.innerHTML = `<img src="${url}" style="max-width:100%;height:auto;"/>`;
   // Ocultar placeholders
   pasteArea.querySelector(".placeholder-top")?.remove();
   pasteArea.querySelector(".placeholder-bottom")?.remove();

   // (Opcional) Sincronizar input.files con DataTransfer
   const dt = new DataTransfer();
   dt.items.add(file);
   fileInput.files = dt.files;
});
});
</script>

<script>
// Handler para “Aceptar Pago”
document.getElementById("btnAceptarPago").addEventListener("click", async function() {
  const table = window.tabulatorTable || Tabulator.findTable("#facturas-table")[0];
  // Guardamos la selección ORIGINAL para pago y envío de correos
  const selectedPagoRowsPrev = [...selectedPagoRows];

  try {
    // 1) Mostrar overlay de registro
    const ov = document.getElementById("overlayPagoRegistrando");
    ov.style.visibility = "visible";
    ov.style.opacity    = 1;

    // 2) Validar fondo-período
    const sel          = document.getElementById("selectPagoFondo");
    const fondoPeriodo = sel.value;
    if (!fondoPeriodo) {
      ov.style.opacity = 0;
      setTimeout(() => ov.style.visibility = "hidden", 300);
      return alert("Seleccione un fondo-período.");
    }

    const fechaPago = new Date().toISOString().substr(0,10);

    // 3) Guardar pago local (masivo o individual)
    if (selectedPagoRowsPrev.length > 1) {
      // Pagos masivos
      const filas = selectedPagoRowsPrev.map(r => r.getData().fila);
      await actualizarEstadoMultiple(filas, "Pagada", fondoPeriodo, fechaPago);
      selectedPagoRowsPrev.forEach(r => r.update({
        Estado:    "Pagada",
        Fondo:     fondoPeriodo,
        FechaPago: fechaPago
      }));
      table.deselectRow();
      document.getElementById("btn-pagar-facturas").style.display = "none";
    } else {
      // Pago individual
      const rowComp = currentPagoRow;
      const fila    = rowComp.getData().fila;
      await fetch(urlGuardarFactura, {
        method:  "POST",
        headers: { "Content-Type": "application/json" },
        body:    JSON.stringify({ fila, fondoPeriodo, fechaPago })
      })
      .then(r => r.json())
      .then(j => { if (j.status !== "OK") throw new Error(j.mensaje || "Error al guardar"); });
      rowComp.update({
        Estado:    "Pagada",
        Fondo:     fondoPeriodo,
        FechaPago: fechaPago
      });
    }


    // 5) Preparar datos para el correo
    const filas = selectedPagoRowsPrev.map(r => r.getData()["Numero de Factura"]);
    const identidades = selectedPagoRowsPrev.map(r => r.getData().Identidad);
    const montos      = selectedPagoRowsPrev.map(r => r.getData()["Total Gastado"]);

    // 6) Leer imágenes y convertir a base64
    const images = [];
    const inputImg = document.getElementById("inputPagoImagen");
	  
    console.log('[Pago] Ficheros seleccionados:', inputImg.files.length, inputImg.files);
	  
    for (const file of inputImg.files) {
      const dataURL = await new Promise(res => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result.split(',')[1]);
        fr.readAsDataURL(file);
      });
      images.push({ filename: file.name, mime: file.type, data: dataURL });
    }

    // 7) Enviar payload al Web App de Apps Script
    const mailPayload = {
      filas,
      identidades,
      montos,
      fondoPeriodo,
      fechaPago,
      images
    };
    console.log('[Pago] Enviando correo con payload:', mailPayload);

    const mailResp = await fetch(Envio_Correos, {
      method:  'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body:    JSON.stringify(mailPayload)
    });
    console.log('[Pago] Respuesta fetch status:', mailResp.status, mailResp.statusText);

    const mailResult = await mailResp.json();
	
    console.log('[Pago] Respuesta fetch body:', mailResult);

    if (mailResult.status !== 'OK') {
      throw new Error(mailResult.message || 'Error enviando notificaciones');
    }

    alert('Pago registrado y correos enviados correctamente.');

  } catch (err) {
    console.error("Error en proceso de pago o envío:", err);
    alert("Error: " + err.message);
  } finally {
    // 8) Ocultar overlay al finalizar (éxito o error)
    const ov = document.getElementById("overlayPagoRegistrando");
    ov.style.opacity = 0;
    setTimeout(() => ov.style.visibility = "hidden", 300);
  }
    // 8) Limpiar UI local (AHORA SÍ DESPUÉS de enviar el correo)
  selectedPagoRows = [];
   document.getElementById("inputPagoImagen").value = "";
   const sel2 = document.getElementById("selectPagoFondo");
    sel2.innerHTML = '<option value="">Seleccione</option>';
    const pa2 = document.getElementById("pasteArea");
    pa2.innerHTML =
      '<div class="placeholder-top" contenteditable="false">Arrastra o presiona Ctrl+V</div>' +
      '<div class="placeholder-bottom" contenteditable="false"></div>';
    document.getElementById("modalPago").style.display = "none";
    updateCountersPago();
});

</script>

</body>
</html>
