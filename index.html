<!DOCTYPE html>

<html lang="es">
<head>
<style>
  /* Global button styles for mobile friendliness */
  button {
    padding: 1rem 1.5rem !important;
    font-size: 1.1rem !important;
    border-radius: 0.5rem !important;
    margin-bottom: 1rem !important;
  }

  /* Navigation buttons spacing */
  .nav-buttons button + button {
    margin-left: 0.5rem !important;
  }

  /* Signature buttons layout */
  .signature-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0 !important;
  }
  .signature-buttons button {
    flex: 1;
    margin: 0 !important;
  }

  /* Download confirmation modal readability */
  #downloadModal .modal-content {
    padding: 2rem !important;
  }
  #downloadModal .modal-content p {
    font-size: 1.1rem !important;
    line-height: 1.5 !important;
  }
  #downloadModal .modal-content button {
    padding: 1rem 1.5rem !important;
    font-size: 1.1rem !important;
    flex: 1 !important;
    margin: 0.5rem !important;
  }
</style>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Control de Combustible</title>
<style>
  /* Responsive layout */
  .form-steps {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  @media (max-width: 640px) {
    .form-steps {
      grid-template-columns: 1fr;
    }
  }

  /* Tap targets and spacing */
  input, select, textarea, button {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem !important;
    font-size: 1.1rem;
    border-radius: 0.5rem;
    box-sizing: border-box;
  }

  /* Full-screen camera preview */
  .camera-preview {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none; /* toggled on capture */
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .camera-preview.active {
    display: flex;
  }
  .camera-preview .overlay-controls {
    position: absolute;
    bottom: 1rem;
    width: 100%;
    display: flex;
    justify-content: space-around;
  }

  button { margin: 0 0 1rem !important; }
</style>
<style>
.photo-buttons {
  display: flex;
  gap: 1rem;
  padding: 0.75rem;
}
.photo-buttons button {
  flex: 1;
  margin: 0 !important;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Roboto&amp;display=swap" rel="stylesheet"/>
<style>
    /* Animaciones para transiciones */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Global page styles */
    /* Global page styles */
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .formulario {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover { background-color: #0056b3; }
    #mensaje_cargando {
      text-align: center;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 15px;
    }

    /* Styles for preview pages to mimic Letter dimensions */
    @page {
      size: letter;
      margin: 1.27cm;
    }
    .page {
      background: white;
      width: 216mm;           /* Carta: 8.5in = 216mm */
      height: 279mm;          /* Carta: 11in = 279mm */
      margin: 20px auto;      /* Separación entre páginas */
      padding: 1.27cm;        /* Márgenes internos de 1.27cm */
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;          /* Contenedor flex para extender contenido */
      flex-direction: column; /* Organizar header y contenido en columna */
      overflow: hidden;       /* Ocultar desbordes */
      page-break-after: always;
    }
    @media print {
      .page { page-break-after: always; margin: 0; box-shadow: none; }
      body { margin: 0; }
    }
    .format-header {
      text-align: center;
      font-weight: bold;
      border: 1px solid #000;
      padding: 5px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .preview-box {
      display: flex;
      gap: 10px; /* Gap between columns */
      flex: 1; /* Fill vertical space under header */
    }
    .invoice-box {
      flex: 0 0 55%; /* Width ratio for invoice box */
      height: 100%;  /* Fill parent height */
    }
    .summary-box {
      flex: 0 0 45%; /* Width ratio for summary box */
      height: 100%;  /* Fill parent height */
    }
    .invoice-box .placeholder {
      width: 100%; height: 100%;
      border: 2px dashed #666;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    .summary-box table {
      width: 100%; height: 100%;
      border-collapse: collapse;
    }
    .summary-box td:first-child { width: 30%; }
    .summary-box td:nth-child(2) { width: 70%; }
    .summary-box td {
      font-size: 14px;
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    /* Adjust page 2 to fill remaining height */
    #photos_table_container {
      flex: 1;               /* Fill vertical space under header */
      display: flex;
      flex-direction: column;
    }
    .photos-table {
      flex: 1;               /* Fill all available height */
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .photos-table td {
      border: 1px solid #ccc;
      padding: 4px;
      vertical-align: top;
      overflow: hidden;
      width: 45%;
      height: 300px; /* Ajustado a 300px según pedido */
    }
    .photos-table td[rowspan="2"] {
      width: 55%;
      height: 530px; /* Ajustado a 530px según pedido */
    }
    .photos-table img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .photo-title { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
    .photo-footer { font-size: 14px; font-weight: bold; text-align: left; padding: 6px; }
    /* Pie de página: altura fija distinta de las fotos */
    .photos-table tr:last-child td {
      height: 20px; /* Ajustado a 20px para el pie de página */ /* Ajusta este valor para cambiar el largo del pie de página */
    }
      /* Ensure preview content matches Letter width */
    html, body { box-sizing: border-box; }
    #preview_contenido {
      width: 216mm;       /* Match page width for PDF capture */
      margin: 0 auto;
      overflow: visible;
    }
  </style>
<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<style>
#toast-alert {
  visibility: hidden;
  min-width: 280px;
  background-color: #c62828;
  color: white;
  text-align: center;
  border-radius: 5px;
  padding: 14px 28px;
  position: fixed;
  z-index: 9999;
  left: 50%;
  bottom: 30px;
  font-size: 16px;
  transform: translateX(-50%);
}
#toast-alert.show {
  visibility: visible;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}
@keyframes fadein {
  from { bottom: 10px; opacity: 0; }
  to   { bottom: 30px; opacity: 1; }
}
@keyframes fadeout {
  from { bottom: 30px; opacity: 1; }
  to   { bottom: 10px; opacity: 0; }
}
</style>
<div id="toast-alert">⚠️ Hay campos obligatorios sin completar.</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script>
  var generatedPDF = null;
  var generatedFilename = '';
</script>
<style>
@keyframes fadeOutUp {
  from { opacity: 1; transform: translateY(0); }
  to   { opacity: 0; transform: translateY(-20px); }
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fade-out-up {
  animation: fadeOutUp 0.3s forwards;
}
.fade-in-down {
  animation: fadeInDown 0.3s ease-out forwards;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>
<style>
    .custom-header {
      display: table;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    .custom-header > div {
      display: table-cell;
      border: 1px solid #000;
      vertical-align: middle;
      padding: 8px;
    }
    .custom-header .header-left img {
      max-height: 60px;
      display: block;
    }
    .custom-header .header-center h1 {
      font-size: 18px;
      margin: 0;
      text-align: center;
    }
      width: 100%;
      border-collapse: collapse;
    }
      border: 1px solid #000;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
<style>
  .header-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  .header-table td {
    border: 1px solid #000;
    padding: 4px;
    vertical-align: middle;
  }
  .header-table img {
    max-height: 60px;
    display: block;
  }
  .header-table .title-cell {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
  }
</style>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<style>
@keyframes spinner {
  to { transform: rotate(360deg); }
}
.circular-spinner {
  width: 3rem;
  height: 3rem;
  border: 0.4rem solid #ddd;
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spinner .75s linear infinite;
  margin: 0 auto;
}

#mensajeCarga {
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  margin: 1rem 0;
}

#mensajeCarga .loading-text {
  font-weight: bold;
  margin-top: 0.5rem;
}
</style>
<style>
@keyframes spinner {
  to { transform: rotate(360deg); }
}
#overlayCambios {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
#overlayCambios .spinner {
  width: 4rem;
  height: 4rem;
  border: 0.5rem solid #ddd;
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spinner 0.75s linear infinite;
  margin-bottom: 1rem;
}
#overlayCambios .text {
  font-size: 1.25rem;
  color: white;
  font-weight: bold;
}
</style>
<script>
function actualizarVisibilidadBotonesMasivos() {
  const checks = document.querySelectorAll("#tablaFacturas input[type=checkbox]:checked");
  const cont = document.getElementById("accionesMasivas");
  if (cont) cont.style.display = (checks.length >= 2) ? "block" : "none";
}
</script>
<style>
#countersContainer {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  justify-content: center;
}
.counter-box {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
  padding: 0.5rem 1rem;
  text-align: center;
  min-width: 8rem;
}
.counter-box .label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.25rem;
}
.counter-box .value {
  font-size: 1.25rem;
}
</style>
<style>
#countersRow, #filtersRow {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-bottom: 1rem;
}
#filtersRow label {
  white-space: nowrap;
  margin-right: 0.5rem;
}
#filtersRow select,
#filtersRow input[type="text"] {
  width: 200px;
  border-radius: 0.375rem;
  border: 1px solid #cbd5e0;
  padding: 0.5rem;
  background: #f7fafc;
}
.counter-box {
  background: #edf2f7;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  text-align: center;
}
.counter-box .label {
  display: block;
  font-size: 0.875rem;
  color: #4a5568;
}
.counter-box .value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #2d3748;
}
</style>
<style>
  /* Botón volver más compacto verticalmente */
  #seccionRevisionFacturas > button {
    padding: 0.25rem 1rem !important;
  }
  /* Contadores: menos alto */
  .counter-box {
    padding: 0.25rem 1rem !important;
  }
  /* Tabla: celdas más compactas */
  #tablaFacturas th,
  #tablaFacturas td {
    padding: 0.25rem 0.5rem !important;
  }
</style>
</head>
<body>
<div id="overlayCambios">
<div class="spinner"></div>
<div class="text">Registrando Cambios...</div>
</div>
<div id="menuPrincipal" style="display: flex; flex-direction: column; align-items: center; margin-top: 50px;">
<h2>Seleccione una opción</h2>
<button onclick="mostrarSeccion('reportarFactura')" style="width: 250px; margin: 10px; padding: 10px;">📥 Reportar Factura</button>
<button onclick="mostrarSeccion('revisionFacturas')" style="width: 250px; margin: 10px; padding: 10px;">🔍 Revisión de Facturas</button>
<button onclick="mostrarSeccion('registrarAnticipo')" style="width: 250px; margin: 10px; padding: 10px;">💵 Registrar Anticipo</button>
<button onclick="cargarPagoFacturas()" style="width: 250px; margin: 10px; padding: 10px;">💳 Pago de Facturas</button></div><div id="seccionPagoFacturas" style="display: none;">
<div style="margin-bottom: 10px; text-align: right;">
<button class="boton" id="btnAgruparColaborador" style="display:inline-block;">Agrupar por colaborador</button>
</div><button onclick="mostrarSeccion('menuPrincipal')" style="width:auto; padding:0.5em 1em; margin-bottom:1em;">🔙 Regresar al Menú Principal</button><h2>Pago de Facturas</h2>
<div id="countersContainer">
<div class="counter-box"><span class="label">Facturas Pendientes</span><span class="value" id="contadorPendientes">0</span></div>
<div class="counter-box"><span class="label">Facturas Pagadas</span><span class="value" id="contadorPagadas">0</span></div>
<div class="counter-box"><span class="label">Total Pendiente de Pagar</span><span class="value" id="totalRevisada">L 0.00</span></div>
<div class="counter-box"><span class="label">Total Pagado</span><span class="value" id="totalPagada">L 0.00</span></div>
</div>
<div id="filtersRow" style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
<label>Filtrar por sector:
    <select id="filtroSectorPago"><option value="Todos">Todos</option></select>
</label>
<label>Filtrar por estado:
    <select id="filtroEstadoPago">
<option value="Todos">Todos</option>
<option value="Revisada">Revisada</option>
<option value="Pagada">Pagada</option>
</select>
</label>
<label>Filtrar Nº de Factura:
    <input id="filtroNumeroPago" placeholder="Buscar factura…" style="padding:0.5rem;" type="text"/>
</label>
<label>Rango de Fechas:
    <input id="filtroFechaPago" placeholder="Selecciona rango" style="padding:0.5rem;" type="text"/>
</label>
</div>
<style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    </style>
<div style="max-height: 500px; overflow: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px;"><div id="facturas-table" style="height:500px;"></div></div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="seccionReportarFactura" style="display: none;">
<div id="notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#28a745; color:white; padding:15px 30px; border-radius:5px; opacity:0; transition:opacity 0.5s ease-in-out; z-index:1000;">Información enviada correctamente</div>
<div id="mensaje_cargando" style="display:none;">Cargando información, por favor espere...</div>
<div class="formulario" id="formulario_contenido" style="display:none;">
<h2>Reporte de Gasto de Combustible</h2>
<datalist id="placas"></datalist>
<div class="paso" id="paso1" style="display:block;"><label for="sector">Seleccionar Sector:</label><span class="error-msg" id="error_sector" style="color:red; display:none;">(Campo obligatorio)</span><select id="sector"><option value="">Seleccione un sector</option></select><label for="placa">Seleccionar Placa del Vehículo:</label><span class="error-msg" id="error_placa" style="color:red; display:none;">(Campo obligatorio)</span><input autocomplete="off" id="placa" list="placas" placeholder="Escribe o selecciona una placa" type="text"/><label for="proceso">Proceso:</label><span class="error-msg" id="error_proceso" style="color:red; display:none;">(Campo obligatorio)</span><select id="proceso"><option value="">Seleccione un proceso</option></select><label for="nombre">Nombre Completo:</label><span class="error-msg" id="error_nombre" style="color:red; display:none;">(Campo obligatorio)</span><input id="nombre" required="" type="text"/><label for="identidad">No. Identidad:</label><span class="error-msg" id="error_identidad" style="color:red; display:none;">(Campo obligatorio)</span><input id="identidad" maxlength="15" oninput="maskIdentidad(this)" required="" type="text"/><label for="total">Total Gastado (L):</label><span class="error-msg" id="error_total" style="color:red; display:none;">(Campo obligatorio)</span><input id="total" step="0.01" type="number"/><label for="litros">Litros Consumidos:</label><span class="error-msg" id="error_litros" style="color:red; display:none;">(Campo obligatorio)</span><input id="litros" step="0.01" type="number"/><label for="motivo">Motivo del Llenado:</label><span class="error-msg" id="error_motivo" style="color:red; display:none;">(Campo obligatorio)</span><textarea id="motivo" rows="3"></textarea><label for="fecha">Fecha:</label><span class="error-msg" id="error_fecha" style="color:red; display:none;">(Campo obligatorio)</span><input class="flatpickr-input" id="fecha" name="fecha" placeholder="Selecciona fecha" readonly="" type="text"/><label for="horas">Horas de Viaje:</label><input id="horas" type="text"/><label for="km">Km Actual del Vehículo:</label><span class="error-msg" id="error_km" style="color:red; display:none;">(Campo obligatorio)</span><input id="km" type="number"/><label for="nombre_comercio">Nombre del comercio:</label><span class="error-msg" id="error_nombre_comercio" style="color:red; display:none;">(Campo obligatorio)</span><input id="nombre_comercio" placeholder="Nombre del comercio" type="text"/><label for="factura">Número de Factura:</label><span class="error-msg" id="error_factura" style="color:red; display:none;">(Campo obligatorio)</span><input id="factura" oninput="maskFactura(this)" type="text"/><div><button onclick="validarYVerificarDuplicado();" type="button">Siguiente</button></div></div><div class="paso" id="paso2" style="display:none;;text-align:center;"><label for="foto_tablero_antes">Fotografía Tablero Antes:</label><img alt="Ejemplo de fotografía" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Tablero%20antes%20de%20llenado.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_tablero_antes" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_tablero_antes')" style=" margin: 5px" type="button">Tomar Fotografía</button><button onclick="abrirGaleria('foto_tablero_antes')" style=" margin: 5px" type="button">Subir desde Galería</button><div class="preview" id="preview_foto_tablero_antes"></div><div><button onclick="mostrarPaso(1)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_tablero_antes')){siguientePaso(3);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_tablero_antes" type="file"/></div><div class="paso" id="paso3" style="display:none;;text-align:center;"><label for="foto_bomba">Fotografía Bomba en 0:</label><img alt="Ejemplo de fotografía" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Bomba%20en%20cero.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_bomba" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_bomba')" style=" margin: 5px" type="button">Tomar Fotografía</button><button onclick="abrirGaleria('foto_bomba')" style=" margin: 5px" type="button">Subir desde Galería</button><div class="preview" id="preview_foto_bomba"></div><div><button onclick="mostrarPaso(2)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_bomba')){siguientePaso(4);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_bomba" type="file"/></div><div class="paso" id="paso4" style="display:none;;text-align:center;"><label for="foto_frontal">Fotografía Frontal del Vehículo o VIN con Vehículo:</label><img alt="Ejemplo de fotografía" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Vista%20Frontal.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_frontal" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_frontal')" style=" margin: 5px" type="button">Tomar Fotografía</button><button onclick="abrirGaleria('foto_frontal')" style=" margin: 5px" type="button">Subir desde Galería</button><div class="preview" id="preview_foto_frontal"></div><div><button onclick="mostrarPaso(3)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_frontal')){siguientePaso(5);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_frontal" type="file"/></div><div class="paso" id="paso5" style="display:none;;text-align:center;"><label for="foto_bomba_llenado">Fotografía Bomba Llena:</label><img alt="Ejemplo de fotografía" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Bomba%20llena.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_bomba_llenado" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_bomba_llenado')" style=" margin: 5px" type="button">Tomar Fotografía</button><button onclick="abrirGaleria('foto_bomba_llenado')" style=" margin: 5px" type="button">Subir desde Galería</button><div class="preview" id="preview_foto_bomba_llenado"></div><div><button onclick="mostrarPaso(4)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_bomba_llenado')){siguientePaso(6);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_bomba_llenado" type="file"/></div><div class="paso" id="paso6" style="display:none;;text-align:center;"><input accept="image/*" hidden="True" id="foto_despues" type="file"/><label for="foto_despues">Fotografía Tablero Después de Llenado:</label><img alt="Ejemplo de fotografía" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Tablero%20antes%20de%20llenado.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_despues" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_despues')" style=" margin: 5px" type="button">Tomar Fotografía</button><button onclick="abrirGaleria('foto_despues')" style=" margin: 5px" type="button">Subir desde Galería</button><div class="preview" id="preview_foto_despues"></div><div><button onclick="mostrarPaso(5)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_despues')){siguientePaso(7);}" style=" margin: 5px" type="button">Siguiente</button></div></div><div class="paso" id="paso7" style="display:none; text-align: center;"><h2>Fotografía de la Factura:</h2><img alt="Ejemplo factura" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Factura.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><input accept="image/*" hidden="True" id="foto_factura" type="file"/><button onclick="activarCamara('foto_factura')" style=" margin: 5px" type="button">Tomar Fotografía</button><button onclick="abrirGaleria('foto_factura')" style=" margin: 5px" type="button">Subir desde Galería</button><div class="preview" id="preview_foto_factura"></div>
<div class="nav-buttons" style="display:flex; justify-content:center; gap:0.5rem;  margin-top: 20px;">
<button onclick="mostrarPaso(6)" style="margin: 5px;" type="button">Anterior</button>
<button id="guardar_reporte" style="margin: 5px;" type="button">Guardar Reporte</button>
</div>
</div></div>
<div id="preview_contenido" style="display:none;">
<div class="page" id="preview_page1">
<table class="header-table">
<tr>
<td rowspan="3" style="width:100px;">
<img alt="Logo UTCD" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/refs/heads/main/imagenes/Logo.png"/>
</td>
<td class="title-cell" rowspan="3">
      DETALLE DE LA FACTURA DE COMBUSTIBLE
    </td>
<td>Código</td>
<td>CLS-PAU-F-19</td>
</tr>
<tr>
<td>Versión</td>
<td>1</td>
</tr>
<tr>
<td>Fecha</td>
<td>20/5/2025</td>
</tr>
</table>
<div class="preview-box">
<div class="invoice-box">
<div class="placeholder" id="placeholder_box">Pegar Factura Original en este Espacio</div>
</div>
<div class="summary-box" id="summary_box"></div>
</div>
</div>
<div class="page" id="preview_page2">
<h3 class="format-header">FOTOGRAFÍAS</h3>
<div id="photos_table_container"></div>
</div>
<div class="page" id="preview_page3">
<h3 class="format-header">FACTURA ORIGINAL</h3>
<div class="invoice-box">
<img id="factura_only_img" style="width:auto; height:800px; object-fit:contain; display:block; margin:0 auto;"/>
</div>
</div>
<button id="enviar_reporte">Enviar Reporte</button>
<button id="modificar_reporte">Modificar Reporte</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Mostrar previews para cada campo de imagen
['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener('change', () => {
      if (input.files && input.files.length > 0) {
        const archivo = input.files[0];
        
        // Validar antigüedad de la foto (no mayor a 48 horas)
        const fileDate = new Date(archivo.lastModified);
        if (Date.now() - fileDate.getTime() > 48 * 3600 * 1000) {
          alert('La fotografía debe ser reciente (no mayor a 48 horas).');
          input.value = '';
          return;
        }
        const url = URL.createObjectURL(archivo);
        const contenedor = document.getElementById('preview_' + id);
        if (contenedor) {
          contenedor.innerHTML = `<img src="${url}" style="max-width:100%; max-height:300px;">`;
        }
      }
    });
      actualizarVisibilidadBotonesMasivos();
  }
});


function validarFormulario() {
  let valido = true;
  const campos = ['sector', 'placa', 'proceso', 'nombre', 'identidad', 'total', 'litros', 'motivo', 'fecha', 'km', 'nombre_comercio', 'factura', 'foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'];

  campos.forEach(id => {
    const campo = document.getElementById(id);
    const error = document.getElementById("error_" + id);
    if (campo && (!campo.value || campo.value.trim() === "")) {
      if (error) error.style.display = "inline";
      valido = false;
    } else {
      if (error) error.style.display = "none";
    }
  });

  if (!valido) {
    const toast = document.getElementById("toast-alert");
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }
  return valido;
}

</script>
<script>
    
  // Máscara para No. Identidad: formato ####-####-#####
  function maskIdentidad(el) {
    let v = el.value.replace(/\D/g, '');
    v = v.slice(0, 13);
    if (v.length > 8) {
      v = v.replace(/(\d{4})(\d{4})(\d+)/, '$1-$2-$3');
    } else if (v.length > 4) {
      v = v.replace(/(\d{4})(\d+)/, '$1-$2');
    }
    el.value = v;
  }

  // Máscara para Número de Factura: formato ###-###-##-#####
  function maskFactura(el) {
    // Solo dígitos
    let v = el.value.replace(/\D/g, '');
    // 1er tramo (0–3 dígitos)
    if (v.length <= 3) {
      el.value = v;
    }
    // 2º tramo (4–6 dígitos)
    else if (v.length <= 6) {
      el.value = `${v.slice(0,3)}-${v.slice(3)}`;
    }
    // 3er tramo (7–8 dígitos)
    else if (v.length <= 8) {
      el.value = `${v.slice(0,3)}-${v.slice(3,6)}-${v.slice(6)}`;
    }
    // Resto (9+ dígitos)
    else {
      el.value = `${v.slice(0,3)}-${v.slice(3,6)}-${v.slice(6,8)}-${v.slice(8)}`;
    }
  }

  /* URLs de servicios Google Apps Script */
  const urlVehiculos = "https://script.google.com/macros/s/AKfycbwyUE5huHIdOR9SM3IapgIrwvHBCXYHOf9ptj47fXyW-0e1kIj-gK3SGV4czPNa2Wp-wg/exec";
  const urlProcesos = "https://script.google.com/macros/s/AKfycbxPtMWO-2meogbiHuw8FbbnY0u-rIq70gvtLNlHkr0YS0-JD3N23X6IcyhMld53zD66nw/exec";

  let vehiculos = [], procesos = [];

  /**
   * Carga sectores y placas de la hoja "Vehiculos".
   * Popula <select id="sector"> y muestra el formulario.
   */
  function cargarDatosVehiculos() {
    fetch(urlVehiculos)
      .then(res => res.json())
      .then(data => {
        vehiculos = data;
        const sel = document.getElementById('sector');
        // Eliminar duplicados usando Set
        [...new Set(data.map(x => x.Sector))].forEach(s => sel.add(new Option(s, s)));
        // Agregar sector CORPORATIVO manualmente
        sel.add(new Option('CORPORATIVO', 'CORPORATIVO'));
        document.getElementById('mensaje_cargando').style.display = 'none';
        // Animar formulario al aparecer
        const formEl = document.getElementById('formulario_contenido');
        formEl.style.display = 'block';
        formEl.classList.add('fade-in-up');
        mostrarPaso(1);
        document.getElementById('formulario_contenido').style.display = 'block';
      })
      .catch(err => {
        document.getElementById('mensaje_cargando').innerText = 'Error al cargar los datos.';
      });
      actualizarVisibilidadBotonesMasivos();
  }

  /**
   * Carga procesos de la hoja "Procesos".
   * Popula <select id="proceso">.
   */
  function cargarProcesos() {
    fetch(urlProcesos)
      .then(res => res.json())
      .then(data => {
        procesos = data.map(item => item.Proceso);
        const sel = document.getElementById('proceso');
        sel.innerHTML = '<option value="">Seleccione un proceso</option>';
        procesos.forEach(p => sel.add(new Option(p, p)));
      })
      .catch(err => console.error('Error al cargar procesos:', err));
  }

  // Al cambiar sector, filtrar placas correspondientes
  document.getElementById('sector').addEventListener('change', function() {
    const dataList = document.getElementById('placas');
    dataList.innerHTML = '';
    // Si es CORPORATIVO, mostrar todas las placas
    const lista = (this.value === 'CORPORATIVO') ? vehiculos : vehiculos.filter(v => v.Sector === this.value);
    lista.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.PLACA;
      dataList.appendChild(opt);
    });
    // Limpiar el input de placa al cambiar el sector
    document.getElementById('placa').value = '';
    // Limpiar proceso
    document.getElementById('proceso').value = '';
  });

  // Verificar duplicado antes de generar preview
  async function verificarDuplicado(placa, fecha, factura) {
    try {
      const response = await fetch("/api/guardar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ validarDuplicado: true, Placa: placa, Fecha: fecha, NumeroFactura: factura })
      });
      const result = await response.json();
      return result.duplicado || false;
    } catch (err) {
      return false;
    }
  }

  function imagenesCompletas() {
    const campos = [
      'foto_tablero_antes',
      'foto_bomba',
      'foto_despues',
      'foto_bomba_llenado',
      'foto_frontal',
      'foto_factura'
    ];
    for (const id of campos) {
      const input = document.getElementById(id);
      if (!input || !input.files || input.files.length === 0) {
        return false; // Falta alguna imagen
      }
    }
    return true; // Todas las imágenes están presentes
  }


  function validarImagenPaso(id) {
    const input = document.getElementById(id);
    const error = document.getElementById("error_" + id);

    if (!input.files || input.files.length === 0) {
      error.style.display = "inline";
      const toast = document.getElementById("toast-alert");
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
      return false;
    } else {
      error.style.display = "none";
      return true;
    }
  }

  // Funciones para manejar la cámara
  let currentStream; // Para guardar el stream de la cámara
  let currentPhotoFieldId; // Para saber qué campo de foto estamos llenando

  function activarCamara(photoFieldId) {
    currentPhotoFieldId = photoFieldId;
    const cameraPreview = document.querySelector('.camera-preview');
    const video = document.createElement('video');
    video.autoplay = true;
    video.style.width = '100%';
    video.style.height = '100%';
    video.style.objectFit = 'contain';

    cameraPreview.innerHTML = ''; // Limpiar cualquier contenido previo
    cameraPreview.appendChild(video);
    
    // Controles de la cámara
    const controls = document.createElement('div');
    controls.className = 'overlay-controls';
    controls.innerHTML = `
      <button onclick="tomarFoto()">Capturar</button>
      <button onclick="cerrarCamara()">Cerrar</button>
    `;
    cameraPreview.appendChild(controls);

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }) // Usa la cámara trasera si está disponible
      .then(stream => {
        currentStream = stream;
        video.srcObject = stream;
        cameraPreview.classList.add('active');
      })
      .catch(err => {
        alert('No se pudo acceder a la cámara. Asegúrate de dar permisos.');
        console.error("Error al acceder a la cámara: ", err);
      });
  }

  function tomarFoto() {
    const video = document.querySelector('.camera-preview video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Convertir a Blob y luego a File
    canvas.toBlob(blob => {
      const file = new File([blob], `foto_${currentPhotoFieldId}_${Date.now()}.jpg`, { type: 'image/jpeg' });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      document.getElementById(currentPhotoFieldId).files = dataTransfer.files;

      // Actualizar la vista previa
      const url = URL.createObjectURL(file);
      const contenedor = document.getElementById('preview_' + currentPhotoFieldId);
      if (contenedor) {
        contenedor.innerHTML = `<img src="${url}" style="max-width:100%; max-height:300px;">`;
      }
      cerrarCamara();
    }, 'image/jpeg');
  }

  function cerrarCamara() {
    const cameraPreview = document.querySelector('.camera-preview');
    cameraPreview.classList.remove('active');
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
  }

  function abrirGaleria(photoFieldId) {
    currentPhotoFieldId = photoFieldId;
    document.getElementById(photoFieldId).click(); // Simula el click en el input file oculto
  }

  const sections = {
    menuPrincipal: 'menuPrincipal',
    reportarFactura: 'seccionReportarFactura',
    revisionFacturas: 'seccionRevisionFacturas', // Asumiendo que existe
    registrarAnticipo: 'seccionRegistrarAnticipo', // Asumiendo que existe
    pagoFacturas: 'seccionPagoFacturas'
  };

  function mostrarSeccion(sectionId) {
    for (let key in sections) {
      const section = document.getElementById(sections[key]);
      if (section) {
        section.style.display = 'none';
        section.classList.remove('fade-in-down'); // Quita la clase para evitar animaciones dobles
      }
    }
    const targetSection = document.getElementById(sections[sectionId]);
    if (targetSection) {
      targetSection.style.display = 'block';
      targetSection.classList.add('fade-in-down');
    }
  }

  // Funciones para navegación de pasos del formulario
  let currentStep = 1;
  const totalSteps = 7; // Ajusta esto si añades/quitas pasos

  function mostrarPaso(step) {
    // Oculta todos los pasos
    for (let i = 1; i <= totalSteps; i++) {
      const paso = document.getElementById('paso' + i);
      if (paso) paso.style.display = 'none';
    }
    // Muestra el paso actual
    const currentPaso = document.getElementById('paso' + step);
    if (currentPaso) {
      currentPaso.style.display = 'block';
      currentPaso.classList.add('fade-in-up'); // Aplica animación al mostrar
    }
    currentStep = step;
  }

  function siguientePaso(step) {
    mostrarPaso(step);
  }

  function anteriorPaso() {
    if (currentStep > 1) {
      mostrarPaso(currentStep - 1);
    } else {
      mostrarSeccion('menuPrincipal'); // Vuelve al menú si estás en el primer paso
    }
  }

  // Asignar listeners para botones de navegación del formulario
  document.getElementById('guardar_reporte').addEventListener('click', enviarDatos);
  document.getElementById('enviar_reporte').addEventListener('click', enviarDatos);
  document.getElementById('modificar_reporte').addEventListener('click', () => mostrarPaso(1));


  async function validarYVerificarDuplicado() {
    if (!validarFormulario()) {
      return; // Detener si hay campos obligatorios vacíos
    }

    const placa = document.getElementById('placa').value;
    const fecha = document.getElementById('fecha').value;
    const factura = document.getElementById('factura').value;

    mostrarOverlay("Verificando duplicados...");
    const duplicado = await verificarDuplicado(placa, fecha, factura);
    ocultarOverlay();

    if (duplicado) {
      alert("Error: Ya existe un registro con la misma Placa, Fecha y Número de Factura. Por favor, revise los datos.");
      return;
    }

    generarVistaPrevia();
    mostrarSeccion('preview_contenido');
  }

  function showToast(message, type = 'success') {
    const toast = document.getElementById("toast-alert");
    toast.textContent = message;
    toast.style.backgroundColor = type === 'success' ? '#28a745' : '#c62828';
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }

  function mostrarOverlay(message) {
    const overlay = document.getElementById('overlayCambios');
    const textElement = overlay.querySelector('.text');
    textElement.textContent = message;
    overlay.style.display = 'flex';
  }

  function ocultarOverlay() {
    document.getElementById('overlayCambios').style.display = 'none';
  }

  // Enviar datos al Google Apps Script
  async function enviarDatos() {
    mostrarOverlay("Guardando Reporte...");

    const formData = new FormData();
    formData.append('action', 'guardarReporte');
    formData.append('Sector', document.getElementById('sector').value);
    formData.append('Placa', document.getElementById('placa').value);
    formData.append('Proceso', document.getElementById('proceso').value);
    formData.append('NombreCompleto', document.getElementById('nombre').value);
    formData.append('Identidad', document.getElementById('identidad').value);
    formData.append('TotalGastado', document.getElementById('total').value);
    formData.append('LitrosConsumidos', document.getElementById('litros').value);
    formData.append('MotivoLlenado', document.getElementById('motivo').value);
    formData.append('Fecha', document.getElementById('fecha').value);
    formData.append('HorasViaje', document.getElementById('horas').value);
    formData.append('KmActual', document.getElementById('km').value);
    formData.append('NombreComercio', document.getElementById('nombre_comercio').value);
    formData.append('NumeroFactura', document.getElementById('factura').value);

    // Añadir las imágenes al formData
    ['foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'].forEach(id => {
      const input = document.getElementById(id);
      if (input && input.files && input.files[0]) {
        formData.append(id, input.files[0]);
      }
    });

    try {
      const response = await fetch("/api/guardar", {
        method: "POST",
        body: formData
      });
      const result = await response.json();

      ocultarOverlay();

      if (result.success) {
        showToast("Reporte guardado correctamente", 'success');
        // Limpiar formulario y volver al menú principal
        setTimeout(() => {
          document.getElementById('formulario_contenido').reset(); // Resetear el formulario
          // Limpiar las previsualizaciones de imágenes
          ['preview_foto_tablero_antes', 'preview_foto_bomba', 'preview_foto_despues', 'preview_foto_bomba_llenado', 'preview_foto_frontal', 'preview_foto_factura'].forEach(id => {
            const previewEl = document.getElementById(id);
            if(previewEl) previewEl.innerHTML = '';
          });
          // Limpiar los inputs de tipo file (requiere un poco más de manipulación)
          ['foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'].forEach(id => {
            const inputEl = document.getElementById(id);
            if (inputEl) inputEl.value = ''; // Esto limpia la selección del archivo
          });

          mostrarSeccion('menuPrincipal');
        }, 1000);
      } else {
        showToast("Error al guardar el reporte: " + (result.error || "Desconocido"), 'error');
      }
    } catch (error) {
      ocultarOverlay();
      showToast("Error de conexión al enviar el reporte.", 'error');
      console.error('Error:', error);
    }
  }


  function generarVistaPrevia() {
    const data = {
      sector: document.getElementById('sector').value,
      placa: document.getElementById('placa').value,
      proceso: document.getElementById('proceso').value,
      nombre: document.getElementById('nombre').value,
      identidad: document.getElementById('identidad').value,
      total: parseFloat(document.getElementById('total').value).toLocaleString('es-HN', {minimumFractionDigits: 2}),
      litros: parseFloat(document.getElementById('litros').value).toLocaleString('es-HN', {minimumFractionDigits: 2}),
      motivo: document.getElementById('motivo').value,
      fecha: document.getElementById('fecha').value,
      horas: document.getElementById('horas').value,
      km: document.getElementById('km').value,
      nombre_comercio: document.getElementById('nombre_comercio').value,
      factura: document.getElementById('factura').value
    };

    // Populate summary box
    const summaryBox = document.getElementById('summary_box');
    summaryBox.innerHTML = `
      <table>
        <tr><td>SECTOR:</td><td>${data.sector}</td></tr>
        <tr><td>PLACA:</td><td>${data.placa}</td></tr>
        <tr><td>PROCESO:</td><td>${data.proceso}</td></tr>
        <tr><td>COLABORADOR:</td><td>${data.nombre}</td></tr>
        <tr><td>IDENTIDAD:</td><td>${data.identidad}</td></tr>
        <tr><td>TOTAL GASTADO:</td><td>L ${data.total}</td></tr>
        <tr><td>LITROS:</td><td>${data.litros}</td></tr>
        <tr><td>MOTIVO:</td><td>${data.motivo}</td></tr>
        <tr><td>FECHA:</td><td>${data.fecha}</td></tr>
        <tr><td>HORAS VIAJE:</td><td>${data.horas}</td></tr>
        <tr><td>KM ACTUAL:</td><td>${data.km}</td></tr>
        <tr><td>NOMBRE COMERCIO:</td><td>${data.nombre_comercio}</td></tr>
        <tr><td>No. FACTURA:</td><td>${data.factura}</td></tr>
      </table>
    `;

    // Populate photos table
    const photosTableContainer = document.getElementById('photos_table_container');
    photosTableContainer.innerHTML = `
      <table class="photos-table">
        <tr>
          <td colspan="2">
            <div class="photo-title">Fotografía Tablero Antes de Llenado:</div>
            <img src="${document.getElementById('preview_foto_tablero_antes').querySelector('img').src}"/>
            <div class="photo-footer">PLACA: ${data.placa} - FECHA: ${data.fecha} - KM INICIAL: ${data.km}</div>
          </td>
        </tr>
        <tr>
          <td>
            <div class="photo-title">Fotografía Bomba en 0:</div>
            <img src="${document.getElementById('preview_foto_bomba').querySelector('img').src}"/>
            <div class="photo-footer">FECHA: ${data.fecha}</div>
          </td>
          <td rowspan="2">
            <div class="photo-title">Fotografía Frontal del Vehículo o VIN con Vehículo:</div>
            <img src="${document.getElementById('preview_foto_frontal').querySelector('img').src}"/>
            <div class="photo-footer">PLACA: ${data.placa} - FECHA: ${data.fecha}</div>
          </td>
        </tr>
        <tr>
          <td>
            <div class="photo-title">Fotografía Bomba Llena:</div>
            <img src="${document.getElementById('preview_foto_bomba_llenado').querySelector('img').src}"/>
            <div class="photo-footer">FECHA: ${data.fecha} - LITROS: ${data.litros}</div>
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <div class="photo-title">Fotografía Tablero Después de Llenado:</div>
            <img src="${document.getElementById('preview_foto_despues').querySelector('img').src}"/>
            <div class="photo-footer">PLACA: ${data.placa} - FECHA: ${data.fecha} - KM FINAL: ${data.km}</div>
          </td>
        </tr>
      </table>
    `;

    // Set factura_only_img source
    document.getElementById('factura_only_img').src = document.getElementById('preview_foto_factura').querySelector('img').src;
  }

  // Initial loads
  document.addEventListener('DOMContentLoaded', function() {
    cargarDatosVehiculos();
    cargarProcesos();

    flatpickr("#fecha", {
      dateFormat: "d/m/Y",
      locale: "es",
      maxDate: "today",
      altInput: true,
      altFormat: "d/m/Y"
    });

    flatpickr("#filtroFechaPago", {
      mode: "range",
      dateFormat: "d/m/Y",
      locale: "es",
      maxDate: "today",
      altInput: true,
      altFormat: "d/m/Y",
      onChange: function(selectedDates, dateStr, instance) {
        applyFilters();
      }
    });
  });


  /* Tabulator Table for Pago de Facturas */
  let table = new Tabulator("#facturas-table", {
    height:"100%", // Establece una altura fija, ajusta según sea necesario
    layout:"fitColumns",
    data:[], // Se cargará dinámicamente
    columns:[
      {formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, cellClick:function(e, cell){
        cell.getRow().toggleSelect();
        actualizarVisibilidadBotonesMasivos();
      }},
      {title:"ID", field:"ID", hozAlign:"center", width:60},
      {title:"Sector", field:"Sector"},
      {title:"Placa", field:"Placa"},
      {title:"Colaborador", field:"NombreCompleto"},
      {title:"Identidad", field:"Identidad"},
      {title:"Total Gastado", field:"TotalGastado", formatter:"money", formatterParams:{
        decimal:".", thousand:",", symbol:"L ", symbolAfter:"false", precision:2,
      }},
      {title:"Litros", field:"LitrosConsumidos"},
      {title:"Fecha", field:"Fecha"},
      {title:"No. Factura", field:"NumeroFactura"},
      {title:"Estado", field:"Estado", hozAlign:"center",
        formatter:function(cell, formatterParams, onRendered){
          const status = cell.getValue();
          let color = '';
          switch(status){
            case "Revisada": color = 'orange'; break;
            case "Pagada": color = 'green'; break;
            default: color = 'gray';
          }
          return `<span style="color:${color};font-weight:bold;">${status}</span>`;
        }
      },
      {title:"Acciones", field:"acciones", hozAlign:"center", formatter:function(cell, formatterParams, onRendered){
        const rowData = cell.getRow().getData();
        const estado = rowData.Estado;
        let buttons = '';
        if (estado === "Revisada") {
          buttons += `<button class='btn-pagar' onclick='marcarComoPagada(${rowData.ID})' style='background-color:#4CAF50; color:white; padding: 5px 10px; border:none; border-radius:3px; cursor:pointer; margin-right:5px;'>Pagar</button>`;
        }
        buttons += `<button class='btn-ver' onclick='verDetalleFactura(${rowData.ID})' style='background-color:#008CBA; color:white; padding: 5px 10px; border:none; border-radius:3px; cursor:pointer;'>Ver</button>`;
        return buttons;
      }}
    ],
  });

  // Funciones de la sección de pago
  function loadData() {
    mostrarOverlay("Cargando Facturas...");
    fetch("/api/facturas") // Asumiendo que este endpoint existe para obtener facturas
      .then(response => response.json())
      .then(data => {
        table.setData(data);
        ocultarOverlay();
        applyFilters(); // Aplicar filtros después de cargar los datos iniciales
      })
      .catch(error => {
        console.error("Error al cargar datos de facturas:", error);
        ocultarOverlay();
        showToast("Error al cargar facturas.", 'error');
      });
  }

  function marcarComoPagada(id) {
    mostrarOverlay("Marcando como Pagada...");
    fetch("/api/facturas/pagar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(result => {
      ocultarOverlay();
      if (result.success) {
        showToast("Factura marcada como pagada.", 'success');
        loadData(); // Recargar datos para actualizar la tabla
      } else {
        showToast("Error al marcar factura como pagada: " + (result.error || ""), 'error');
      }
    })
    .catch(error => {
      ocultarOverlay();
      showToast("Error de conexión al marcar factura.", 'error');
      console.error("Error:", error);
    });
  }

  function verDetalleFactura(id) {
    // Implementar lógica para mostrar detalles de una factura específica
    alert("Ver detalles de factura ID: " + id);
  }

  // Hook filters
  ["filtroSectorPago","filtroEstadoPago"].forEach(id=>{
    document.getElementById(id).addEventListener("change",applyFilters);
  });
  document.getElementById("filtroNumeroPago").addEventListener("input",applyFilters);

  // Función para agrupar por colaborador
  document.getElementById("btnAgruparColaborador").addEventListener("click",function(){
    if(table.getGrouped()){
      table.clearData(); // Clear table data for ungrouped view
      table.setGroupBy(false);
      table.setSort([{field:"ID", dir:"asc"}]); // Restore default sort
      loadData(); // Reload data for ungrouped view
    } else {
      table.setGroupBy("NombreCompleto");
    }
  });

  function applyFilters(){
    const sector = document.getElementById("filtroSectorPago").value;
    const estado = document.getElementById("filtroEstadoPago").value;
    const numero = document.getElementById("filtroNumeroPago").value.toLowerCase();
    const fechaRange = flatpickr.getInstance(document.getElementById("filtroFechaPago")).selectedDates;

    table.setFilter(function(row){
      const rowData = row.getData();
      const rowSector = rowData.Sector;
      const rowEstado = rowData.Estado;
      const rowNumero = String(rowData.NumeroFactura).toLowerCase();
      const rowFecha = flatpickr.parseDate(rowData.Fecha, "d/m/Y");

      const sectorMatch = (sector === "Todos" || rowSector === sector);
      const estadoMatch = (estado === "Todos" || rowEstado === estado);
      const numeroMatch = (numero === "" || rowNumero.includes(numero));
      
      let dateMatch = true;
      if (fechaRange.length === 2) {
        const start = fechaRange[0];
        const end = fechaRange[1];
        dateMatch = (rowFecha >= start && rowFecha <= end);
      } else if (fechaRange.length === 1) {
        dateMatch = (rowFecha.toDateString() === fechaRange[0].toDateString());
      }

      return sectorMatch && estadoMatch && numeroMatch && dateMatch;
    });
    updateCounters();
  };

  // Update counters
  function updateCounters(){
    var data = table.getData("active"), p=0, g=0, sp=0, sg=0;
    data.forEach(r=>{
      if(r.Estado==="Revisada"){p++; sp+=parseFloat(r["Total Gastado"]||0);}
      if(r.Estado==="Pagada"){g++; sg+=parseFloat(r["Total Gastado"]||0);}
    });
    document.getElementById("contadorPendientes").textContent = p;
    document.getElementById("contadorPagadas").textContent   = g;
    document.getElementById("totalRevisada").textContent    = "L "+sp.toLocaleString("es-HN",{minimumFractionDigits:2});
    document.getElementById("totalPagada").textContent      = "L "+sg.toLocaleString("es-HN",{minimumFractionDigits:2});
  }

  // Hook filters
  ["filtroSectorPago","filtroEstadoPago"].forEach(id=>{
    document.getElementById(id).addEventListener("change",applyFilters);
  });
  document.getElementById("filtroNumeroPago").addEventListener("input",applyFilters);

  // Define cargarPagoFacturas to also load data when section is shown
  function cargarPagoFacturas() {
    mostrarSeccion('seccionPagoFacturas');
    loadData(); // Call loadData here
  }
</script>
</body>
</html>
