<!DOCTYPE html>

<html lang="es">
<head>

<style>
  #pasteArea {
    position: relative;
    border: 1px dashed #ccc;
    padding: 1rem;
    min-height: 150px;
    text-align: center;
  }
  #pasteArea .placeholder-top,
  #pasteArea .placeholder-bottom {
    pointer-events: none;
  }
  #pasteArea .placeholder-bottom {
    position: absolute;
    width: 100%;
    left: 0;
    color: #666;
    pointer-events: none;
  }
  #pasteArea .placeholder-top {
    top: 1rem;
  }
  #pasteArea .placeholder-bottom {
    bottom: 1rem;
  }
  #pasteArea img {
    max-width: 100%;
    max-height: 100%;
    margin: auto;
    display: block;
  }
  
</style>

  


<style>
  .btn-pagar {
    padding: 4px 8px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .btn-pagar:hover {
    background-color: #0056b3;
  }
  /* Modal overlay */
  #modalPago {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }
  #modalPago .dialog {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    width: 100%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
</style>

<script>
  const urlGuardarAnticipo = "/api/GuardarAnti";
  const urlLeerAnticipos = "/api/Anticipos";
  const urlGuardarFactura = "/api/guardar";
</script>
<!-- ==== unload listener interception Patch v26 ==== -->
<script>
// Intercept addEventListener to redirect 'unload' to 'pagehide' to avoid deprecation
(function(){
  const origAdd = EventTarget.prototype.addEventListener;
  EventTarget.prototype.addEventListener = function(type, listener, options){
    if(type === 'unload'){
      // Redirect to pagehide; duplicate prevention
      return origAdd.call(this, 'pagehide', listener, options);
    }
    return origAdd.call(this, type, listener, options);
  };

  // Handle direct property assignment window.onpagehide = fn;
  Object.defineProperty(window, 'onpagehide', {
    set: function(fn){
      if(typeof fn === 'function'){
        window.addEventListener('pagehide', fn);
      }
    },
    get: function(){ return null; },
    configurable: true
  });
})();
</script>
<!-- ==== end unload interception Patch v26 ==== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  /* Global button styles for mobile friendliness */
  button {
    padding: 1rem 1.5rem !important;
    font-size: 1.1rem !important;
    border-radius: 0.5rem !important;
    margin-bottom: 1rem !important;
  }

  /* Navigation buttons spacing */
  .nav-buttons button + button {
    margin-left: 0.5rem !important;
  }

  /* Signature buttons layout */
  .signature-buttons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0 !important;
  }
  .signature-buttons button {
    flex: 1;
    margin: 0 !important;
  }

  /* Download confirmation modal readability */
  #downloadModal .modal-content {
    padding: 2rem !important;
  }
  #downloadModal .modal-content p {
    font-size: 1.1rem !important;
    line-height: 1.5 !important;
  }
  #downloadModal .modal-content button {
    padding: 1rem 1.5rem !important;
    font-size: 1.1rem !important;
    flex: 1 !important;
    margin: 0.5rem !important;
  }
</style>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Control de Combustible</title>
<style>
  /* Responsive layout */
  .form-steps {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  @media (max-width: 640px) {
    .form-steps {
      grid-template-columns: 1fr;
    }
  }

  /* Tap targets and spacing */
  input, select, textarea, button {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem !important;
    font-size: 1.1rem;
    border-radius: 0.5rem;
    box-sizing: border-box;
  }

  /* Full-screen camera preview */
  .camera-preview {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000;
    display: none; /* toggled on capture */
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .camera-preview.active {
    display: flex;
  }
  .camera-preview .overlay-controls {
    position: absolute;
    bottom: 1rem;
    width: 100%;
    display: flex;
    justify-content: space-around;
  }

  button { margin: 0 0 1rem !important; }
</style>
<style>
.photo-buttons {
  display: flex;
  gap: 1rem;
  padding: 0.75rem;
}
.photo-buttons button {
  flex: 1;
  margin: 0 !important;
}
</style>
<!-- Roboto font for consistent typography -->
<link href="https://fonts.googleapis.com/css2?family=Roboto&amp;display=swap" rel="stylesheet"/>
<style>
    /* Animaciones para transiciones */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in-up {
      animation: fadeInUp 0.5s ease-out forwards;
    }

    /* Global page styles */
    /* Global page styles */
    body {
      font-family: 'Roboto', sans-serif;
      background: #f4f4f4;
      padding: 20px;
    }
    .formulario {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      padding: 10px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin: 5px 0;
    }
    button:hover { background-color: #0056b3; }
    #mensaje_cargando {
      text-align: center;
      font-weight: bold;
      color: #007BFF;
      margin-bottom: 15px;
    }

    /* Styles for preview pages to mimic Letter dimensions */
    @page {
      size: letter;
      margin: 1.27cm;
    }
    .page {
      background: white;
      width: 216mm;           /* Carta: 8.5in = 216mm */
      height: 279mm;          /* Carta: 11in = 279mm */
      margin: 20px auto;      /* Separaci√≥n entre p√°ginas */
      padding: 1.27cm;        /* M√°rgenes internos de 1.27cm */
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      display: flex;          /* Contenedor flex para extender contenido */
      flex-direction: column; /* Organizar header y contenido en columna */
      overflow: hidden;       /* Ocultar desbordes */
      page-break-after: always;
    }
    @media print {
      .page { page-break-after: always; margin: 0; box-shadow: none; }
      body { margin: 0; }
    }
    .format-header {
      text-align: center;
      font-weight: bold;
      border: 1px solid #000;
      padding: 5px;
      margin-bottom: 10px;
      font-size: 18px;
    }
    .preview-box {
      display: flex;
      gap: 10px; /* Gap between columns */
      flex: 1; /* Fill vertical space under header */
    }
    .invoice-box {
      flex: 0 0 55%; /* Width ratio for invoice box */
      height: 100%;  /* Fill parent height */
    }
    .summary-box {
      flex: 0 0 45%; /* Width ratio for summary box */
      height: 100%;  /* Fill parent height */
    }
    .invoice-box .placeholder {
      width: 100%; height: 100%;
      border: 2px dashed #666;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-style: italic;
    }
    .summary-box table {
      width: 100%; height: 100%;
      border-collapse: collapse;
    }
    .summary-box td:first-child { width: 30%; }
    .summary-box td:nth-child(2) { width: 70%; }
    .summary-box td {
      font-size: 14px;
      border: 1px solid #ccc;
      padding: 8px;
      vertical-align: top;
    }

    /* Adjust page 2 to fill remaining height */
    #photos_table_container {
      flex: 1;               /* Fill vertical space under header */
      display: flex;
      flex-direction: column;
    }
    .photos-table {
      flex: 1;               /* Fill all available height */
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .photos-table td {
      border: 1px solid #ccc;
      padding: 4px;
      vertical-align: top;
      overflow: hidden;
      width: 45%;
      height: 300px; /* Ajustado a 300px seg√∫n pedido */
    }
    .photos-table td[rowspan="2"] {
      width: 55%;
      height: 530px; /* Ajustado a 530px seg√∫n pedido */
    }
    .photos-table img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .photo-title { font-size: 14px; font-weight: bold; margin-bottom: 4px; }
    .photo-footer { font-size: 14px; font-weight: bold; text-align: left; padding: 6px; }
    /* Pie de p√°gina: altura fija distinta de las fotos */
    .photos-table tr:last-child td {
      height: 20px; /* Ajustado a 20px para el pie de p√°gina */ /* Ajusta este valor para cambiar el largo del pie de p√°gina */
    }
      /* Ensure preview content matches Letter width */
    html, body { box-sizing: border-box; }
    #preview_contenido {
      width: 216mm;       /* Match page width for PDF capture */
      margin: 0 auto;
      overflow: visible;
    }
  </style>
<style>
.spinner {
  border: 6px solid #f3f3f3;
  border-top: 6px solid #3498db;
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<style>
#toast-alert {
  visibility: hidden;
  min-width: 280px;
  background-color: #c62828;
  color: white;
  text-align: center;
  border-radius: 5px;
  padding: 14px 28px;
  position: fixed;
  z-index: 9999;
  left: 50%;
  bottom: 30px;
  font-size: 16px;
  transform: translateX(-50%);
}
#toast-alert.show {
  visibility: visible;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}
@keyframes fadein {
  from { bottom: 10px; opacity: 0; }
  to   { bottom: 30px; opacity: 1; }
}
@keyframes fadeout {
  from { bottom: 30px; opacity: 1; }
  to   { bottom: 10px; opacity: 0; }
}
</style>
<div id="toast-alert">‚ö†Ô∏è Hay campos obligatorios sin completar.</div>
<!-- ==== Registrar Anticipo ==== -->
<section id="registrarAnticipo" style="display:none;flex-direction:column;gap:1rem;padding:1rem;align-items:center;">
<button id="btnBackAnt" style="align-self:flex-start;">‚Üê Volver</button>
<h2>Registrar Anticipo</h2>
<div style="display:flex;flex-wrap:wrap;gap:.8rem;align-items:flex-end;">
<div><label>Sector<br/><select id="antSector" required="">
<option value="">Seleccione</option>
<option value="SAN PEDRO SULA">SAN PEDRO SULA</option>
<option value="EL PROGRESO">EL PROGRESO</option>
<option value="STA. CRUZ">STA. CRUZ</option>
<option value="CHOLUTECA">CHOLUTECA</option>
<option value="COMAYAGUA">COMAYAGUA</option>
<option value="DANLI">DANLI</option>
<option value="GUANAJA">GUANAJA</option>
<option value="JUTICALPA">JUTICALPA</option>
<option value="LA CEIBA">LA CEIBA</option>
<option value="SANTA ROSA">SANTA ROSA</option>
<option value="TEGUCIGALPA">TEGUCIGALPA</option>
<option value="TOCOA">TOCOA</option>
<option value="BRUS LAGUNA">BRUS LAGUNA</option>
</select></label></div>
<div><label>Fondo<br/><select id="antFondo"><option value="">Seleccione</option><option value="Combustible">Combustible</option><option value="Poda">Poda</option></select></label></div>
<div><label>Dep√≥sito (L)<br/><input id="antDeposito" min="0" step="0.01" style="width:8rem;" type="number"/></label></div>
<div><label>Periodo<br/><select id="antPeriodo" style="width:8rem;"><option value="">Seleccione</option></select></label></div>
<button id="btnAddAnt" style="height:2.3rem;">Ôºã Registrar</button>
</div>
<div style="font-weight:bold;display:flex;gap:2rem;margin-top:.5rem;">
<span>Total anticipos: <span id="antTotal">L 0.00</span></span>
<span>Saldo disponible: <span id="antSaldo">L 0.00</span></span>
</div>
<div id="tablaAnticiposWrapper" style="position:relative;border:1px solid #ccc;border-radius:6px;overflow:hidden;width:100%;max-width:1200px;">
  <div id="tablaAnticipos"></div>
  <div id="overlayAnt" style="position:absolute;top:0;left:0;right:0;bottom:0;display:none;flex-direction:column;justify-content:center;align-items:center;background:rgba(255,255,255,0.8);z-index:1000;">
    <div style="width:3rem;height:3rem;border:.4rem solid #eee;border-top-color:#007bff;border-radius:50%;animation:spin .8s linear infinite;"></div>
    <span style="color:#333;font-weight:bold;margin-top:.5rem;">Cargando informaci√≥n</span>
  </div>
</div>
<style>@keyframes spin { to { transform: rotate(360deg); } }</style>
</section>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script>
window.isFirstLoadPagoFacturas = true;

  var generatedPDF = null;
  var generatedFilename = '';
</script>
<style>
@keyframes fadeOutUp {
  from { opacity: 1; transform: translateY(0); }
  to   { opacity: 0; transform: translateY(-20px); }
}
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fade-out-up {
  animation: fadeOutUp 0.3s forwards;
}
.fade-in-down {
  animation: fadeInDown 0.3s ease-out forwards;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://unpkg.com/blueimp-load-image/js/load-image.all.min.js"></script>
<!-- Custom Header Styles -->
<style>
    .custom-header {
      display: table;
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    .custom-header > div {
      display: table-cell;
      border: 1px solid #000;
      vertical-align: middle;
      padding: 8px;
    }
    .custom-header .header-left img {
      max-height: 60px;
      display: block;
    }
    .custom-header .header-center h1 {
      font-size: 18px;
      margin: 0;
      text-align: center;
    }
      width: 100%;
      border-collapse: collapse;
    }
      border: 1px solid #000;
      padding: 4px 8px;
      font-size: 12px;
    }
  </style>
<style>
  .header-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  .header-table td {
    border: 1px solid #000;
    padding: 4px;
    vertical-align: middle;
  }
  .header-table img {
    max-height: 60px;
    display: block;
  }
  .header-table .title-cell {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
  }
</style>
<!-- flatpickr CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<!-- Tabulator CSS & JS -->
<link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<style>
@keyframes spinner {
  to { transform: rotate(360deg); }
}
#overlayCambios {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
#overlayCambios .spinner {
  width: 4rem;
  height: 4rem;
  border: 0.5rem solid #ddd;
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spinner 0.75s linear infinite;
  margin-bottom: 1rem;
}
#overlayCambios .text {
  font-size: 1.25rem;
  color: white;
  font-weight: bold;
}
</style>
<script>
function actualizarVisibilidadBotonesMasivos() {
  const checks = document.querySelectorAll("#tablaFacturas input[type=checkbox]:checked");
  const cont = document.getElementById("accionesMasivas");
  if (cont) cont.style.display = (checks.length >= 2) ? "block" : "none";
}
</script>
<style>
#countersContainer {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
  justify-content: center;
}
.counter-box {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
  padding: 0.5rem 1rem;
  text-align: center;
  min-width: 8rem;
}
.counter-box .label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.25rem;
}
.counter-box .value {
  font-size: 1.25rem;
}
</style>
<style>
#countersRow, #filtersRow {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-bottom: 1rem;
}
#filtersRow label {
  white-space: nowrap;
  margin-right: 0.5rem;
}
#filtersRow select,
#filtersRow input[type="text"] {
  width: 200px;
  border-radius: 0.375rem;
  border: 1px solid #cbd5e0;
  padding: 0.5rem;
  background: #f7fafc;
}
.counter-box {
  background: #edf2f7;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  text-align: center;
}
.counter-box .label {
  display: block;
  font-size: 0.875rem;
  color: #4a5568;
}
.counter-box .value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #2d3748;
}
</style>
<style>
  /* Bot√≥n volver m√°s compacto verticalmente */
  #seccionRevisionFacturas > button {
    padding: 0.25rem 1rem !important;
  }
  /* Contadores: menos alto */
  .counter-box {
    padding: 0.25rem 1rem !important;
  }
  /* Tabla: celdas m√°s compactas */
  #tablaFacturas th,
  #tablaFacturas td {
    padding: 0.25rem 0.5rem !important;
  }
</style>
<style>
#tablaPagoWrapper { position: relative; }
#overlayPago { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;
  color: white; font-size: 1.2rem; font-weight: bold; }
</style>
<style id="excel-button-style">
#exportExcelBtn {
    margin-left: 0.25rem !important;
}
</style>
<style>
#overlayRevision { display:none; position:absolute; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:center; justify-content:center;
  color:white; font-size:1.2rem; font-weight:bold;}
</style>

</head>
<body>
<div id="overlayCambios">
<div class="spinner"></div>
<div class="text">Registrando Cambios...</div>
</div>
<div id="menuPrincipal" style="display: flex; flex-direction: column; align-items: center; margin-top: 50px; gap:20px;">
<h2>Seleccione una opci√≥n</h2>
<button onclick="mostrarSeccion('reportarFactura')" style="width: 250px;  padding: 10px;">üì• Reportar Factura</button>
<button onclick="cargarRevisionFacturas()" style="width: 250px;  padding: 10px;">üîç Revisi√≥n de Facturas</button>
<button onclick="cargarPagoFacturas()" style="width: 250px;  padding: 10px;">üí≥ Pago de Facturas</button>
<button id="btnIrRegistrarAnticipo" style="width:250px;padding:10px;">üíµ Registrar Anticipo</button></div><div id="seccionPagoFacturas" style="display: none;">
<button onclick="mostrarSeccion('menuPrincipal')" style="height:24px; line-height:1; padding: 0.25rem 0.5rem; display: flex; align-items: center; justify-content: center;"><span style="margin-right: 0.5rem;">‚Üê</span>Regresar al Men√∫ Principal</button><h2>Pago de Facturas</h2>
<div id="countersContainer">
<div class="counter-box"><span class="label">Facturas Pendientes</span><span class="value" id="contadorPendientes">0</span></div>
<div class="counter-box"><span class="label">Facturas Pagadas</span><span class="value" id="contadorPagadas">0</span></div>
<div class="counter-box"><span class="label">Total Pendiente de Pagar</span><span class="value" id="totalRevisada">L 0.00</span></div>
<div class="counter-box"><span class="label">Total Pagado</span><span class="value" id="totalPagada">L 0.00</span></div>
</div>
<div id="filtersRow" style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;">
<label>Filtrar por sector:
    <select id="filtroSectorPago"><option value="Todos">Todos</option></select>
</label>
<label>Filtrar por estado:
    <select id="filtroEstadoPago">
<option value="Todos">Todos</option>
<option value="Revisada">Revisada</option>
<option value="Pagada">Pagada</option>
</select>
</label>
<label>Filtrar N¬∫ de Factura:
    <input id="filtroNumeroPago" placeholder="Buscar factura‚Ä¶" style="padding:0.5rem;" type="text">
</input></label>
<label>Rango de Fechas:
    <input id="filtroFechaPago" placeholder="Selecciona rango" style="padding:0.5rem;" type="text"/>
</label>
</div>
<style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    </style>
<div id="tablaPagoWrapper" style="max-height: 500px; overflow: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px;">
<button id="btn-pagar-facturas" style="display:none; margin-bottom:10px; font-size:0.8rem !important; padding:2px 6px !important; height:24px !important; line-height:1 !important;">Pagar Facturas</button>
<button class="boton" id="btnAgruparColaborador" style="display:inline-block; margin-left:10px; margin-bottom:10px; font-size:0.8rem !important; padding:2px 6px !important; height:24px !important; line-height:1 !important;">Agrupar por colaborador</button><button class="boton" id="exportExcelBtn" style="display:inline-block; margin-bottom:10px; font-size:0.8rem !important; padding:2px 6px !important; height:24px !important; line-height:1 !important; background-color: #217346; border-color: #1b5e33; color: white; margin-left: 1rem;">Exportar Excel</button>
<div id="overlayPago"><span id="overlayTextPago">Cargando informaci√≥n</span></div>
<div id="facturas-table" style="height:500px; display:none;"></div>
</div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div id="seccionReportarFactura" style="display: none;"><button id="btnBackMain" onclick="mostrarSeccion('menuPrincipal');" style="height:24px; line-height:1; padding:0.25rem 0.5rem; margin-bottom:0.5rem; margin-right:0.5rem; display:flex; align-items:center; justify-content:center; text-align:center;">Regresar al Men√∫ Principal</button>
<div id="notification" style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#28a745; color:white; padding:15px 30px; border-radius:5px; opacity:0; transition:opacity 0.5s ease-in-out; z-index:1000;">Informaci√≥n enviada correctamente</div>
<!-- Initial loading message displayed while fetching data -->
<div id="mensaje_cargando" style="display:none;">Cargando informaci√≥n, por favor espere...</div>
<!-- Formulario: oculto hasta cargar sectores y procesos -->
<div class="formulario" id="formulario_contenido" style="display:none;">
<h2>Reporte de Gasto de Combustible</h2>
<!-- Sector selector populated din√°micamente -->
<!-- Placa selector dependiente del sector -->
<datalist id="placas"></datalist>
<!-- Proceso seleccionado por usuario (movido) -->
<!-- Datos del colaborador -->
<!-- Kilometraje y gasto -->
<!-- Nuevo campo: Litros Consumidos, no aparece en preview ni PDF -->
<!-- Motivaci√≥n del viaje -->
<!-- Motivaci√≥n del viaje -->
<!-- Proceso seleccionado por usuario -->
<!-- Fecha y duraci√≥n -->
<!-- Datos del veh√≠culo y factura -->
<!-- Inputs de im√°genes (galer√≠a o c√°mara) reordered -->
<!-- Bot√≥n para generar vista previa -->
<div class="paso" id="paso1" style="display:block;"><label for="sector">Seleccionar Sector:</label><span class="error-msg" id="error_sector" style="color:red; display:none;">(Campo obligatorio)</span><select id="sector"><option value="">Seleccione un sector</option></select><label for="placa">Seleccionar Placa del Veh√≠culo:</label><span class="error-msg" id="error_placa" style="color:red; display:none;">(Campo obligatorio)</span><input autocomplete="off" id="placa" list="placas" placeholder="Escribe o selecciona una placa" type="text"/><label for="proceso">Proceso:</label><span class="error-msg" id="error_proceso" style="color:red; display:none;">(Campo obligatorio)</span><select id="proceso"><option value="">Seleccione un proceso</option></select><label for="nombre">Nombre Completo:</label><span class="error-msg" id="error_nombre" style="color:red; display:none;">(Campo obligatorio)</span><input id="nombre" required="" type="text"/><label for="identidad">No. Identidad:</label><span class="error-msg" id="error_identidad" style="color:red; display:none;">(Campo obligatorio)</span><input id="identidad" maxlength="15" oninput="maskIdentidad(this)" required="" type="text"/><label for="total">Total Gastado (L):</label><span class="error-msg" id="error_total" style="color:red; display:none;">(Campo obligatorio)</span><input id="total" step="0.01" type="number"/><label for="litros">Litros Consumidos:</label><span class="error-msg" id="error_litros" style="color:red; display:none;">(Campo obligatorio)</span><input id="litros" step="0.01" type="number"/><label for="motivo">Motivo del Llenado:</label><span class="error-msg" id="error_motivo" style="color:red; display:none;">(Campo obligatorio)</span><textarea id="motivo" rows="3"></textarea><label for="fecha">Fecha:</label><span class="error-msg" id="error_fecha" style="color:red; display:none;">(Campo obligatorio)</span><input class="flatpickr-input" id="fecha" name="fecha" placeholder="Selecciona fecha" readonly="" type="text"/><label for="horas">Horas de Viaje:</label><input id="horas" type="text"/><label for="km">Km Actual del Veh√≠culo:</label><span class="error-msg" id="error_km" style="color:red; display:none;">(Campo obligatorio)</span><input id="km" type="number"/><label for="nombre_comercio">Nombre del comercio:</label><span class="error-msg" id="error_nombre_comercio" style="color:red; display:none;">(Campo obligatorio)</span><input id="nombre_comercio" placeholder="Nombre del comercio" type="text"/><label for="factura">N√∫mero de Factura:</label><span class="error-msg" id="error_factura" style="color:red; display:none;">(Campo obligatorio)</span><input id="factura" oninput="maskFactura(this)" type="text"/><div><button onclick="validarYVerificarDuplicado();" type="button">Siguiente</button></div></div><div class="paso" id="paso2" style="display:none;;text-align:center;"><label for="foto_tablero_antes">Fotograf√≠a Tablero Antes:</label><img alt="Ejemplo de fotograf√≠a" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Tablero%20antes%20de%20llenado.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_tablero_antes" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_tablero_antes')" style=" margin: 5px" type="button">Tomar Fotograf√≠a</button><button onclick="abrirGaleria('foto_tablero_antes')" style=" margin: 5px" type="button">Subir desde Galer√≠a</button><div class="preview" id="preview_foto_tablero_antes"></div><div><button onclick="mostrarPaso(1)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_tablero_antes')){siguientePaso(3);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_tablero_antes" type="file"/></div><div class="paso" id="paso3" style="display:none;;text-align:center;"><label for="foto_bomba">Fotograf√≠a Bomba en 0:</label><img alt="Ejemplo de fotograf√≠a" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Bomba%20en%20cero.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_bomba" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_bomba')" style=" margin: 5px" type="button">Tomar Fotograf√≠a</button><button onclick="abrirGaleria('foto_bomba')" style=" margin: 5px" type="button">Subir desde Galer√≠a</button><div class="preview" id="preview_foto_bomba"></div><div><button onclick="mostrarPaso(2)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_bomba')){siguientePaso(4);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_bomba" type="file"/></div><div class="paso" id="paso4" style="display:none;;text-align:center;"><label for="foto_frontal">Fotograf√≠a Frontal del Veh√≠culo o VIN con Veh√≠culo:</label><img alt="Ejemplo de fotograf√≠a" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Vista%20Frontal.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_frontal" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_frontal')" style=" margin: 5px" type="button">Tomar Fotograf√≠a</button><button onclick="abrirGaleria('foto_frontal')" style=" margin: 5px" type="button">Subir desde Galer√≠a</button><div class="preview" id="preview_foto_frontal"></div><div><button onclick="mostrarPaso(3)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_frontal')){siguientePaso(5);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_frontal" type="file"/></div><div class="paso" id="paso5" style="display:none;;text-align:center;"><label for="foto_bomba_llenado">Fotograf√≠a Bomba Llena:</label><img alt="Ejemplo de fotograf√≠a" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Bomba%20llena.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_bomba_llenado" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_bomba_llenado')" style=" margin: 5px" type="button">Tomar Fotograf√≠a</button><button onclick="abrirGaleria('foto_bomba_llenado')" style=" margin: 5px" type="button">Subir desde Galer√≠a</button><div class="preview" id="preview_foto_bomba_llenado"></div><div><button onclick="mostrarPaso(4)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_bomba_llenado')){siguientePaso(6);}" style=" margin: 5px" type="button">Siguiente</button></div><input accept="image/*" hidden="True" id="foto_bomba_llenado" type="file"/></div><div class="paso" id="paso6" style="display:none;;text-align:center;"><input accept="image/*" hidden="True" id="foto_despues" type="file"/><label for="foto_despues">Fotograf√≠a Tablero Despu√©s de Llenado:</label><img alt="Ejemplo de fotograf√≠a" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Tablero%20antes%20de%20llenado.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><span class="error-msg" id="error_foto_despues" style="color:red; display:none;">(Campo obligatorio)</span><button onclick="activarCamara('foto_despues')" style=" margin: 5px" type="button">Tomar Fotograf√≠a</button><button onclick="abrirGaleria('foto_despues')" style=" margin: 5px" type="button">Subir desde Galer√≠a</button><div class="preview" id="preview_foto_despues"></div><div><button onclick="mostrarPaso(5)" style=" margin: 5px" type="button">Anterior</button><button onclick="if(validarImagenPaso('foto_despues')){siguientePaso(7);}" style=" margin: 5px" type="button">Siguiente</button></div></div><div class="paso" id="paso7" style="display:none; text-align: center;"><h2>Fotograf√≠a de la Factura:</h2><img alt="Ejemplo factura" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/main/imagenes/Factura.png" style="display: block; margin: 10px auto; height: 200px; object-fit: contain; border-radius: 8px;"/><input accept="image/*" hidden="True" id="foto_factura" type="file"/><button onclick="activarCamara('foto_factura')" style=" margin: 5px" type="button">Tomar Fotograf√≠a</button><button onclick="abrirGaleria('foto_factura')" style=" margin: 5px" type="button">Subir desde Galer√≠a</button><div class="preview" id="preview_foto_factura"></div>
<div class="nav-buttons" style="display:flex; justify-content:center; gap:0.5rem;  margin-top: 20px;">
<button onclick="mostrarPaso(6)" style="margin: 5px;" type="button">Anterior</button>
<button id="guardar_reporte" style="margin: 5px;" type="button">Guardar Reporte</button>
</div>
</div></div>
<!-- Contenedor de vista previa: dos p√°ginas A4 simuladas -->
<div id="preview_contenido" style="display:none;">
<!-- P√°gina 1: resumen e inserci√≥n de factura -->
<div class="page" id="preview_page1">
<table class="header-table">
<tr>
<td rowspan="3" style="width:100px;">
<!-- Pega aqu√≠ la URL de tu logo en GitHub -->
<img alt="Logo UTCD" src="https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/refs/heads/main/imagenes/Logo.png"/>
</td>
<td class="title-cell" rowspan="3">
      DETALLE DE LA FACTURA DE COMBUSTIBLE
    </td>
<td>C√≥digo</td>
<td>CLS-PAU-F-19</td>
</tr>
<tr>
<td>Versi√≥n</td>
<td>1</td>
</tr>
<tr>
<td>Fecha</td>
<td>20/5/2025</td>
</tr>
</table>
<div class="preview-box">
<div class="invoice-box">
<div class="placeholder" id="placeholder_box">Pegar Factura Original en este Espacio</div>
</div>
<div class="summary-box" id="summary_box"></div>
</div>
</div>
<!-- P√°gina 2: galer√≠a de fotograf√≠as con pie de p√°gina -->
<div class="page" id="preview_page2">
<h3 class="format-header">FOTOGRAF√çAS</h3>
<div id="photos_table_container"></div>
</div>
<!-- P√°gina 3: separador -->
<!-- P√°gina 3: solo fotograf√≠a de la factura -->
<div class="page" id="preview_page3">
<h3 class="format-header">FACTURA ORIGINAL</h3>
<div class="invoice-box">
<img id="factura_only_img" style="width:auto; height:800px; object-fit:contain; display:block; margin:0 auto;"/>
</div>
</div>
<button id="enviar_reporte">Enviar Reporte</button>
<button id="modificar_reporte">Modificar Reporte</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// Mostrar previews para cada campo de imagen
['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener('change', () => {
      if (input.files && input.files.length > 0) {
        const archivo = input.files[0];
        
        // Validar antig√ºedad de la foto (no mayor a 48 horas)
        const fileDate = new Date(archivo.lastModified);
        if (Date.now() - fileDate.getTime() > 48 * 3600 * 1000) {
          alert('La fotograf√≠a debe ser reciente (no mayor a 48 horas).');
          input.value = '';
          return;
        }
        const url = URL.createObjectURL(archivo);
        const contenedor = document.getElementById('preview_' + id);
        if (contenedor) {
          contenedor.innerHTML = `<img src="${url}" style="max-width:100%; max-height:300px;">`;
        }
      }
    });
      actualizarVisibilidadBotonesMasivos();
  }
});


function validarFormulario() {
  let valido = true;
  const campos = ['sector', 'placa', 'proceso', 'nombre', 'identidad', 'total', 'litros', 'motivo', 'fecha', 'km', 'nombre_comercio', 'factura', 'foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'];

  campos.forEach(id => {
    const campo = document.getElementById(id);
    const error = document.getElementById("error_" + id);
    if (campo && (!campo.value || campo.value.trim() === "")) {
      if (error) error.style.display = "inline";
      valido = false;
    } else {
      if (error) error.style.display = "none";
    }
  });

  if (!valido) {
    const toast = document.getElementById("toast-alert");
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }
  return valido;
}

</script>
<script>
    
  // M√°scara para No. Identidad: formato ####-####-#####
  function maskIdentidad(el) {
    let v = el.value.replace(/\D/g, '');
    v = v.slice(0, 13);
    if (v.length > 8) {
      v = v.replace(/(\d{4})(\d{4})(\d+)/, '$1-$2-$3');
    } else if (v.length > 4) {
      v = v.replace(/(\d{4})(\d+)/, '$1-$2');
    }
    el.value = v;
  }

  // M√°scara para N√∫mero de Factura: formato ###-###-##-#####
    function maskFactura(el) {
      // Solo d√≠gitos
      let v = el.value.replace(/\D/g, '');
      // 1er tramo (0‚Äì3 d√≠gitos)
      if (v.length <= 3) {
        el.value = v;
      }
      // 2¬∫ tramo (4‚Äì6 d√≠gitos)
      else if (v.length <= 6) {
        el.value = `${v.slice(0,3)}-${v.slice(3)}`;
      }
      // 3er tramo (7‚Äì8 d√≠gitos)
      else if (v.length <= 8) {
        el.value = `${v.slice(0,3)}-${v.slice(3,6)}-${v.slice(6)}`;
      }
      // Resto (9+ d√≠gitos)
      else {
        el.value = `${v.slice(0,3)}-${v.slice(3,6)}-${v.slice(6,8)}-${v.slice(8)}`;
      }
    }

    /* URLs de servicios Google Apps Script */
    const urlVehiculos = "https://script.google.com/macros/s/AKfycbwyUE5huHIdOR9SM3IapgIrwvHBCXYHOf9ptj47fXyW-0e1kIj-gK3SGV4czPNa2Wp-wg/exec";
    const urlProcesos  = "https://script.google.com/macros/s/AKfycbxPtMWO-2meogbiHuw8FbbnY0u-rIq70gvtLNlHkr0YS0-JD3N23X6IcyhMld53zD66nw/exec";
    let vehiculos = [], procesos = [];

    /**
     * Carga sectores y placas de la hoja "Vehiculos".
     * Popula <select id="sector"> y muestra el formulario.
     */
    function cargarDatosVehiculos() {
      fetch(urlVehiculos)
        .then(res => res.json())
        .then(data => {
          vehiculos = data;
          const sel = document.getElementById('sector');
          // Eliminar duplicados usando Set
          [...new Set(data.map(x => x.Sector))].forEach(s => sel.add(new Option(s, s)));
          // Agregar sector CORPORATIVO manualmente
          sel.add(new Option('CORPORATIVO', 'CORPORATIVO'));
          document.getElementById('mensaje_cargando').style.display = 'none';
          // Animar formulario al aparecer
          const formEl = document.getElementById('formulario_contenido');
          formEl.style.display = 'block';
          formEl.classList.add('fade-in-up');
            mostrarPaso(1);
          document.getElementById('formulario_contenido').style.display = 'block';
        })
        .catch(err => {

          document.getElementById('mensaje_cargando').innerText = 'Error al cargar los datos.';
        });
      actualizarVisibilidadBotonesMasivos();
    }

    /**
     * Carga procesos de la hoja "Procesos".
     * Popula <select id="proceso">.
     */
    function cargarProcesos() {
      fetch(urlProcesos)
        .then(res => res.json())
        .then(data => {
          procesos = data.map(item => item.Proceso);
          const sel = document.getElementById('proceso');
          sel.innerHTML = '<option value="">Seleccione un proceso</option>';
          procesos.forEach(p => sel.add(new Option(p, p)));
        })
        .catch(err => console.error('Error al cargar procesos:', err));
    }

    // Al cambiar sector, filtrar placas correspondientes
    document.getElementById('sector').addEventListener('change', function() {
      const dataList = document.getElementById('placas');
      dataList.innerHTML = '';
      // Si es CORPORATIVO, mostrar todas las placas
      const lista = (this.value === 'CORPORATIVO') ? vehiculos : vehiculos.filter(v => v.Sector === this.value);
      lista.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.PLACA;
        dataList.appendChild(opt);
      });
      // Limpiar el input de placa al cambiar el sector
      document.getElementById('placa').value = '';
      // Limpiar proceso
      document.getElementById('proceso').value = '';
    });

    
    // Verificar duplicado antes de generar preview
    async function verificarDuplicado(placa, fecha, factura) {
      try {
        const response = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            validarDuplicado: true,
            Placa: placa,
            Fecha: fecha,
            NumeroFactura: factura
          })
        });
        const result = await response.json();
        return result.duplicado || false;
      } catch (err) {

        return false;
      }
    }


function imagenesCompletas() {
  const campos = [
    'foto_tablero_antes',
    'foto_bomba',
    'foto_despues',
    'foto_bomba_llenado',
    'foto_frontal',
    'foto_factura'
  ];
  for (const id of campos) {
    const input = document.getElementById(id);
    if (!input || !input.files || input.files.length === 0) {
      return false;
    }
  }
  return true;
}

// Guardar reporte y generar vista previa
    document.getElementById('guardar_reporte').onclick = async () => {

  if (!validarFormulario()) return;
  if (!imagenesCompletas()) {
    alert("‚ö†Ô∏è Faltan fotograf√≠as por cargar. Por favor verifica antes de continuar.");
    return;
  }
  const placa = document.getElementById('placa').value;
  const fecha = document.getElementById('fecha').value;
  const factura = document.getElementById('factura').value;// Contin√∫a con la generaci√≥n de PDF y carga previa
  // ... el resto del c√≥digo de recopilaci√≥n de datos permanece intacto ...

  // Recopilar datos del formulario
      const data = {
        Fecha:      document.getElementById('fecha').value,
        Nombre:     document.getElementById('nombre').value,
        Identidad:  document.getElementById('identidad').value,
        Total:      document.getElementById('total').value + ' L',
        Motivo:     document.getElementById('motivo').value,
        Proceso:    document.getElementById('proceso').value,
        Horas:      document.getElementById('horas').value,
        Sector:     document.getElementById('sector').value,
        Km:         document.getElementById('km').value,
        FacturaNo:  document.getElementById('factura').value,
        Placa:      document.getElementById('placa').value
      
};
    // Capturar firma digital
    data.Firma = window.colaboradorFirma || '';
      // Buscar jefe inmediato por placa
      const jefeObj = vehiculos.find(v => v.PLACA === data.Placa);
      data.JefeInmediato = jefeObj
        ? (jefeObj["Jefe inmediato"]
           || jefeObj["Jefe Inmediato"]
           || jefeObj.JefeInmediato
           || "")
        : "";
          // Para sector CORPORATIVO no hay jefe inmediato
          if (data.Sector === 'CORPORATIVO') {
            data.JefeInmediato = '';
          }

      // Construir tabla resumen din√°micamente
      const sb = document.getElementById('summary_box'); sb.innerHTML = '';
      const tbl = document.createElement('table');
      const rows = [
        ['Nombre Completo', data.Nombre],
        ['No. Identidad', data.Identidad],
        ['Firma del Colaborador', data.Firma ? `<img src="${data.Firma}" style="max-width:150px;"/>` : ''],
        ['Tipo de Gesti√≥n', 'Liquidaci√≥n de gastos de combustible'],
        ['Total', data.Total],
        ['Motivo del llenado de combustible',
         `Compra de Combustible al Veh√≠culo<br><br>Para Labores de: ${data.Motivo}<br><br>Proceso: ${data.Proceso}`],
        ['Fecha', data.Fecha],        ['Placa / VIN', data.Placa],
        ['Observaci√≥n',
         `SECTOR: ${data.Sector}<br><br>KM: ${data.Km}<br><br>FACTURA: ${data.FacturaNo}`],
        ['Autorizado por Jefe Inmediato', data.JefeInmediato],
        ['Firma', '']
      ];
      rows.forEach(([k,v]) => {
        const r = tbl.insertRow();
        r.insertCell().textContent = k;
        r.insertCell().innerHTML = v;
      });
      sb.appendChild(tbl);

      // Construir galer√≠a de fotograf√≠as
      const container = document.getElementById('photos_table_container');
      const imgHTML = id => {
        const f = document.getElementById(id).files[0];
        if (!f) return '';
        return `<img src="${URL.createObjectURL(f)}" class="photo-img">`;
      };
      container.innerHTML = `
        <table class="photos-table">
          <tr>
            <td><div class="photo-title">TABLERO ANTES DE LLENADO</div>${imgHTML('foto_tablero_antes')}</td>
            <td colspan="2"><div class="photo-title">BOMBA DE COMBUSTIBLE 0</div>${imgHTML('foto_bomba')}</td>
          </tr>
          <tr>
            <td><div class="photo-title">TABLERO DESPU√âS DE LLENADO</div>${imgHTML('foto_despues')}</td>
            <td colspan="2" rowspan="2"><div class="photo-title">BOMBA DE COMBUSTIBLE LLENA</div>${imgHTML('foto_bomba_llenado')}</td>
          </tr>
          <tr>
            <td><div class="photo-title">VISTA FRONTAL DEL VEH√çCULO / VIN CON VEHICULO</div>${imgHTML('foto_frontal')}</td>
          </tr>
          <tr>
            <td class="photo-footer">PLACA: ${data.Placa}</td>
            <td class="photo-footer">FECHA: ${data.Fecha}</td>
            <td class="photo-footer">FACTURA: ${data.FacturaNo}</td>
          </tr>
        </table>`;
      // Cargar imagen de factura en la p√°gina 3
      const factImg = document.getElementById('factura_only_img');
      const fileF = document.getElementById('foto_factura').files[0];
      if (fileF) {
        const rdF = new FileReader();
        rdF.onload = e => factImg.src = e.target.result;
        rdF.readAsDataURL(fileF);
      }

      // Mostrar vista previa y ocultar formulario
      // Ocultar formulario con animaci√≥n
      const formEl = document.getElementById('formulario_contenido');
      formEl.classList.remove('fade-in-up');
      formEl.style.display = 'none';
      document.getElementById('preview_contenido').style.display = 'block';
      // Animar vista previa al aparecer
      const previewEl = document.getElementById('preview_contenido');
      previewEl.classList.add('fade-in-up');

// Asegurar mostrar botones en la vista previa
      document.getElementById('enviar_reporte').style.display = 'inline-block';
      document.getElementById('modificar_reporte').style.display = 'inline-block';
      // Ajustar scroll para centrar preview
      setTimeout(() => previewEl.scrollIntoView({ behavior: 'smooth' }), 100);
    };

    // Volver al formulario desde la vista previa
    document.getElementById('modificar_reporte').onclick = () => {
      // Animar cierre de preview
      const previewEl = document.getElementById('preview_contenido');
      previewEl.classList.remove('fade-in-up');
      previewEl.style.display = 'none';
      // Mostrar formulario con animaci√≥n
      const formEl = document.getElementById('formulario_contenido');
      formEl.style.display = 'block';
      formEl.classList.add('fade-in-up');
            mostrarPaso(1);
      // Centramos el formulario en vista
      setTimeout(() => formEl.scrollIntoView({ behavior: 'smooth' }), 100);
    };

    // Generar y descargar PDF de forma manual para controlar cada p√°gina
    document.getElementById('enviar_reporte').onclick = async () => {
      const modalGen = document.getElementById('generando_pdf_modal');
      modalGen.style.visibility = 'visible';
      modalGen.style.opacity = 1;
      await new Promise(r => setTimeout(r, 100));

      // Recopilar datos del formulario
      const reportData = {
        Sector: document.getElementById('sector').value,
        Placa: document.getElementById('placa').value,
        Proceso: document.getElementById('proceso').value,
        Nombre: document.getElementById('nombre').value,
        Identidad: document.getElementById('identidad').value,
        TotalGastado: document.getElementById('total').value,
        LitrosConsumidos: document.getElementById('litros').value,
        MotivoDelLlenado: document.getElementById('motivo').value,
        Fecha: document.getElementById('fecha').value,
        HorasDelViaje: document.getElementById('horas').value,
        KmActual: document.getElementById('km').value,
        NombreComercio: document.getElementById('nombre_comercio').value,
        NumeroFactura: document.getElementById('factura').value
      };

      try {
        const saveResponse = await fetch(urlGuardarReporte, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reportData)
        });
        const saveResult = await saveResponse.json();
        if (saveResult.status !== 'OK') {
          alert('Error al guardar el reporte: ' + saveResult.message);

          return;
        }

        // Generar PDF
        const pages = document.querySelectorAll('.page');
        const margins = { top: 12.7, left: 12.7, bottom: 12.7, right: 12.7 };
        const pdf = new jspdf.jsPDF({ unit: 'mm', format: 'letter', orientation: 'portrait' });
        for (let i = 0; i < pages.length; i++) {
          const pg = pages[i];
          pg.style.boxShadow = 'none';
          const canvas = await html2canvas(pg, { scale: 1, useCORS: true, backgroundColor: '#ffffff' });
          const imgData = canvas.toDataURL('image/png');
          const pdfWidth = pdf.internal.pageSize.getWidth() - margins.left - margins.right;
          const pdfHeight = pdf.internal.pageSize.getHeight() - margins.top - margins.bottom;
          if (i > 0) pdf.addPage();
          pdf.addImage(imgData, 'PNG', margins.left, margins.top, pdfWidth, pdfHeight);
        }

        // Guardar PDF para descargarlo cuando se confirme
        window.generatedPDF = pdf;
        window.generatedFilename = `${reportData.Sector}_${reportData.Fecha}_${reportData.NumeroFactura}.pdf`;

        // Ocultar modal de generaci√≥n
        modalGen.style.opacity = 0;
        setTimeout(() => { modalGen.style.visibility = 'hidden'; }, 300);

        // Mostrar modal de confirmaci√≥n de descarga
        document.getElementById('downloadModal').style.display = 'flex';
      } catch (err) {
        modalGen.style.opacity = 0;
        modalGen.style.visibility = 'hidden';
        alert('Ocurri√≥ un error al generar o subir el PDF.');

      }
    };




    // Inicializar carga al abrir p√°gina
    
  
// Mostrar previews para cada campo de imagen
['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener('change', () => {
      if (input.files && input.files.length > 0) {
        const archivo = input.files[0];
        
        // Validar antig√ºedad de la foto (no mayor a 48 horas)
        const fileDate = new Date(archivo.lastModified);
        if (Date.now() - fileDate.getTime() > 48 * 3600 * 1000) {
          alert('La fotograf√≠a debe ser reciente (no mayor a 48 horas).');
          input.value = '';
          return;
        }
        const url = URL.createObjectURL(archivo);
        const contenedor = document.getElementById('preview_' + id);
        if (contenedor) {
          contenedor.innerHTML = `<img src="${url}" style="max-width:100%; max-height:300px;">`;
        }
      }
    });
      actualizarVisibilidadBotonesMasivos();
  }
});


function validarFormulario() {
  let valido = true;
  const campos = ['sector', 'placa', 'proceso', 'nombre', 'identidad', 'total', 'litros', 'motivo', 'fecha', 'km', 'nombre_comercio', 'factura', 'foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'];

  campos.forEach(id => {
    const campo = document.getElementById(id);
    const error = document.getElementById("error_" + id);
    if (campo && (!campo.value || campo.value.trim() === "")) {
      if (error) error.style.display = "inline";
      valido = false;
    } else {
      if (error) error.style.display = "none";
    }
  });

  if (!valido) {
    const toast = document.getElementById("toast-alert");
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }
  return valido;
}

</script>
<!-- Incluir html2pdf.js desde CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Mostrar previews para cada campo de imagen
['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener('change', () => {
      if (input.files && input.files.length > 0) {
        const archivo = input.files[0];
        
        // Validar antig√ºedad de la foto (no mayor a 48 horas)
        const fileDate = new Date(archivo.lastModified);
        if (Date.now() - fileDate.getTime() > 48 * 3600 * 1000) {
          alert('La fotograf√≠a debe ser reciente (no mayor a 48 horas).');
          input.value = '';
          return;
        }
        const url = URL.createObjectURL(archivo);
        const contenedor = document.getElementById('preview_' + id);
        if (contenedor) {
          contenedor.innerHTML = `<img src="${url}" style="max-width:100%; max-height:300px;">`;
        }
      }
    });
      actualizarVisibilidadBotonesMasivos();
  }
});


function validarFormulario() {
  let valido = true;
  const campos = ['sector', 'placa', 'proceso', 'nombre', 'identidad', 'total', 'litros', 'motivo', 'fecha', 'km', 'nombre_comercio', 'factura', 'foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'];

  campos.forEach(id => {
    const campo = document.getElementById(id);
    const error = document.getElementById("error_" + id);
    if (campo && (!campo.value || campo.value.trim() === "")) {
      if (error) error.style.display = "inline";
      valido = false;
    } else {
      if (error) error.style.display = "none";
    }
  });

  if (!valido) {
    const toast = document.getElementById("toast-alert");
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }
  return valido;
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script>
// Mostrar previews para cada campo de imagen
['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'].forEach(id => {
  const input = document.getElementById(id);
  if (input) {
    input.addEventListener('change', () => {
      if (input.files && input.files.length > 0) {
        const archivo = input.files[0];
        
        // Validar antig√ºedad de la foto (no mayor a 48 horas)
        const fileDate = new Date(archivo.lastModified);
        if (Date.now() - fileDate.getTime() > 48 * 3600 * 1000) {
          alert('La fotograf√≠a debe ser reciente (no mayor a 48 horas).');
          input.value = '';
          return;
        }
        const url = URL.createObjectURL(archivo);
        const contenedor = document.getElementById('preview_' + id);
        if (contenedor) {
          contenedor.innerHTML = `<img src="${url}" style="max-width:100%; max-height:300px;">`;
        }
      }
    });
      actualizarVisibilidadBotonesMasivos();
  }
});


function validarFormulario() {
  let valido = true;
  const campos = ['sector', 'placa', 'proceso', 'nombre', 'identidad', 'total', 'litros', 'motivo', 'fecha', 'km', 'nombre_comercio', 'factura', 'foto_tablero_antes', 'foto_bomba', 'foto_despues', 'foto_bomba_llenado', 'foto_frontal', 'foto_factura'];

  campos.forEach(id => {
    const campo = document.getElementById(id);
    const error = document.getElementById("error_" + id);
    if (campo && (!campo.value || campo.value.trim() === "")) {
      if (error) error.style.display = "inline";
      valido = false;
    } else {
      if (error) error.style.display = "none";
    }
  });

  if (!valido) {
    const toast = document.getElementById("toast-alert");
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 3000);
  }
  return valido;
}

</script>
<div id="generando_pdf_modal" style="
  visibility: hidden;
  opacity: 0;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:2000;
  transition: opacity 0.3s ease;">
<div class="spinner"></div>
<div style="color:white; font-size:20px; font-weight:bold; margin-top:20px;">
    Generando PDF, por favor espere...
  </div>
</div>
<div id="verificando_duplicado_modal" style="
  visibility: hidden;
  opacity: 0;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:2000;
  transition: opacity 0.3s ease;">
<div class="spinner"></div>
<div style="color:white; font-size:20px; font-weight:bold; margin-top:20px;">
    Verificando datos, por favor espere...
  </div>
</div>
<script>
function mostrarLoaderVerificacion() {
  const modal = document.getElementById("verificando_duplicado_modal");
  if (modal) modal.style.visibility = 'visible', modal.style.opacity = 1;
}
function ocultarLoaderVerificacion() {
  const modal = document.getElementById("verificando_duplicado_modal");
  if (modal) modal.style.opacity = 0;
  setTimeout(() => { if (modal) modal.style.visibility = 'hidden'; }, 300);
}
</script>
<script>
function mostrarPaso(paso) {
  document.querySelectorAll('.paso').forEach(p => p.style.display = 'none');
  const siguiente = document.getElementById('paso' + paso);
  if (siguiente) siguiente.style.display = 'block';
}

async function siguientePaso(pasoActual) {
  if (pasoActual === 2) {
    if (!validarFormulario()) return;const placa = document.getElementById('placa').value;
    const fecha = document.getElementById('fecha').value;
    const factura = document.getElementById('factura').value;
    const duplicado = await verificarDuplicado(placa, fecha, factura);
    ocultarLoaderVerificacion();
    if (duplicado) {
      const continuar = confirm("‚ö†Ô∏è Ya existe un reporte con estos datos. ¬øDeseas reemplazarlo?");
      if (!continuar) return;
    }
  }
  mostrarPaso(pasoActual);
}
</script><script>
function validarFormulario() {
  const paso1 = document.getElementById("paso1");
  const campos = Array.from(paso1.querySelectorAll("input, select, textarea")).filter(c => c.id !== "horas")
              .filter(campo => campo.id !== "horas");
  let esValido = true;

  campos.forEach(campo => {
    const error = document.getElementById(`error_${campo.id}`);
    if (!campo.value.trim()) {
      esValido = false;
      if (error) error.style.display = 'inline';
      campo.classList.add("invalido");
    } else {
      if (error) error.style.display = 'none';
      campo.classList.remove("invalido");
    }
  });

  return esValido;
}
</script><script>
function activarCamara(id) {
  const input = document.getElementById(id);
  input.setAttribute("capture", "environment");
  input.click();
}

function abrirGaleria(id) {
  const input = document.getElementById(id);
  input.removeAttribute("capture");
  input.click();
}

// Validar imagen cargada por paso antes de avanzar
function validarImagenPaso(id) {
  const input = document.getElementById(id);
  if (!input || !input.files || input.files.length === 0) {
    alert("Debe tomar o subir una fotograf√≠a antes de continuar.");
    return false;
  }
  return true;
}
</script><script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("guardar_reporte");
  if (btn && typeof generarPreviewPDF === "function") {
  }
});
</script><script>
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("foto_factura");
  if (input) {
    input.addEventListener("change", e => {
      const preview = document.getElementById("preview_foto_factura");
      if (preview && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          preview.innerHTML = '<img src="' + ev.target.result + '" style="max-width: 100%; max-height: 200px;">';
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });
      actualizarVisibilidadBotonesMasivos();
  }
});
</script>
<script>
function mostrarLoaderVerificacion() {
  const modal = document.getElementById("verificando_duplicado_modal");
  if (modal) {
    modal.style.visibility = 'visible';
    modal.style.opacity = 1;
  }
}
function ocultarLoaderVerificacion() {
  const modal = document.getElementById("verificando_duplicado_modal");
  if (modal) {
    modal.style.opacity = 0;
    setTimeout(() => {
      modal.style.visibility = 'hidden';
    }, 300);
  }
}
</script>
<script>
function validarYVerificarDuplicado() {

    const opciones = document.querySelectorAll('#placas option');
    const listaPlacas = Array.from(opciones).map(opt => opt.value.trim());
    const inputPlaca = document.getElementById('placa');
    const placaIngresada = inputPlaca.value.trim();
    const placaMayus = placaIngresada.toUpperCase();
    if (!listaPlacas.map(p => p.toUpperCase()).includes(placaMayus)) {
        alert("La placa ingresada no est√° registrada. Por favor seleccione una v√°lida.");
        inputPlaca.focus();
        return;
    }

  if (!validarFormulario()) return;

  mostrarLoaderVerificacion();

  requestAnimationFrame(() => {
    setTimeout(() => {
      const duplicado = false;

      if (duplicado) {
        alert("Ya existe un reporte con esta informaci√≥n.");
        ocultarLoaderVerificacion();
      } else {
        const paso2 = document.getElementById('paso2');

        const observer = new MutationObserver(() => {
          if (paso2.style.display === "block") {
            ocultarLoaderVerificacion();
            observer.disconnect();
          }
        });

        observer.observe(paso2, { attributes: true, attributeFilter: ["style"] });
        siguientePaso(2);
      }
    }, 100);
  });
      actualizarVisibilidadBotonesMasivos();
}
</script>
<script>
async function fileToBase64(inputId) {
  return new Promise((resolve, reject) => {
    const file = document.getElementById(inputId).files[0];
    if (!file) return resolve(null);
    // Use blueimp-load-image to correct orientation based on EXIF
    loadImage(
      file,
      function (canvas) {
        const orientedDataUrl = canvas.toDataURL('image/jpeg');
        resolve(orientedDataUrl);
      },
      { canvas: true, orientation: true }
    );
  });
      actualizarVisibilidadBotonesMasivos();
};

document.getElementById('enviar_reporte').onclick = async () => {
  const fields = ['foto_tablero_antes','foto_bomba','foto_despues','foto_bomba_llenado','foto_frontal','foto_factura'];
  const images = {};
  for (const id of fields) {
    images[id] = await fileToBase64(id);
  }

  const data = {
    Sector: document.getElementById('sector').value,
    Placa: document.getElementById('placa').value,
    Proceso: document.getElementById('proceso').value,
    Nombre: document.getElementById('nombre').value,
    Identidad: document.getElementById('identidad').value,
    TotalGastado: document.getElementById('total').value,
    LitrosConsumidos: document.getElementById('litros').value,
    MotivoDelLlenado: document.getElementById('motivo').value,
    Fecha: document.getElementById('fecha').value,
    HorasDelViaje: document.getElementById('horas').value,
    KmActual: document.getElementById('km').value,
    NumeroFactura: document.getElementById('factura').value,
    NombreComercio: document.getElementById('nombre_comercio').value
  };

  const [year, month, day] = data.Fecha.split('-').map(Number);
      const fDate = new Date(year, month - 1, day);
  const meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
  const headerText = `FORMATO DE FACTURAS COMBUSTIBLE ${meses[fDate.getMonth()]} ${fDate.getFullYear()}`;

  document.getElementById('loader_pdf').style.display = 'flex';

data.JefeInmediato = window._jefeInmediato || "";

// Asignar Jefe Inmediato para PDF desde el resumen
    const rows = Array.from(document.querySelector('#summary_box table').rows);
    data.JefeInmediato = rows.find(r => r.cells[0].innerText.trim() === 'Autorizado por Jefe Inmediato')
      ?.cells[1]?.innerText || '';
// Pega aqu√≠ la URL de tu logo en GitHub
const logoUrl = 'https://raw.githubusercontent.com/Sayox95/Gastos-de-Combustible/refs/heads/main/imagenes/Logo.png';
  const logoBase64 = await urlToBase64(logoUrl);

const docDefinition = {
    pageSize: 'letter',
    pageMargins: [30, 30, 30, 30],
    content: [

      {
  table: {
    widths: [100, '*', 'auto', 'auto'],
    body: [
      [
        { image: logoBase64, width: 90, rowSpan: 3, alignment: 'center', margin: [0, 10, 0, 0] },
        { text: 'DETALLE DE LA FACTURA DE COMBUSTIBLE', style: 'header', fontSize: 14, alignment: 'center', bold: true, rowSpan: 3, margin: [0, 20, 0, 0] , verticalAlignment: 'middle' },
        { text: 'C√≥digo', bold: true , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' },
        { text: 'CLS-PAU-F-19' , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }
      ],
      [
        {}, {},
        { text: 'Versi√≥n', bold: true , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' },
        { text: '1' , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }
      ],
      [
        {}, {},
        { text: 'Fecha', bold: true , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' },
        { text: '20/5/2025' , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }
      ]
    ]
  },
  layout: {
    hLineWidth: function () { return 1; },
    vLineWidth: function () { return 1; },
    hLineColor: function () { return '#000'; },
    vLineColor: function () { return '#000'; }
  },
  margin: [0, 0, 0, 10]
},,

      {
        
groupHeader:function(value, count, data){
    // Encontrar el primer nombre coincidente por identidad
    let fullName = "";
    for (let i = 0; i < data.length; i++) {
        if (data[i].Identidad === value && data[i].Nombre) {
            fullName = data[i].Nombre;
            break;
        }
    }
    // Calcular el total por grupo
    let total = data.reduce((sum, row) => sum + (parseFloat(row["Total Gastado"]) || 0), 0);
    return `${fullName} - ${value} - ${count} factura(s) - Total: L ${total.toFixed(2)}`;
},

    columns: [
        {formatter: 'rowSelection', titleFormatter: 'rowSelection', hozAlign: 'center', headerSort: false},
          {
            width: '48%',
            table: {
              widths: ['*'],
              body: [[
                { text: 'Pegar Factura Original en este Espacio', italics: true, alignment: 'center', margin: [0, 309] , verticalAlignment: 'middle' }
              ]]
            },
            layout: {
              hLineWidth: () => 1,
              vLineWidth: () => 1,
              hLineColor: () => '#aaa',
              vLineColor: () => '#aaa',
              hLineStyle: () => ({ dash: { length: 3, space: 3 } }),
              vLineStyle: () => ({ dash: { length: 3, space: 3 } })
            },
            margin: [0, 10, 5, 0]
          },
          {
            width: '52%',
            table: {
              widths: ['30%', '70%'],
              heights: [40, 40, 40, 40, 40, 80, 40, 40, 80, 60, 60],
              body: [
                ['Nombre Completo', data.Nombre],
                ['No. Identidad', data.Identidad],
                ['Firma del Colaborador', window.colaboradorFirma ? { image: window.colaboradorFirma, width: 150 } : ''],
                ['Tipo de Gesti√≥n', 'Liquidaci√≥n de gastos de combustible'],
                ['Total', data.TotalGastado + ' L'],
                ['Motivo del llenado de combustible', `Compra de Combustible al Veh√≠culo

Para Labores de: ${data.MotivoDelLlenado}

Proceso: ${data.Proceso}`],
                ['Fecha', data.Fecha],
                ['Placa o VIN', data.Placa],
                ['Observaci√≥n', `SECTOR: ${data.Sector}

KM: ${data.KmActual}

FACTURA: ${data.NumeroFactura}`],
                ['Autorizado por Jefe Inmediato', data.JefeInmediato || ''],
                ['Firma', '']
              ]
            },
            layout: 'grid',
            margin: [5, 10, 0, 0]
          }
        ]
      },
      {
      table: {
        widths: ['*'],
        body: [[
          { text: 'FOTOGRAF√çAS', style: 'subheader', alignment: 'center', bold: true, border: [true, true, true, true] , verticalAlignment: 'middle' }
        ]]
      },
      layout: {
        hLineWidth: () => 1,
        vLineWidth: () => 1
      },
      pageBreak: 'before',
      margin: [0, 0, 0, 10]
    },
      {
        table: {
          widths: ['50%', '50%'],
          heights: [200, 200, 200],
          body: [
            [
              { stack: [{ text: 'TABLERO ANTES DE LLENADO', bold: true, margin: [0, 0, 0, 5] , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }, { image: images['foto_tablero_antes'], fit: [250, 180] }], alignment: 'center' },
              { stack: [{ text: 'BOMBA DE COMBUSTIBLE 0', bold: true, margin: [0, 0, 0, 5] , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }, { image: images['foto_bomba'], fit: [250, 180] }], alignment: 'center' },
            ],
            [
              { stack: [{ text: 'TABLERO DESPU√âS DE LLENADO', bold: true, margin: [0, 0, 0, 5] , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }, { image: images['foto_despues'], fit: [250, 180] }], alignment: 'center' },
              {
                stack: [{ text: 'VISTA FRONTAL DEL VEH√çCULO / VIN CON VEHICULO', bold: true, margin: [0, 0, 0, 5] , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }, { image: images['foto_frontal'], fit: [250, 200] }], alignment: 'center' , rowSpan: 2 },
            ],
            [
              { stack: [{ text: 'BOMBA DE COMBUSTIBLE LLENA', bold: true, margin: [0, 0, 0, 5] , verticalAlignment: 'middle', alignment: 'center', verticalAlignment: 'middle' }, { image: images['foto_bomba_llenado'], fit: [250, 180] }], alignment: 'center' },
            ]
          ]
        },
        layout: 'grid'
      },
      {
        table: {
          widths: ['33%', '33%', '34%'],
          body: [[
            { text: `PLACA: ${data.Placa}`, bold: true, margin: [0, 0, 0, 5] },
            { text: `FECHA: ${data.Fecha}`, bold: true, alignment: 'center' },
            { text: `FACTURA: ${data.NumeroFactura}`, bold: true, alignment: 'right' }
          ]]
        },
        margin: [0, 10, 0, 0]
      },
      {
      table: {
        widths: ['*'],
        body: [[
          { text: 'FACTURA ORIGINAL', style: 'subheader', alignment: 'center', bold: true, border: [true, true, true, true], margin: [0, 0, 0, 10] , verticalAlignment: 'middle' }
        ]]
      },
      layout: {
        hLineWidth: () => 1,
        vLineWidth: () => 1
      },
      pageBreak: 'before'
    },
      images['foto_factura'] ? { image: images['foto_factura'], fit: [400, 500], alignment: 'center', margin: [0, 30, 0, 0] } : ''
    ],
    styles: {
      header: { fontSize: 16, bold: true, margin: [0, 10, 0, 10] },
      subheader: { fontSize: 14, bold: true, margin: [0, 10, 0, 10] }
    },
    defaultStyle: {
      fontSize: 10
    }
  };

  const filename = `${data.Sector}_${data.Fecha}_${data.NumeroFactura}.pdf`;

  
async function urlToBase64(url) {
  const response = await fetch(url);
  const blob = await response.blob();
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.readAsDataURL(blob);
  });
      actualizarVisibilidadBotonesMasivos();
}

pdfMake.createPdf(docDefinition).getBase64(function(base64) {
    const savePayload = { ...data, pdf: base64, filename };

    fetch('/api/guardar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(savePayload)
    }).then(() => {
        // Guardar PDF para descarga posterior
        generatedPDF = pdfMake.createPdf(docDefinition);
        generatedFilename = filename;
        document.getElementById('loader_pdf').style.display = 'none';
        document.getElementById('downloadModal').style.display = 'flex';
    });

      actualizarVisibilidadBotonesMasivos();
  });
};
</script>
<div id="loader_pdf" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; align-items:center; justify-content:center; flex-direction: column;">
<div class="spinner" style="border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;"></div>
<div style="font-size:20px; font-weight:bold; margin-top:20px;">Generando PDF...</div>
</div>
<div id="success_alert" style="display:none; position:fixed; top:20px; right:20px; background-color:#4CAF50; color:white; padding:15px; border-radius:5px; z-index:10000;">
  Informaci√≥n enviada con √©xito
</div>
<script>
function mostrarSuccessYReset() {
  const alerta = document.getElementById('success_alert');
  if (alerta) {
    alerta.style.display = 'block';
    setTimeout(() => {
      alerta.style.display = 'none';
      location.reload();
    }, 2500);
  } else {
    location.reload();
  }
}
</script>
<script>
function validarYVerificarDuplicado() {

    const opciones = document.querySelectorAll('#placas option');
    const listaPlacas = Array.from(opciones).map(opt => opt.value.trim());
    const inputPlaca = document.getElementById('placa');
    const placaIngresada = inputPlaca.value.trim();
    const placaMayus = placaIngresada.toUpperCase();
    if (!listaPlacas.map(p => p.toUpperCase()).includes(placaMayus)) {
        alert("La placa ingresada no est√° registrada. Por favor seleccione una v√°lida.");
        inputPlaca.focus();
        return;
    }

  if (!validarFormulario()) return;

  const identidad = document.getElementById("identidad").value.replace(/\D/g, '');
  const factura = document.getElementById("factura").value.replace(/\D/g, '');

  if (identidad.length !== 13) {
    alert("El n√∫mero de identidad debe tener exactamente 13 d√≠gitos.");
    return;
  }

  if (factura.length < 16) {
    alert("El n√∫mero de factura debe tener al menos 16 d√≠gitos.");
    return;
  }

  // Validaci√≥n de Monto Gastado (>5000)
  const totalVal = parseFloat(document.getElementById('total').value) || 0;
  if (totalVal > 5000) {
    alert('El monto ingresado es muy elevado. El m√°ximo permitido es 5000.');
    return;
  }

  // Validaci√≥n de Litros Consumidos (>250)
  const litrosVal = parseFloat(document.getElementById('litros').value) || 0;
  if (litrosVal > 250) {
    alert('El valor de litros consumidos es muy elevado. El m√°ximo permitido es 250.');
    return;
  }

  mostrarLoaderVerificacion();

  requestAnimationFrame(() => {
    setTimeout(() => {
      const duplicado = false; // Aqu√≠ normalmente ir√≠a la verificaci√≥n real

      if (duplicado) {
        alert("Ya existe un reporte con esta informaci√≥n.");
        ocultarLoaderVerificacion();
      } else {
        const paso2 = document.getElementById('paso2');
        const observer = new MutationObserver(() => {
          if (paso2.style.display === "block") {
            ocultarLoaderVerificacion();
            observer.disconnect();
          }
        });

        observer.observe(paso2, { attributes: true, attributeFilter: ["style"] });
        siguientePaso(2);
      }
    }, 100);
  });
      actualizarVisibilidadBotonesMasivos();
}
</script>
<script>
function validarFormulario() {
  const paso1 = document.getElementById("paso1");
  const campos = Array.from(paso1.querySelectorAll("input, select, textarea")).filter(c => c.id !== "horas");
  let esValido = true;

  campos.forEach(campo => {
    const error = document.getElementById("error_" + campo.id);
    if (!campo.value.trim()) {
      esValido = false;
      if (error) error.style.display = "inline";
      campo.classList.add("invalido");
    } else {
      if (error) error.style.display = "none";
      campo.classList.remove("invalido");
    }
  });

  if (!esValido) {
    const toast = document.getElementById("toast-alert");
    if (toast) {
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }
  }

  return esValido;
}
</script>
<script>
function mostrarPaso(paso) {
  const pasos = document.querySelectorAll('.paso');
  const visible = Array.from(pasos).find(p => p.style.display !== "none");
  const siguiente = document.getElementById('paso' + paso);

  if (visible && visible !== siguiente) {
    visible.classList.remove('fade-in-down');
    visible.classList.add('fade-out-up');

    setTimeout(() => {
      visible.style.display = 'none';
      visible.classList.remove('fade-out-up');

      siguiente.style.display = 'block';
      siguiente.classList.add('fade-in-down');
    }, 300);
  } else {
    siguiente.style.display = 'block';
    siguiente.classList.add('fade-in-down');
  }
}
</script>
<!-- Modal Firma Digital -->
<div id="modal-signature" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); align-items:center; justify-content:center; z-index:3000; ">
<div style="background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%;">
<h3>Firma de Aprobaci√≥n</h3>
<canvas height="180" id="canvas-signature" style="border:1px solid #ccc; border-radius:4px;" width="460"></canvas>
<div style="margin-top:10px; text-align:right;">
<div class="signature-buttons"><button id="clear-signature" type="button">Limpiar</button>
<button id="confirm-signature" type="button">Confirmar</button></div>
</div>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Inicializar Signature Pad
  const canvas = document.getElementById('canvas-signature');
  const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255,255,255,0)', penColor: 'black' });

  // Capturar handler original
  const btnEnviar = document.getElementById('enviar_reporte');
  const originalHandler = btnEnviar.onclick;

  // Mostrar modal al enviar
  btnEnviar.onclick = () => {
    signaturePad.clear();
    document.getElementById('modal-signature').style.display = 'flex';
  };

  // Limpiar firma
  document.getElementById('clear-signature').onclick = () => {
    signaturePad.clear();
  };

  // Confirmar firma
  document.getElementById('confirm-signature').onclick = () => {
    if (signaturePad.isEmpty()) {
      alert('Por favor, firma antes de confirmar.');
      return;
    }
    // Guardar firma
    window.colaboradorFirma = signaturePad.toDataURL();
    document.getElementById('modal-signature').style.display = 'none';
    // Llamar flujo original
    originalHandler();
  };
});
</script>
<!-- Modal de Confirmaci√≥n de Descarga -->
<div class="modal-overlay" id="downloadModal" style="display:none;">
<div class="modal-content">
<p>El PDF generado est√° listo. ¬øDeseas descargarlo?</p>
<button id="downloadAccept">Aceptar</button>
<button id="downloadCancel">Cancelar</button>
</div>
</div>
<style>
.modal-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: #fff; padding: 1.5rem; border-radius: 8px; text-align: center;
}
.modal-content button {
  margin: 0.5rem;
}
</style>
<script>
// Handler for download modal "Aceptar" button with cross-browser support
document.getElementById('downloadAccept').addEventListener('click', () => {
    if (generatedPDF) {
        generatedPDF.download(generatedFilename);
        // Retrasar la recarga para asegurar la descarga en Samsung Internet
        setTimeout(() => { window.location.reload(); }, 1500);
    } else {
        window.location.reload();
    }
});
</script>
<script>
  // Scroll input into view on focus (mobile)
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('input, select, textarea').forEach(el => {
      el.addEventListener('focus', event => {
        event.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      actualizarVisibilidadBotonesMasivos();
      });
    });
      actualizarVisibilidadBotonesMasivos();
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  flatpickr('#fecha', {
    allowInput: false,
    clickOpens: true,
    dateFormat: 'Y-m-d',
    locale: {
      weekdays: {
        shorthand: ['Do','Lu','Ma','Mi','Ju','Vi','Sa'],
        longhand: ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado']
      },
      months: {
        shorthand: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        longhand: ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre']
      }
    }
  });
      actualizarVisibilidadBotonesMasivos();
});
</script>
</div>
<script>
    function mostrarSeccion(nombre) {
      // Ocultar todas las secciones
      document.getElementById('menuPrincipal').style.display = 'none';
      document.getElementById('seccionReportarFactura').style.display = 'none';
      document.getElementById('seccionRevisionFacturas').style.display = 'none';
      document.getElementById('registrarAnticipo').style.display = 'none';
      document.getElementById('seccionPagoFacturas').style.display = 'none';

      // Mostrar la secci√≥n solicitada
      if (nombre === 'menuPrincipal') {
        document.getElementById('menuPrincipal').style.display = 'flex';
      } else if (nombre === 'reportarFactura') {
        document.getElementById('seccionReportarFactura').style.display = 'block';
        document.getElementById('mensaje_cargando').style.display = 'block';
        document.getElementById('formulario_contenido').style.display = 'none';
        cargarDatosVehiculos();
        cargarProcesos();
      } else if (nombre === 'revisionFacturas') {
        // Reset de filtros al entrar
        const filtroSectorElem = document.getElementById("filtroSector");
        if (filtroSectorElem) filtroSectorElem.value = "Todos";
        const filtroEstadoElem = document.getElementById("filtroEstado");
        if (filtroEstadoElem) filtroEstadoElem.value = "Todas";

        // Mostrar secci√≥n y recargar datos
        document.getElementById('seccionRevisionFacturas').style.display = 'block';
        
      } else if (nombre === 'registrarAnticipo') {
        document.getElementById('registrarAnticipo').style.display = 'block';
      }
    }

    function regresarMenu() {
  document.getElementById('menuPrincipal').style.display = 'flex';
  document.getElementById('seccionReportarFactura').style.display = 'none';
  document.getElementById('seccionRevisionFacturas').style.display = 'none';
  document.getElementById('registrarAnticipo').style.display = 'none';
  const msg = document.getElementById('mensaje_cargando'); if(msg) msg.style.display='none';
  const form = document.getElementById('formulario_contenido'); if(form) form.style.display='none';
}
  </script>
<!-- Revisi√≥n de Facturas ACTIVA -->
<style>
  .tabla-responsive {
    overflow-x: auto;
    max-width: 100%;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-family: Arial, sans-serif;
    font-size: 14px;
  }
  th {
    background-color: #f0f0f0;
    font-weight: bold;
  }
  th, td {
    padding: 8px 12px;
    border: 1px solid #ccc;
    text-align: left;
    white-space: nowrap;
  }
</style>
<div id="seccionRevisionFacturas" style="display: none; padding: 1rem;">
<button class="btn btn-secondary mb-3" onclick="regresarAlMenu()" type="button">
    ‚Üê Volver al Men√∫ Principal
  </button>
<h2 style="margin-bottom: 1rem;">üìÑ Revisi√≥n de Facturas</h2>
<div id="countersRow">
<div class="counter-box">
<span class="label">Registradas</span><br>
<span class="value" id="counterRegistradas">0</span>
</br></div>
<div class="counter-box">
<span class="label">Revisadas</span><br>
<span class="value" id="counterRevisadas">0</span>
</br></div>
<div class="counter-box">
<span class="label">Anuladas</span><br>
<span class="value" id="counterAnuladas">0</span>
</br></div>
</div>
<div id="filtersRow">
<label for="filtroSector">Filtrar por sector:</label>
<select id="filtroSector" style="padding:0.5rem;">
<option value="">Todos</option>
</select>
<label for="filtroEstado">Filtrar por estado:</label>
<select id="filtroEstado" style="padding:0.5rem;">
<option value="">Todos</option>
</select>
<label for="filtroNumeroFactura">Filtrar N¬∫ de Factura:</label>
<input id="filtroNumeroFactura" placeholder="Buscar factura‚Ä¶" style="padding:0.5rem;" type="text"/>
<label for="rangoFechas">Filtrar por rango de fechas:</label>
<input id="rangoFechas" placeholder="Desde - Hasta" readonly="" style="padding:0.5rem;" type="text"/>
</div>
<div style="margin-bottom: 1rem;">
<div id="accionesMasivas" style="margin-bottom:1rem; display:none;"><button onclick="actualizarEstadoSeleccionados('Revisada')">‚úî Marcar como Revisada</button>
<button onclick="actualizarEstadoSeleccionados('Anulada')">‚úñ Marcar como Anulada</button></div>
</div>
<div class="tabla-responsive" style="border: 1px solid #ccc; border-radius: 8px; overflow-x: auto; max-height: 60vh; padding: 1rem;">
<div id="tablaRevisionWrapper" style="position:relative;"><div id="tablaRevisionFacturas"></div><div id="overlayRevision"><span id="overlayTextRevision">Cargando informaci√≥n</span></div></div>
</div> <!-- Fin de contenedor scroll de tabla -->
</div>

<script>
function regresarAlMenu() {
  // Oculta ambas secciones y muestra men√∫ principal
  document.getElementById('seccionRevisionFacturas').style.display = 'none';
  document.getElementById('seccionReportarFactura').style.display = 'none';
  document.getElementById('menuPrincipal').style.display = 'flex';
  // Limpia tablas y formularios
  const encabezado = document.getElementById('encabezadoTabla');
  const cuerpo = document.getElementById('cuerpoTabla');
  if (encabezado) encabezado.innerHTML = '';
  if (cuerpo) cuerpo.innerHTML = '';
  const form = document.getElementById('formulario_contenido');
  if (form) form.style.display = 'none';
}
</script>
<script>
function actualizarVisibilidadBotonesMasivos() {
  const checks = document.querySelectorAll("#tablaFacturas input[type=checkbox]:checked");
  const cont = document.getElementById("accionesMasivas");
  cont.style.display = (checks.length >= 2) ? "block" : "none";
}
</script>
<script>
function updateCounters() {
  const counts = { Registrada: 0, Revisada: 0, Anulada: 0 };
  document.querySelectorAll('#tablaFacturas tbody tr').forEach(tr => {
    const sel = tr.querySelector('select');
    const state = sel ? sel.value : tr.querySelector('td:last-child').textContent.trim();
    if (counts[state] !== undefined) counts[state]++;
  });
  document.getElementById('counterRegistradas').textContent = counts.Registrada;
  document.getElementById('counterRevisadas').textContent = counts.Revisada;
  document.getElementById('counterAnuladas').textContent = counts.Anulada;
}

document.addEventListener('DOMContentLoaded', () => {
  // Hook applyFiltros
  if (typeof aplicarFiltros === 'function') {
    const oldApply = aplicarFiltros;
    aplicarFiltros = function() {
      oldApply();
      updateCounters();
    }
  }
  // Hook cargarFacturasDesdeSheet if returns promise
  if (typeof cargarFacturasDesdeSheet === 'function') {
    const oldLoad = cargarFacturasDesdeSheet;
    cargarFacturasDesdeSheet = function() {
      const result = oldLoad();
      if (result && result.then) {
        return result.then(() => {
          updateCounters();
          return result;
        });
      } else {
        updateCounters();
        return result;
      }
    }
  }
  updateCounters();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btnRegresarPago = document.querySelector("#seccionPagoFacturas button");
  if (btnRegresarPago && btnRegresarPago.textContent.includes("Regresar al Men√∫ Principal")) {
    btnRegresarPago.addEventListener("click", () => {

      // Ocultar la secci√≥n de pago si sigue visible
      const pagoSection = document.getElementById("seccionPagoFacturas");
      if (pagoSection) {
        pagoSection.style.display = "none";
      }

      // Ocultar cualquier otra secci√≥n activa
      document.querySelectorAll(".seccion").forEach(seccion => {
        if (seccion !== pagoSection) {
          seccion.style.display = "none";
        }
      });

      // Mostrar el men√∫ y restaurar su formato visual
      const menu = document.getElementById("menuPrincipal");
      if (menu) {
        menu.style.display = "flex";
        menu.style.flexDirection = "column";
        menu.style.alignItems = "center";
        menu.style.justifyContent = "center";
        menu.style.gap = "20px";
      }
    });
  }
});
</script><script>
function toggleAllPagoCheckboxes(source) {
  const checkboxes = document.querySelectorAll(".check-factura-pago");
  checkboxes.forEach(cb => cb.checked = source.checked);
}

function cargarPagoFacturas() {
  // Mostrar overlay con texto seg√∫n carga
  const overlay = document.getElementById("overlayPago");
  const textEl = document.getElementById("overlayTextPago");
  textEl.textContent = window.isFirstLoadPagoFacturas ? "Cargando informaci√≥n" : "Actualizando informaci√≥n";
  overlay.style.display = "flex";
  window.isFirstLoadPagoFacturas = false;
  // Cargar datos y ocultar overlay
  if(window.loadDataPagoFacturas) {
    window.loadDataPagoFacturas()
      .then(() => { overlay.style.display = "none"; })
      .catch(() => { overlay.style.display = "none"; });
}

  
  
  
  // Resetear filtros al entrar en Pago de Facturas
  if (document.getElementById('filtroSectorPago')) document.getElementById('filtroSectorPago').value = 'Todos';
  if (document.getElementById('filtroEstadoPago')) document.getElementById('filtroEstadoPago').value = 'Todos';
  if (document.getElementById('filtroNumeroPago')) document.getElementById('filtroNumeroPago').value = '';
  if (window.flatpickrPago) flatpickrPago.clear();
  // Resetear contadores de cantidad
  if (document.getElementById('contadorPendientes')) document.getElementById('contadorPendientes').textContent = '0';
  if (document.getElementById('contadorPagadas')) document.getElementById('contadorPagadas').textContent = '0';
  // Resetear contadores de sumas
  if (document.getElementById('totalRevisada')) document.getElementById('totalRevisada').textContent = 'L 0.00';
  if (document.getElementById('totalPagada'))  document.getElementById('totalPagada').textContent  = 'L 0.00';

mostrarSeccion('seccionPagoFacturas');
  // Mostrar tabla y cargar datos
  var ft = document.getElementById('facturas-table'); if(ft) ft.style.display = 'block';
  if(window.tabulatorTable){ window.tabulatorTable.clearFilter(true); window.tabulatorTable.clearSort(); window.tabulatorTable.clearData(); }
  const seccion = document.getElementById("seccionPagoFacturas");
  if (seccion) seccion.style.display = "block";

  const spinner = document.getElementById("spinnerPago");
  const tabla = document.getElementById("facturas-table");
  const tbody = tabla ? tabla.querySelector("tbody") : null;

  if (!tabla || !tbody || !spinner) return;

  spinner.style.display = "block";
  tabla.style.display = "table";
  fetch("https://repositorio-de-pruebas.pages.dev/api/leer")
    .then(response => {
      if (!response.ok) throw new Error("HTTP " + response.status);
      return response.json();
    })
    .then(data => {
      if (!Array.isArray(data)) throw new Error("La respuesta no es un array v√°lido");
      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='12'>‚ö†Ô∏è No hay facturas para mostrar</td></tr>";
        return;
      
        // Limpiar filas previas s√≥lo cuando llegan los datos nuevos
        tbody.innerHTML = "";
        }

      
      const filtradas = data.filter(factura => {
        const estado = (factura["Estado"] || "").toString().trim().toLowerCase();
        return estado === "revisada" || estado === "pagada";
      });
      // Cargar filtros de sector din√°micamente
      cargarFiltrosSectorPago(filtradas);
      // Actualizar contadores de Pago de Facturas
      const pendientes = filtradas.filter(f => f.Estado === 'Revisada').length;
      const pagadas = filtradas.filter(f => f.Estado === 'Pagada').length;
      document.getElementById('contadorPendientes').textContent = pendientes;
      document.getElementById('contadorPagadas').textContent = pagadas;

      
  // Actualizar totales seg√∫n filtros
  let sumPend = 0, sumPag = 0;
  document.querySelectorAll('#tablaPagoFacturas tbody tr').forEach(tr => {
    if (tr.style.display === 'none') return;
    const sel = tr.querySelector('select.estado-select');
    const amount = parseFloat(tr.children[7].textContent.replace(/[^0-9.\-]/g, '')) || 0;
    if (sel && sel.value === 'Revisada') sumPend += amount;
    if (sel && sel.value === 'Pagada') sumPag += amount;
  });
  document.getElementById('totalRevisada').textContent = 'L ' + sumPend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('totalPagada').textContent   = 'L ' + sumPag.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

const totalRevisada = filtradas.filter(f => f.Estado === 'Revisada').reduce((s, f) => s + parseFloat(f['Total Gastado'] || 0), 0);
      const totalPagada  = filtradas.filter(f => f.Estado === 'Pagada').reduce((s, f) => s + parseFloat(f['Total Gastado'] || 0), 0);
      document.getElementById('totalRevisada').textContent = 'L ' + totalRevisada.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('totalPagada').textContent = 'L ' + totalPagada.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });


filtradas.forEach((f, index) => {
        const fila = document.createElement("tr");
        const fecha = f.Fecha ? new Date(f.Fecha).toLocaleDateString("es-ES") : "";
        const totalGastado = "L " + parseFloat(f["Total Gastado"] || 0).toFixed(2);
        const enlace = f["Enlace PDF"] ? `<a href="${f["Enlace PDF"]}" target="_blank">üìÑ Ver PDF</a>` : "";

        fila.innerHTML = `
          <td><input type="checkbox" class="check-factura-pago"></td>
          <td>${index + 1}</td>
          <td>${f.Sector || ""}</td>
          <td>${f.Placa || ""}</td>
          <td>${f.Proceso || ""}</td>
          <td>${f.Nombre || ""}</td>
          <td>${f.Identidad || ""}</td>
          <td style="text-align:right;">${totalGastado}</td>
          <td>${fecha}</td>
          <td>${f["Numero de Factura"] || ""}</td>
          <td>${enlace}</td>
          <td>
      <select class="estado-select" data-fila="${f.fila}">
        <option value="Revisada" ${f.Estado === 'Revisada' ? 'selected' : ''}>Revisada</option>
        <option value="Pagada"   ${f.Estado === 'Pagada'   ? 'selected' : ''}>Pagada</option>
      </select>
    </td>
        `;
        tbody.appendChild(fila);
      });

      // Asignar listener para actualizar estado en Pago de Facturas
      document.querySelectorAll('#tablaPagoFacturas .estado-select').forEach(sel => {
        sel.addEventListener('change', e => {
          actualizarEstadoIndividual(e.target.dataset.fila, e.target.value);
        });
      });
    })
    .catch(err => {
      tbody.innerHTML = "<tr><td colspan='12'>‚ùå Error cargando datos: " + err.message + "</td></tr>";
    })
    .finally(() => {
      spinner.style.display = "none";
    });
}
</script>
<script>
// Update counters based on Tabulator's internal data
function updateCountersPago() {
  const data = window.tabulatorTable.getData("active");
  let pendientes = 0, pagadas = 0;
  let sumPend = 0, sumPag = 0;
  data.forEach(f => {
    if (f.Estado === 'Revisada') {
      pendientes++;
      sumPend += parseFloat(f['Total Gastado'] || 0);
    }
    if (f.Estado === 'Pagada') {
      pagadas++;
      sumPag += parseFloat(f['Total Gastado'] || 0);
    }
  });
  document.getElementById('contadorPendientes').textContent = pendientes;
  document.getElementById('contadorPagadas').textContent = pagadas;
  document.getElementById('totalRevisada').textContent = 'L ' + sumPend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('totalPagada').textContent   = 'L ' + sumPag.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
</script>
<script>
// Aplica filtros sobre filas existentes de Pago de Facturas
function aplicarFiltrosPago() {
  const sector = document.getElementById('filtroSectorPago').value;
  const estado = document.getElementById('filtroEstadoPago').value;
  const numFact = document.getElementById('filtroNumeroPago').value.toLowerCase();
  const fechas = window.flatpickrPago ? window.flatpickrPago.selectedDates : [];
  let pendientes=0, pagadas=0;
  document.querySelectorAll('#tablaPagoFacturas tbody tr').forEach(tr => {
    const cols = tr.children;
    const rowSector = cols[2].textContent.trim();
    const rowEstado = cols[11].querySelector('select').value;
    const rowFactura = cols[9].textContent.toLowerCase();
    const rowFecha = new Date(cols[8].textContent.split('/').reverse().join('-'));
    let visible = true;
    if (sector !== 'Todos' && rowSector !== sector) visible = false;
    if (estado !== 'Todos' && rowEstado !== estado) visible = false;
    if (numFact && !rowFactura.includes(numFact)) visible = false;
    if (fechas.length === 2) {
      const [start, end] = fechas;
      if (!(rowFecha >= start && rowFecha <= end)) visible = false;
    }
    tr.style.display = visible ? '' : 'none';
    if (visible) {
      if (rowEstado === 'Revisada') pendientes++;
      if (rowEstado === 'Pagada') pagadas++;
    }
  });
  document.getElementById('contadorPendientes').textContent = pendientes;
  document.getElementById('contadorPagadas').textContent = pagadas;

  // Actualizar totales seg√∫n filtros
  let sumPend = 0, sumPag = 0;
  document.querySelectorAll('#tablaPagoFacturas tbody tr').forEach(tr => {
    if (tr.style.display === 'none') return;
    const sel = tr.querySelector('select.estado-select');
    const amount = parseFloat(tr.children[7].textContent.replace(/[^0-9.\-]/g, '')) || 0;
    if (sel && sel.value === 'Revisada') sumPend += amount;
    if (sel && sel.value === 'Pagada') sumPag += amount;
  });
  document.getElementById('totalRevisada').textContent = 'L ' + sumPend.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  document.getElementById('totalPagada').textContent   = 'L ' + sumPag.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

}
// Inicializar filtros y flatpickr
document.addEventListener('DOMContentLoaded', () => {
  window.flatpickrPago = flatpickr('#filtroFechaPago', { mode:'range', dateFormat:'d/m/Y', locale:flatpickr.l10ns.es, onChange: aplicarFiltrosPago });
  document.getElementById('filtroSectorPago').addEventListener('change', aplicarFiltrosPago);
  document.getElementById('filtroEstadoPago').addEventListener('change', aplicarFiltrosPago);
  document.getElementById('filtroNumeroPago').addEventListener('input', aplicarFiltrosPago);
});
</script>
<script>
// Poblaci√≥n de filtro de sector en Pago de Facturas
function cargarFiltrosSectorPago(data) {
  const filtro = document.getElementById("filtroSectorPago");
  if (!filtro) return;
  const sectores = Array.from(new Set(data.map(f => f.Sector))).sort();
  filtro.innerHTML = '<option value="Todos">Todos</option>';
  sectores.forEach(sector => {
    const opt = document.createElement("option");
    opt.value = sector;
    opt.textContent = sector;
    filtro.appendChild(opt);
  });
}
</script>
<script>
// Tabulator setup for Pago de Facturas
document.addEventListener("DOMContentLoaded", function(){
  var isGroupView = false;
  var btnGroup = document.getElementById("btnAgruparColaborador");
  if(btnGroup){
    btnGroup.addEventListener("click", function(){
      isGroupView = !isGroupView;
      if(isGroupView){
        table.setGroupBy("Identidad");
      } else {
        table.setGroupBy(false);
      }
      updateCounters();
    });
  }

  // Hide original elements
  var tbl = document.getElementById("facturas-table");
  if(tbl) tbl.style.display = "none";

  // Init flatpickr
  window.flatpickrPago = flatpickr("#filtroFechaPago", {
    mode: "range", dateFormat: "Y-m-d", locale: flatpickr.l10ns.es,
    onClose: function(){ window.applyFilters(); }
  });

  // Create Tabulator
  var table = new Tabulator("#facturas-table", {
    layout: "fitColumns", selectable: true, height: "500px", virtualDom: true, placeholder: "",
    
groupHeader:function(value, count, data){
    // Obtener nombre completo
    var fullName = data.find(r => r.Identidad === value && r.Nombre).Nombre;
    // Calcular total y formatear con separadores de miles
    var total = data.reduce((sum, row) => sum + (parseFloat(row["Total Gastado"])||0), 0);
    var formattedTotal = total.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    return `${fullName} - ${value} - ${count} factura(s) - Total: L ${formattedTotal}`;
},

    columns: [
      {formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false},
      {title:"#", formatter:"rownum", width:50},
      {title:"Sector", field:"Sector"},
      {title:"Placa", field:"Placa"},
      {title:"Proceso", field:"Proceso"},
      {title:"Nombre", field:"Nombre"},
      {title:"Identidad", field:"Identidad"},
      {
    title: "Total Gastado",
    field: "Total Gastado",
    sorter: "number",
    formatter: "money",
    formatterParams: {
        symbol: "L ",
        symbolAfter: false,
        thousand: ",",
        decimal: ".",
        precision: 2
    }
},
      {
    title: "Fecha",
    field: "Fecha", sorter:"string",
    formatter: function(cell) {
        var v = cell.getValue();
        return v ? v.split("T")[0] : "";
    }
},
      {title:"N√∫mero de Factura", field:"Numero de Factura"},
      {title:"Enlace PDF", field:"Enlace PDF", formatter: cell => {
          var v = cell.getValue();
          return v?`<a href="${v}" target="_blank">üìÑ</a>`:"";
      }},
        {title:"Estado", field:"Estado", hozAlign:"center",
            formatter:function(cell){
              var v = (cell.getValue()||"").toLowerCase();
              return v==="pagada" ? "Pagado" : '<button class="btn-pagar">Pagar</button>';
            },
            cellClick:function(e, cell){
              var v = (cell.getValue()||"").toLowerCase();
              if(v === "pagada"){
                // Ya pagada: no permitir acci√≥n
                return;
              }
              showModalPago(cell.getRow().getData());
           }
        },
    ],
  });
  window.tabulatorTable = table;
    // Ocultar overlay cuando la tabla termine de renderizar datos
    table.on("dataRendered", function(){ document.getElementById("overlayPago").style.display = "none"; });
  // Mostrar u ocultar bot√≥n 'Pagar Facturas' seg√∫n selecci√≥n
  table.on("rowSelectionChanged", function(data){
    var btn = document.getElementById("btn-pagar-facturas");
    btn.style.display = data.length > 0 ? "inline-block" : "none";
  });

  // Acci√≥n del bot√≥n para marcar facturas como pagadas masivamente
  document.getElementById("btn-pagar-facturas").addEventListener("click", async function(){
    var selectedRows = table.getSelectedRows();
    var filas = selectedRows.map(row => row.getData().fila);
    this.style.display = "none";
    await actualizarEstadoMultiple(filas, "Pagada");
    selectedRows.forEach(function(row){
      row.update({Estado: "Pagada"});
    });
  });


  var isGroupView = false;
  


  // Load data function
  function loadDataPagoFacturas(){
  return fetch(urlLeerFacturas)
      .then(r=>r.json())
      .then(data=>{
        var rows = data.filter(f=>["Revisada","Pagada"].includes(f.Estado));
        window.facturasGlobal = rows;
        populateSector(rows);
        table.setData(rows).then(updateCounters);
      });
  window.loadDataPagoFacturas = loadDataPagoFacturas;
  }

  // Populate sector filter
  function populateSector(data){
    var sel = document.getElementById("filtroSectorPago");
    if(!sel) return;
    sel.innerHTML = '<option value="Todos">Todos</option>';
    Array.from(new Set(data.map(r=>r.Sector))).sort().forEach(s=>{
      sel.add(new Option(s,s));
    });
  }

  // Apply filters
  window.applyFilters = function(){
    var filters = [];
    var s = document.getElementById("filtroSectorPago").value;
    if(s!="Todos") filters.push({field:"Sector",type:"=",value:s});
    var e = document.getElementById("filtroEstadoPago").value;
    if(e!="Todos") filters.push({field:"Estado",type:"=",value:e});
    var n = document.getElementById("filtroNumeroPago").value;
    if(n) filters.push({field:"Numero de Factura",type:"like",value:n});
    var d = flatpickrPago.selectedDates || [];
    if (d.length) {
      var start = d[0].toISOString().split("T")[0];
      var end   = (d.length === 2) ? d[1].toISOString().split("T")[0] : start;
 
     if (start === end) {
       // un solo d√≠a: coincide cualquier hora de ese d√≠a
       filters.push({ field:"Fecha", type:"like", value:start });
     } else {
       // rango completo desde inicio hasta fin del d√≠a
       filters.push({ field:"Fecha", type:">=", value:start + "T00:00:00" });
       filters.push({ field:"Fecha", type:"<=", value:end   + "T23:59:59" });
     }
   }
    if(filters.length) table.setFilter(filters);
    else table.clearFilter(true);
    updateCounters();
  };

  // Update counters
  function updateCounters(){
    var data = table.getData("active"), p=0, g=0, sp=0, sg=0;
    data.forEach(r=>{
      if(r.Estado==="Revisada"){p++; sp+=parseFloat(r["Total Gastado"]||0);}
      if(r.Estado==="Pagada"){g++; sg+=parseFloat(r["Total Gastado"]||0);}
    });
    document.getElementById("contadorPendientes").textContent = p;
    document.getElementById("contadorPagadas").textContent   = g;
    document.getElementById("totalRevisada").textContent    = "L "+sp.toLocaleString("es-HN",{minimumFractionDigits:2});
    document.getElementById("totalPagada").textContent      = "L "+sg.toLocaleString("es-HN",{minimumFractionDigits:2});
  }

  // Hook filters
  ["filtroSectorPago","filtroEstadoPago"].forEach(id=>{
    document.getElementById(id).addEventListener("change",applyFilters);
  });
  document.getElementById("filtroNumeroPago").addEventListener("input",applyFilters);
  // Expose loadData for manual trigger
  window.loadDataPagoFacturas = loadDataPagoFacturas;
  // Initial load removed to defer loading until button click
});
</script>
<script>
// Exportar datos filtrados de la tabla a Excel
document.getElementById('exportExcelBtn').addEventListener('click', function() {
  window.tabulatorTable.download("xlsx", "facturas.xlsx", {
    sheetName: "Facturas",
    data: window.tabulatorTable.getData(true),
  });
});
</script>
<script>
  // Endpoint definitions moved here
  const urlLeerFacturas = "https://repositorio-de-pruebas.pages.dev/api/leer";
const urlGuardarReporte = "/api/guardar";
// Tabulator setup for Revisi√≥n de Facturas
document.addEventListener("DOMContentLoaded", function(){
  var tableRevision = window.tableRevision = new Tabulator("#tablaRevisionFacturas", {
    layout: "fitColumns",
    height: "60vh",
    // Use fetch directly to avoid CORS preflight by removing custom headers
    selectable: true,
    columns: [
      {formatter: "rowSelection", titleFormatter: "rowSelection", hozAlign: "center", headerSort: false},
      {formatter: "rownum", title: "#", hozAlign: "center", width: 40},
      {title: "Sector", field: "Sector"},
      {title: "Placa", field: "Placa"},
      {title: "Proceso", field: "Proceso"},
      {title: "Nombre", field: "Nombre"},
      {title: "Identidad", field: "Identidad"},
      {title: "Total Gastado", field: "Total Gastado", formatter: "money", formatterParams: {symbol: "L", symbolAfter: false, thousand: ",", decimal: ".", precision: 2}},
      {title: "Fecha", field: "Fecha", formatter: function(cell){ var v = cell.getValue(); 
window.tableRevision = tableRevision;
return v?v.split("T")[0]:""; }},
      {title:"N√∫mero de Factura", field:"Numero de Factura"},
      {title: "Enlace PDF", field: "Enlace PDF", formatter: function(cell){ var v = cell.getValue(); return v?'<a href="'+v+'" target="_blank">üìÑ</a>':""; }},
      {title: "Estado", field: "Estado", editor: "list", editorParams: {values: ["Registrada","Revisada","Anulada"], autocomplete: true}, cellEdited: function(cell){ var d = cell.getRow().getData(); actualizarEstadoIndividual(d.fila, cell.getValue()); }}
    ],
  });

  // Hide any loading overlay after data render
  tableRevision.on("dataRendered", function(){ 
    var overlay = document.getElementById("overlayCambios");
    if(overlay) overlay.style.display = "none";
  });

  // Hook filter inputs to Tabulator filters
  var filtroEstado = document.getElementById("filtroEstado");
  if(filtroEstado) {
    filtroEstado.addEventListener("change", function(){
      if(this.value === "Todas"){
        tableRevision.clearFilter(true);
      } else {
        tableRevision.setFilter("Estado", "=", this.value);
      }
    });
  }
  // Hook change listener for sector filter
  var sectorSelect = document.getElementById("filtroSector");
  if (sectorSelect) {
    sectorSelect.addEventListener("change", function(){
      if (this.value === "") {
        tableRevision.clearFilter(true);
      } else {
        tableRevision.setFilter("Sector", "=", this.value);
      }
    });
  }
  // Populate sector filter options when data loads
  tableRevision.on("dataLoaded", function(data){ if(!Array.isArray(data)) return;  if(!Array.isArray(data)) return; var sectorSelect = document.getElementById("filtroSector");
    if (!sectorSelect) return;
    // Reset options except default
    var length = sectorSelect.options.length;
    for(var i=length-1; i>0; i--){
      sectorSelect.remove(i);
    }
    var sectors = data.map(function(r){ return r.Sector; })
      .filter(function(v, i, a){ return v && a.indexOf(v)===i; })
      .sort();
    sectors.forEach(function(s){
      var opt = document.createElement("option");
      opt.value = s;
      opt.text = s;
      sectorSelect.add(opt);
    });
  });
  // Hook change listener for estado filter
  var estadoSelect = document.getElementById("filtroEstado");
  if (estadoSelect) {
    estadoSelect.addEventListener("change", function(){
      if (this.value === "") {
        tableRevision.clearFilter(true);
      } else {
        tableRevision.setFilter("Estado", "=", this.value);
      }
    });
  }
  // Populate estado filter options when data loads
  tableRevision.on("dataLoaded", function(data){ if(!Array.isArray(data)) return; 
    var estadoSelect = document.getElementById("filtroEstado");
    if (!estadoSelect) return;
    // Reset options except default
    for (var i = estadoSelect.options.length - 1; i > 0; i--) {
      estadoSelect.remove(i);
    }
    var estados = data.map(function(r){ return r.Estado; })
      .filter(function(v, i, a){ return v && a.indexOf(v)===i; })
      .sort();
    estados.forEach(function(e){
      var opt = document.createElement("option");
      opt.value = e;
      opt.text = e;
      estadoSelect.add(opt);
    });
  // Reconstructed filter for N√∫mero de Factura (Revisi√≥n)
  var filtroNum = document.getElementById("filtroNumeroFactura");
  if (filtroNum) {
    filtroNum.addEventListener("input", function() {
      var val = this.value;
      tableRevision.clearFilter(true);
      if (val) {
        tableRevision.setFilter("Numero de Factura", "like", val);
      }
    });
  }
  // Clear number filter input on data load
  tableRevision.on("dataLoaded", function() {
    var filtroNum = document.getElementById("filtroNumeroFactura");
    if (filtroNum) filtroNum.value = "";
  });
  });
  var filtroNumero = document.getElementById("filtroNumeroFactura");
  if(filtroNumero) {
    filtroNumero.addEventListener("input", function(){
      tableRevision.setFilter("N√∫mero de Factura", "like", this.value);
    });
  }
  // Date range filter initialization
  var rangoInput = document.getElementById("rangoFechas");
  if (rangoInput) {
    flatpickr("#rangoFechas", {
      mode: "range",
      dateFormat: "Y-m-d",
      locale: flatpickr.l10ns.es,
      onClose: function(selectedDates, dateStr) {
        // Clear previous filters
        tableRevision.clearFilter(true);
        if (selectedDates.length === 2) {
          var start = selectedDates[0].toISOString().split("T")[0];
          var end = selectedDates[1].toISOString().split("T")[0];
          tableRevision.addFilter("Fecha", ">=", start);
          tableRevision.addFilter("Fecha", "<=", end);
        }
      }
    });
  }

});
</script>

<!-- ==== Patch v20: cumulative filters + single-day fix === -->
<script>
document.addEventListener("DOMContentLoaded", function(){

  // Locate Tabulator instance for #tablaRevisionFacturas
  var tableElem = document.querySelector("#tablaRevisionFacturas");
  if(!tableElem){
    console.warn("Patch v20: table element #tablaRevisionFacturas not found");
    return;
  }
  var tableArray = Tabulator.findTable(tableElem);
  if(!tableArray.length){
    console.warn("Patch v20: Tabulator instance not yet available");
    return;
  }
  var table = tableArray[0];

  // Flatpickr setup (range mode)
  var dateInput = document.getElementById("rangoFechas");
  if(dateInput){
    if(!window.flatpickrRevision){
        window.flatpickrRevision = flatpickr(dateInput,{
          mode:"range",
          dateFormat:"Y-m-d",
          locale: flatpickr.l10ns.es,
          onClose: function(){ applyFiltersRevision(); }
        });
    }else{
        dateInput._flatpickr.set("onClose", [function(){ applyFiltersRevision(); }]);
    }
  }

  // Core function
  function applyFiltersRevision(){
      var filters = [];

      // Sector
      var sector = (document.getElementById("filtroSector")||{}).value || "";
      if(sector && sector !== "Todos") filters.push({field:"Sector", type:"=", value:sector});

      // Estado
      var estado = (document.getElementById("filtroEstado")||{}).value || "";
      if(estado && estado !== "Todos") filters.push({field:"Estado", type:"=", value:estado});

      // Numero Factura
      var num = (document.getElementById("filtroNumeroFactura")||{}).value || "";
      if(num) filters.push({field:"Numero de Factura", type:"like", value:num.trim()});

      // Fecha
      var dr = window.flatpickrRevision ? window.flatpickrRevision.selectedDates : [];
      if(dr && dr.length){
         var start = flatpickr.formatDate(dr[0],"Y-m-d");
         var end   = (dr.length === 2) ? flatpickr.formatDate(dr[1],"Y-m-d") : start;

         if(start === end){
           // Un solo d√≠a: usar LIKE para evitar problemas con hora
           filters.push({field:"Fecha", type:"like", value:start});
         }else{
           // Rango: usar >= y <= con tiempo definido
           filters.push({field:"Fecha", type:">=", value:start + "T00:00:00"});
           filters.push({field:"Fecha", type:"<=", value:end   + "T23:59:59"});
         }
      }

      // Aplicar o limpiar
      if(filters.length){
        table.setFilter(filters);
      }else{
        table.clearFilter(true);
      }
  }

  // Attach listeners (en fase capture para anular previos)
  ["filtroSector","filtroEstado"].forEach(id=>{
     var el = document.getElementById(id);
     if(el){
        el.addEventListener("change", function(e){
          e.stopImmediatePropagation();
          applyFiltersRevision();
        }, true);
     }
  });
  var numEl = document.getElementById("filtroNumeroFactura");
  if(numEl){
     numEl.addEventListener("input", function(e){
       e.stopImmediatePropagation();
       applyFiltersRevision();
     }, true);
  }

  // Expose for debugging
  window.applyFiltersRevision = applyFiltersRevision;
});
</script>
<!-- ==== End Patch v20 === -->
<!-- ==== Clean Counters Rebuild v25 ==== -->
<script>
(function(){
  const COUNTER_IDS = {
    "registrada":"counterRegistradas",
    "revisada":"counterRevisadas",
    "anulada":"counterAnuladas"
  };

  function recalc(tab){
    const data = tab.getData("active");
    const counts = {registrada:0,revisada:0,anulada:0};
    data.forEach(function(row){
      const est = String(row.Estado||"").trim().toLowerCase();
      if(counts.hasOwnProperty(est)) counts[est]++;
    });
    Object.keys(COUNTER_IDS).forEach(function(key){
      const el = document.getElementById(COUNTER_IDS[key]);
      if(el) el.textContent = counts[key];
    });
  }

  function init(){
    const tab = Tabulator.findTable("#tablaRevisionFacturas")[0];
    if(!tab){
      setTimeout(init, 300);
      return;
    }

    // Wait until data is present at least once
    (function waitData(){
      if(tab.getData().length === 0){
        setTimeout(waitData, 300);
      }else{
        recalc(tab);
      }
    })();

    // Hook events
    tab.on("dataFiltered", () => recalc(tab));
    tab.on("renderComplete", () => recalc(tab));
    tab.on("dataLoaded", () => recalc(tab));
    tab.on("cellEdited", () => recalc(tab));
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
<!-- ==== End Clean Counters Rebuild v25 ==== -->
<!-- ==== Patch v34: actualizar estado en Revisi√≥n de Facturas ==== -->
<script>
(function(){
  // Si ya existe actualizarEstadoIndividual, reutilizarlo
  if(typeof window.actualizarEstadoIndividual === "function") return;

  const ENDPOINT = typeof urlGuardarReporte !== "undefined" ? urlGuardarReporte : "/api/guardar";

  async function actualizarEstadoIndividual(fila, nuevoEstado){
    const overlay = document.getElementById("overlayCambios");
    if(overlay) overlay.style.display = "flex";
    try{
      const resp = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ actualizarEstado: true, fila: fila, nuevoEstado: nuevoEstado })
      });
      const result = await resp.json().catch(()=>({status:"ERROR"}));
      console.log("Respuesta actualizaci√≥n", result);
      if(result.status !== "OK"){
        alert("Error al actualizar estado: " + (result.message || JSON.stringify(result)));
        return;
      }
      // Sincronizar tabla Revisi√≥n si existe
      try{
        const tab = Tabulator.findTable("#tablaRevisionFacturas")[0];
        if(tab){
          // Buscar por campo fila
          const row = tab.getRows().find(r=>{
            const d = r.getData();
            return String(d.fila) === String(fila) || String(d._fila) === String(fila);
          });
          if(row) row.update({Estado: nuevoEstado});
        }
      }catch(e){}
    }catch(err){
      console.error("Fall√≥ la actualizaci√≥n de estado", err);
      alert("No se pudo guardar el cambio. Intenta nuevamente.");
    }finally{
      if(overlay) overlay.style.display = "none";
      if(typeof updateCountersRevision === "function") updateCountersRevision();
    }
  }

  // Exponer global
  window.actualizarEstadoIndividual = actualizarEstadoIndividual;
})();
</script>
<!-- ==== Fin Patch v34 ==== -->
<!-- ==== Patch v36: Counters Pago live on Estado edit ==== -->
<script>
document.addEventListener("DOMContentLoaded", function(){
  function hookPago(){
    if(!window.tabulatorTable){ setTimeout(hookPago, 300); return; }
    if(window.tabulatorTable._pagoHookAttached) return;
    window.tabulatorTable._pagoHookAttached = true;

    // Recalculate counters when Estado changes
    window.tabulatorTable.on("cellEdited", function(cell){
      if(cell.getField() === "Estado" && typeof updateCountersPago === "function"){
        updateCountersPago();
      }
    });

    // Also recalc after filters applied via applyFiltrosPago if exists
    if(typeof aplicarFiltrosPago === "function"){
      const old = aplicarFiltrosPago;
      aplicarFiltrosPago = function(){
        old();
        if(typeof updateCountersPago === "function") updateCountersPago();
      };
    }
  }
  hookPago();
});
</script>
<!-- ==== End Patch v36 ==== -->
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const $=id=>document.getElementById(id);
  const money=v=>'L '+Number(v||0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  let tab;
  function overlay(s){$('overlayAnt').style.display=s?'flex':'none';}
  function cargar(){
    fetch(urlLeerAnticipos).then(r=>r.json()).then(d=>{
      if(tab){tab.replaceData(d);}else{
        tab=new Tabulator('#tablaAnticipos',{data:d,height:'55vh',layout:'fitColumns',columns:[
          {formatter:'rownum',width:50},
          {title:'Sector',field:'Sector'},
          {title:'Fondo',field:'Fondo'},
          {title:'Deposito',field:'Deposito',formatter:'money',formatterParams:{symbol:'L ',precision:2}},
          {title:'Periodo',field:'Periodo'},
          {title:'Estado',field:'Estado',editor:'list',editorParams:{values:['Vigente','Aplicado','Anulado']},
            cellEdited:c=>{const r=c.getRow().getData();actualizarEstado(r.fila||r._fila,c.getValue());}}
        ]});
      }
      resumen(d);
    });
  }
    function resumen(d){
    const t=d.reduce((s,r)=>s+Number(r.Deposito||0),0);
    const sld=d.filter(r=>r.Estado==='Vigente').reduce((s,r)=>s+Number(r.Deposito||0),0);
    $('antTotal').textContent=money(t); $('antSaldo').textContent=money(sld);
  }
  function registrar(){
  var ov = document.getElementById("overlayAnt");
  ov.querySelector("span").textContent = "Registrando cambios";
  ov.style.display = "flex";

  fetch(urlGuardarAnticipo, { method:"POST" })
    .then(function(res){ return res.json(); })
    .then(function(res){ if(res.status !== "OK") throw new Error(res.message); })
    .catch(function(err){ console.error("Error al registrar:", err); })
    .finally(function(){ cargarAnticipos(); });
};
  $('btnBackAnt').addEventListener('click',()=>{ $('registrarAnticipo').style.display='none'; $('menuPrincipal').style.display='flex';});
  
// populate periodo select
const perSel=document.getElementById('antPeriodo');
if(perSel && perSel.options.length<=1){
  const today=new Date();
  for(let i=0;i<18;i++){
    const d=new Date(today.getFullYear(), today.getMonth()-i,1);
    const val=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
    const opt=document.createElement('option');opt.value=val;opt.textContent=val;perSel.appendChild(opt);
  }
}
$('btnAddAnt').addEventListener
('click',registrar);
});
</script>
<script>

// Cargar sectores para anticipos (est√°tico)
function cargarSectoresAnticipo() {
  const sel = document.getElementById('antSector');
  sel.innerHTML = '<option value="">Seleccione</option>';
  const opciones = ["SAN PEDRO SULA", "EL PROGRESO", "STA. CRUZ", "CHOLUTECA", "COMAYAGUA", "DANLI", "GUANAJA", "JUTICALPA", "LA CEIBA", "SANTA ROSA", "TEGUCIGALPA", "TOCOA", "BRUS LAGUNA"];
  opciones.forEach(s => sel.add(new Option(s, s)));
}

// Poner opciones de fondo
function poblarFondo() {
  const sel = document.getElementById('antFondo');
  sel.innerHTML = '<option value="">Seleccione</option><option value="Combustible">Combustible</option><option value="Poda">Poda</option>';
}
// Generar lista de √∫ltimos 12 periodos en formato yyyyMM
function poblarPeriodoAnticipo() {
  const sel = document.getElementById('antPeriodo');
  sel.innerHTML = '<option value="">Seleccione</option>';
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    let date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const ym = date.getFullYear().toString() + (date.getMonth() + 1).toString().padStart(2,'0');
    sel.add(new Option(ym, ym));
  }
}
// Mostrar secci√≥n al pulsar el bot√≥n y cargar datos
document.getElementById('btnIrRegistrarAnticipo').addEventListener('click', function(){
  document.getElementById('menuPrincipal').style.display = 'none';
  const sec = document.getElementById('registrarAnticipo');
  sec.style.display = 'flex';
  cargarSectoresAnticipo();
  poblarFondo();
  poblarPeriodoAnticipo();
});
</script>

<script>
// Flag de primera carga
window.isFirstLoadRevisionFacturas = true;

// Carga datos (fetch + setData) replicando l√≥gica de secci√≥n Pago
function loadDataRevisionFacturas(){
  return fetch(urlLeerFacturas)
    .then(r => r.json())
    .then(function(data){
      // Solo facturas que NO est√©n pagadas
      var rows = data.filter(function(f){
        return (f.Estado || "").toLowerCase().trim() !== "pagada";
      });
      // Guarda en global si lo necesitas
      window.revisionFacturasGlobal = rows;
      // Carga en tabla
      if(window.tableRevision && window.window.tableRevision.setData){
        return window.tableRevision.setData(rows).then(updateCountersRevision);
      }
    });
}

// Overlay helper
function mostrarOverlayRevision(modo){
  var overlay = document.getElementById('overlayRevision');
  var textEl  = document.getElementById('overlayTextRevision');
  if(!overlay || !textEl) return;
  textEl.textContent = (modo === 'init') ? 'Cargando informaci√≥n' : 'Actualizando informaci√≥n';
  overlay.style.display = 'flex';
}



// Actualiza contadores de revisi√≥n
function updateCountersRevision(){
   var data = window.tableRevision ? window.tableRevision.getData("active") : window.revisionFacturasGlobal || [];
  var regs = 0, revisadas = 0, anuladas = 0;
  data.forEach(function(f){
    var e = (f.Estado || "").toLowerCase().trim();
    if(e === "registrada") regs++;
    else if(e === "revisada") revisadas++;
    else if(e === "anulada") anuladas++;
  });
  document.getElementById('counterRegistradas').textContent = regs;
  document.getElementById('counterRevisadas').textContent = revisadas;
  document.getElementById('counterAnuladas').textContent = anuladas;
}
// Bot√≥n o evento para entrar a secci√≥n
function cargarRevisionFacturas(){
  mostrarSeccion('revisionFacturas');
  const overlay = document.getElementById('overlayRevision');
  const textEl = document.getElementById('overlayTextRevision');
  textEl.textContent = window.isFirstLoadRevisionFacturas ? "Cargando informaci√≥n" : "Actualizando informaci√≥n";
  overlay.style.display = 'flex';
  window.isFirstLoadRevisionFacturas = false;

  
  // Limpiar datos previos en la tabla de revisi√≥n
  if(window.tableRevision){ window.tableRevision.clearData(); }
// Reset filtros
  document.getElementById('filtroSector').value = '';
  document.getElementById('filtroEstado').value = '';
  document.getElementById('filtroNumeroFactura').value = '';
  if(window.flatpickrRevision) flatpickrRevision.clear();

  // Reset contadores
  document.getElementById('counterRegistradas').textContent = '0';
  document.getElementById('counterRevisadas').textContent = '0';
  document.getElementById('counterAnuladas').textContent = '0';

  loadDataRevisionFacturas()
    .catch(function(err){ console.error('Error al cargar revisi√≥n de facturas:', err); })
    .finally(function(){
      overlay.style.display = 'none';
    });
}

// Ocultar overlay cuando datos renderizados (Tabulator event)
document.addEventListener('DOMContentLoaded', function(){
  if(window.tableRevision){
    tableRevision.on("dataRendered", function(){
      var overlay = document.getElementById('overlayRevision');
      if(overlay) overlay.style.display = 'none';
    });
  }
});
</script>



<script>
// Anticipos: Overlay y l√≥gica de carga
window.isFirstLoadAnticipo = true;

// Inicializar tabla vac√≠a al cargar
document.addEventListener("DOMContentLoaded", function(){
  window.tabAnticipos = new Tabulator("#tablaAnticipos", {
    height: "55vh",
    layout: "fitColumns",
    data: [],
    loader: false,
    columns: [
      {formatter:"rownum", width:50},
      {title:"Sector", field:"Sector"},
      {title:"Fondo", field:"Fondo"},
      {title:"Dep√≥sito", field:"Deposito", formatter:"money", formatterParams:{symbol:"L ", precision:2}},
      {title:"Periodo", field:"Periodo"},
      {title:"Estado", field:"Estado", editor:"list", editorParams:{values:["Vigente","Aplicado","Anulado"]},
        cellEdited:function(cell){
          var d = cell.getRow().getData();
          actualizarEstado(d.fila || d._fila, cell.getValue());
        }
      }
    ]
  });
  tabAnticipos.on("dataLoaded", function(rows){
    // Actualizar contadores antes de ocultar overlay
    var t = rows.reduce(function(sum, r){return sum + Number(r.Deposito||0);}, 0);
    var sld = rows.filter(function(r){return r.Estado==="Vigente";})
                  .reduce(function(sum, r){return sum + Number(r.Deposito||0);},0);
    document.getElementById("antTotal").textContent = "L " + t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById("antSaldo").textContent = "L " + sld.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById("overlayAnt").style.display = "none";
  });
});

// Cargar anticipos con overlay din√°mico
function cargarAnticipos(){
  mostrarSeccion("registrarAnticipo");
  var ov = document.getElementById("overlayAnt");
  var txt = ov.querySelector("span");
  txt.textContent = window.isFirstLoadAnticipo ? "Cargando informaci√≥n" : "Actualizando informaci√≥n";
  ov.style.display = "flex";
  window.isFirstLoadAnticipo = false;
  // Reset tabla y contadores al reingresar
  if(window.tabAnticipos) tabAnticipos.clearData();
  document.getElementById('antTotal').textContent = 'L 0.00';
  document.getElementById('antSaldo').textContent = 'L 0.00';
  // Fetch y poblar datos
  fetch(urlLeerAnticipos)
    .then(function(res){return res.json();})
    .then(function(data){
      tabAnticipos.clearData();
      tabAnticipos.setData(data);
    })
    .catch(function(err){ console.error("Error al cargar anticipos:", err); })
    .finally(function(){
      // overlay se oculta en dataLoaded listener
    });
}

// Navegaci√≥n
document.getElementById("btnIrRegistrarAnticipo").addEventListener("click", cargarAnticipos);
document.getElementById("btnBackAnt").addEventListener("click", function(){
  mostrarSeccion("menuPrincipal");
});

// Registro de anticipo
function registrar(){
  var ov = document.getElementById("overlayAnt");
  ov.querySelector("span").textContent = "Registrando cambios";
  ov.style.display = "flex";
  fetch(urlGuardarAnticipo, {method:"POST"})
    .then(function(res){return res.json();})
    .then(function(res){ if(res.status!=="OK") throw new Error(res.message); })
    .catch(function(err){ console.error("Error al registrar:", err); })
    .finally(cargarAnticipos);
}

// Actualizar estado
function actualizarEstado(fila, estado){
  var ov = document.getElementById("overlayAnt");
  ov.querySelector("span").textContent = "Registrando cambios";
  ov.style.display = "flex";
  fetch(urlGuardarAnticipo, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({fila:fila, Estado:estado})
  })
    .then(function(res){return res.json();})
    .then(function(res){ if(res.status!=="OK") throw new Error(res.message); })
    .catch(function(err){ console.error("Error al actualizar:", err); })
    .finally(cargarAnticipos);
}
</script>


<!-- Modal para registrar pago -->
<div id="modalPago">
  <div class="dialog">
    <h3>Registrar Pago</h3>
    
<label>Comprobante de pago:</label>
<div id="pasteArea" contenteditable="true" spellcheck="false" tabindex="0" style="border:1px dashed #ccc;padding:1rem;min-height:150px;text-align:center;position:relative;">
  <div class="placeholder-top" contenteditable="false">Arrastra o presiona Ctrl+V</div>
  <div class="placeholder-bottom" contenteditable="false"></div>
</div>
<button id="btnSelectFile" style="display:block;margin:0.5rem auto;padding:0.25rem 0.5rem;height:2rem;font-size:0.875rem;">Seleccionar archivo</button>
<input type="file" id="inputPagoImagen" accept="image/*" style="display:none"/>
<label>Fondo ‚Äì Periodo:<br>
      <select id="selectPagoFondo">
        <option value="">Seleccione</option>
      </select>
    </label>
    <div style="display:flex;justify-content:flex-end;gap:1rem">
      <button id="btnCancelarPago">Cancelar</button>
      <button id="btnAceptarPago">Aceptar</button>
    </div>
  </div>
</div>

<!-- Overlay ‚ÄúRegistrando Pago‚Ä¶‚Äù -->
<div id="overlayPagoRegistrando" style="
  visibility: hidden;
  opacity: 0;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 3000;
  transition: opacity 0.3s ease;
">
  <div class="spinner"></div>
  <div style="color:white; font-size:20px; font-weight:bold; margin-top:20px; text-align:center;">
    Registrando Pago...
  </div>
</div>

<script>
// Funciones para pago de facturas
let currentPagoRow = null;
function showModalPago(data) {
  currentPagoRow = data;
  // Cargar fondos asociados al sector
  fetch(urlLeerAnticipos)
    .then(res => res.json())
    .then(rows => {
      const sel = document.getElementById("selectPagoFondo");
      sel.innerHTML = '<option value="">Seleccione</option>';
      rows.filter(r => r.Sector && data.Sector && r.Sector.trim().toLowerCase() === data.Sector.trim().toLowerCase())
          .forEach(r => {
            const val = `${r.Fondo}-${r.Periodo}`;
            sel.appendChild(new Option(val, val));
          });
    });
  document.getElementById("inputPagoImagen").value = "";
  document.getElementById("modalPago").style.display = "flex";
}

document.getElementById("btnCancelarPago").onclick = () => {
  // Limpiar campos del modal
  document.getElementById("inputPagoImagen").value = "";
  const sel = document.getElementById("selectPagoFondo");
  sel.innerHTML = '<option value="">Seleccione</option>';
  const pasteArea = document.getElementById("pasteArea");
  pasteArea.innerHTML = '<div class="placeholder-top" contenteditable="false">Arrastra o presiona Ctrl+V</div><div class="placeholder-bottom" contenteditable="false"></div>';
  // Ocultar modal
  document.getElementById("modalPago").style.display = "none";
      // Recargar tabla de pagos para mostrar facturas pendientes y pagadas
      };


</script>


<script>
document.addEventListener("DOMContentLoaded", function(){
  const pasteArea = document.getElementById("pasteArea");
  const fileInput = document.getElementById("inputPagoImagen");
  // Paste support
  pasteArea.addEventListener("paste", function(e){
    e.preventDefault();
    if (e.clipboardData) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf("image") !== -1) {
          const blob = items[i].getAsFile();
          const dt = new DataTransfer();
          dt.items.add(blob);
          fileInput.files = dt.files;
          const url = URL.createObjectURL(blob);
          pasteArea.innerHTML = '<img src="'+url+'" style="max-width:100%;height:auto;"/>';
          // hide placeholders
          const top = pasteArea.querySelector(".placeholder-top");
          const bottom = pasteArea.querySelector(".placeholder-bottom");
          if (top) top.style.display = "none";
          if (bottom) bottom.style.display = "none";
          break;
        }
      }
    }
  });
  // Drag & drop support
  pasteArea.addEventListener("dragover", function(e){
    e.preventDefault();
  });
  pasteArea.addEventListener("drop", function(e){
    e.preventDefault();
    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
      const file = e.dataTransfer.files[0];
      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      const url = URL.createObjectURL(file);
      pasteArea.innerHTML = '<img src="'+url+'" style="max-width:100%;height:auto;"/>';
      const top = pasteArea.querySelector(".placeholder-top");
      const bottom = pasteArea.querySelector(".placeholder-bottom");
      if (top) top.style.display = "none";
      if (bottom) bottom.style.display = "none";
    }
  });
  // Button to open file selector
  const btn = document.getElementById("btnSelectFile");
  btn.addEventListener("click", function(){
    fileInput.click();
  });
});
</script>


<script>
// Handler para ‚ÄúAceptar Pago‚Äù
document.getElementById("btnAceptarPago").addEventListener("click", function() {
   // Mostrar overlay de registro
   const ov = document.getElementById("overlayPagoRegistrando");
   ov.style.visibility = "visible";
   ov.style.opacity    = 1;
  const sel = document.getElementById("selectPagoFondo");
  const fondoPeriodo = sel.value;
  if (!fondoPeriodo) {
    // Ocultar overlay si hay error
     ov.style.opacity    = 0;
     setTimeout(()=> ov.style.visibility = "hidden", 300);
    return alert("Seleccione un fondo-per√≠odo.");
  }
  const fecha = new Date().toISOString().substr(0,10);
  const payload = {
    fila: currentPagoRow.fila,
    fondoPeriodo: fondoPeriodo,
    fechaPago: fecha
  };

  fetch(urlGuardarFactura, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => {
    if (!res.ok) throw new Error("HTTP error " + res.status);
    return res.json();
  })
  .then(json => {
    if (json.status !== "OK") {
      throw new Error(json.message || "Error al guardar pago.");
    }
    // Actualiza la fila en la tabla
    const table = Tabulator.findTable("#facturas-table")[0];
    table.getRows().forEach(row => {
      const data = row.getData();
      if (data.fila === payload.fila) {
        row.update({
          Estado:    "Pagada",
          Fondo:     payload.fondoPeriodo,
          FechaPago: payload.fechaPago
        });
      }
    });
    // Limpia y cierra el modal
    document.getElementById("inputPagoImagen").value = "";
    sel.innerHTML = '<option value="">Seleccione</option>';
    const pa = document.getElementById("pasteArea");
    pa.innerHTML =
      '<div class="placeholder-top" contenteditable="false">Arrastra o presiona Ctrl+V</div>' +
      '<div class="placeholder-bottom" contenteditable="false"></div>';
    document.getElementById("modalPago").style.display = "none";
      // Recargar tabla de pagos para mostrar facturas pendientes y pagadas
      updateCountersPago();})
  .catch(err => {
    console.error("Error al guardar pago:", err);
    alert("Error al guardar pago: " + err.message);
   })
   .finally(() => {
     // Ocultar overlay al finalizar (√©xito o error)
     const ov = document.getElementById("overlayPagoRegistrando");
     ov.style.opacity = 0;
     setTimeout(() => ov.style.visibility = "hidden", 300);
   });
});
</script>

</body>
</html>
<div id="generando_pdf_modal" style="
  visibility: hidden;
  opacity: 0;
  position:fixed;
  top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:2000;
  transition: opacity 0.3s ease;">
<div class="spinner"></div>
<div style="color:white; font-size:20px; font-weight:bold; margin-top:20px;">
    Generando PDF, por favor espere...
  </div>
</div>
