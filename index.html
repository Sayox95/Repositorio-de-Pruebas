<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UTCD · Revisión de Facturas</title>
  <!-- Tabulator -->
  <link href="https://unpkg.com/tabulator-tables@6.2.5/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://unpkg.com/tabulator-tables@6.2.5/dist/js/tabulator.min.js"></script>
  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- JSZip + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://unpkg.com/lucide-static@0.453.0/font/lucide.css">

  <style>
    :root{
      --sidebar-bg:#0F1B2D;
      --sidebar-hover:#122239;
      --primary:#0FA47E;
      --primary-600:#0b8466;
      --surface:#F3F5F7;
      --card:#FFFFFF;
      --text:#0b1220;
      --muted:#6b7280;
      --ring:rgba(15,164,126,.35);
      --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
      color:var(--text);
      background:var(--surface);
    }
    .app{ display:grid; grid-template-columns: 260px 1fr; grid-template-rows: 100vh; }
    .sidebar{ background:var(--sidebar-bg); color:#dbeafe; display:flex; flex-direction:column; padding:18px 14px; }
    .brand{ display:flex;align-items:center;gap:10px; background:#0FA47E10; border:1px solid #0FA47E40;
      color:#d1fae5; padding:8px 10px; border-radius:12px; font-weight:700; letter-spacing:.2px; }
    .brand .logo{ width:46px;height:28px;border-radius:8px; background:linear-gradient(135deg,#11c29a,#0e9e79);
      display:grid;place-items:center;color:white; font-weight:800; }
    .brand .caption{display:flex;flex-direction:column;line-height:1}
    .brand small{opacity:.8; font-weight:600}
    nav{margin-top:18px;display:flex;flex-direction:column;gap:6px}
    .nav-btn{ color:#dbeafe; border-radius:10px; padding:10px 12px; display:flex;align-items:center;gap:10px; text-decoration:none; transition: background .15s ease; }
    .nav-btn:hover{background:var(--sidebar-hover)}
    .nav-btn.active{background:#ffffff10; border:1px solid #ffffff1f}
    .spacer{flex:1}
    .copyright{font-size:12px; color:#93a3b8; opacity:.7}
    .main{ padding:22px 24px; overflow:auto; }
    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px; }
    .toolbar h1{font-size:22px; margin:0}
    .actions{ display:flex; gap:10px; align-items:center }
    .last-updated{ font-size:12px; color:#6b7280; font-weight:600; border:1px dashed #e5e7eb; border-radius:10px; padding:6px 8px; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:var(--card); cursor:pointer; font-weight:600; box-shadow: 0 1px 0 rgba(15,23,42,.03); }
    .btn:focus{outline:2px solid var(--ring); outline-offset:2px}
    .btn-primary{ background:var(--primary); color:white; border-color:transparent}
    .btn-primary:hover{ background:var(--primary-600)}
    .btn-ghost{ background:transparent; border-color:#e5e7eb}
    .btn-danger{ background:var(--danger); color:white; border-color:transparent }
    .grid{ display:grid; gap:14px; }
    .grid.cols-4{ grid-template-columns: repeat(4, minmax(0,1fr)); }
    .card{ background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:16px; }
    .kpi{ display:flex; flex-direction:column; gap:4px; }
    .kpi .label{ color:var(--muted); font-size:13px; font-weight:600}
    .kpi .value{ font-size:28px; font-weight:800}
    .filters{ display:grid; grid-template-columns: 180px 180px 220px 160px 1fr 220px 220px auto; gap:10px; align-items:center; margin-top:10px; }
    .input, select{ width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; background:white; font-size:14px; }
    .tabulator{ border-radius:14px; border:1px solid #e5e7eb }
    .status-pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-weight:700; cursor:pointer; border:1px solid #e5e7eb; background:#fff; }
    .status-pill.disabled{ opacity:.6; cursor:not-allowed; }
    .status-menu{ position:absolute; z-index:2000; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 24px rgba(2,8,23,.18);
      padding:6px; display:none; min-width:180px; }
    .status-menu.open{ display:block }
    .status-item{ display:flex; align-items:center; gap:8px; padding:8px 8px; border-radius:8px; cursor:pointer; }
    .status-item:hover{ background:#f3f4f6 }
    .overlay{ position: fixed; inset:0; display:none; place-items:center; background:rgba(15, 18, 30, .35); z-index:50; }
    .overlay .bubble{ background:white; border-radius:12px; border:1px solid #e5e7eb; padding:10px 14px; display:flex; align-items:center; gap:10px; font-weight:600; box-shadow: 0 10px 20px rgba(2,8,23,.20); }
    .spinner{ width:16px;height:16px;border:2px solid #e5e7eb;border-top-color:#0FA47E;border-radius:50%; animation:spin .9s linear infinite }
    @keyframes spin{ to{ transform: rotate(360deg) } }
    .hidden{ display:none !important }
  </style>
</head>
<body>

<div class="app">
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">UTCD</div>
      <div class="caption">
        <span>Aplicativo</span>
        <small>de Facturas</small>
      </div>
    </div>
    <nav>
      <a class="nav-btn active" href="#inicio"><i class="lucide-home"></i><span>Inicio</span></a>
      <a class="nav-btn" href="#revision"><i class="lucide-list"></i><span>Revisión de Facturas</span></a>
    </nav>
    <div class="spacer"></div>
    <button id="btnLogout" class="btn btn-ghost"><i class="lucide-log-out"></i> Cerrar sesión</button>
    <div class="copyright">© UTCD 2025</div>
  </aside>

  <main class="main">
    <section id="secInicio" style="display:block;">
      <div style="display:flex;align-items:center;justify-content:center;height:60vh;flex-direction:column;gap:12px;">
        <div style="font-size:42px;opacity:.85;">¡Bienvenido!</div>
        <div style="opacity:.7;">Selecciona una sección en el menú para comenzar.</div>
      </div>
    </section>

    <section id="secRevision" style="display:none;">
      <div class="toolbar">
        <h1>Revisión de Facturas</h1>
        <div class="actions">
          <span id="lastUpdated" class="last-updated" title="Última actualización">—</span>
          <button id="btnActualizar" class="btn"><i class="lucide-rotate-cw"></i> Actualizar</button>
          <button id="btnExportXLSX" class="btn btn-ghost"><i class="lucide-download"></i> Excel</button>
          <button id="btnDescargar" class="btn btn-primary"><i class="lucide-file-down"></i> Descargar PDFs</button>
        </div>
      </div>

      <div class="grid cols-4">
        <div class="card kpi"><span class="label">Registradas</span><span id="kpiRegistradas" class="value">0</span></div>
        <div class="card kpi"><span class="label">Revisadas</span><span id="kpiRevisadas" class="value">0</span></div>
        <div class="card kpi"><span class="label">Anuladas</span><span id="kpiAnuladas" class="value">0</span></div>
        <div class="card kpi"><span class="label">Pagadas</span><span id="kpiPagadas" class="value">0</span></div>
      </div>

      <div class="card" style="margin-top:10px;">
        <div class="filters">
          <div id="msSector"></div>
          <div id="msEstado"></div>
          <input id="fNombre" class="input" placeholder="Nombre Colaborador…"/>
          <input id="fNumero" class="input" placeholder="Nº Factura…"/>
          <input id="fFecha" class="input" placeholder="Fecha (rango)"/>
          <input id="fFechaRev" class="input" placeholder="Rango fecha revisión"/>
          <button id="btnLimpiar" class="btn btn-ghost"><i class="lucide-broom"></i> Limpiar</button>
        </div>
        <div class="table-wrap">
          <div id="tablaRevision"></div>
        </div>
      </div>
      <p class="muted" style="margin-top:10px;">Consejo: filtra por <b>Fecha</b> para cargar meses anteriores.</p>
    </section>
  </main>
</div>

<div id="overlay" class="overlay">
  <div class="bubble"><div class="spinner"></div><span id="overlayMsg">Cargando…</span></div>
</div>

<script>
/** =========================
 *  Configuración
 *  ========================= */
const Config = {
  // Cambia esta URL a tu endpoint de Apps Script desplegado
  api: {
    // Debe aceptar ?leerFacturas=true&start=YYYY-MM-DD&end=YYYY-MM-DD
    leerFacturas: "/api/leer",
    guardar: "/api/guardar",
    proxyBase: "/api"
  },
  tablaHeight: "560px",
};

const $ = (sel)=>document.querySelector(sel);

const overlay = {
  show(msg="Cargando…"){ $("#overlayMsg").textContent = msg; $("#overlay").style.display = "grid"; },
  hide(){ $("#overlay").style.display = "none"; }
};
const fmt = {
  money(v){ const n=Number(v||0); return "L " + n.toLocaleString("es-HN",{minimumFractionDigits:2, maximumFractionDigits:2}); },
};

function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }

/** =========================
 *  Normalización (alias únicos)
 *  ========================= */
function normalizeRow(src){
  if(!src || typeof src!=="object") return null;
  const g = (keys, fallback="")=>{
    for(const k of keys){ if(src[k]!=null && src[k]!=="" ) return src[k]; }
    return fallback;
  };
  return {
    fila:      g(["fila","_fila","Fila"]),
    Sector:    g(["Sector"]),
    Placa:     g(["Placa"]),
    Proceso:   g(["Proceso"]),
    Nombre:    g(["Nombre"]),
    Identidad: g(["Identidad"]),
    // === Alias correcto y único para la fecha de factura: "Fecha" ===
    Fecha:     g(["Fecha"]),
    "Numero de Factura": g(["Numero de Factura","Nº Factura","Número de Factura"]),
    "Nombre del comercio": g(["Nombre del comercio"]),
    "Enlace PDF": g(["Enlace PDF","Enlace","PDF"]),
    "Km Actual": g(["Km Actual"]),
    "Litros Consumidos": g(["Litros Consumidos"]),
    Total:     Number(g(["Total","Total Gastado"],0)),
    FechaRevision: g(["FechaRevision","Fecha de Revision","Fecha de Revisión"]),
    Estado:    g(["Estado"], "Registrada"),
  };
}

/** =========================
 *  Capa de datos (API con rango)
 *  ========================= */
const API = { _ctl:null,
  async getFacturasByRange(startDate, endDate){
    if(this._ctl) try{ this._ctl.abort(); }catch(_){}
    this._ctl = new AbortController();
    const params = new URLSearchParams();
    params.set("leerFacturas","true");
    if(startDate) params.set("start", startDate);
    if(endDate)   params.set("end", endDate);
    const url = `${Config.api.leerFacturas}?${params.toString()}`;
    const res = await fetch(url, { cache:"no-store", signal:this._ctl.signal });
    if(!res.ok) throw new Error("No se pudo leer facturas");
    const data = await res.json();
    return (Array.isArray(data)? data:[]).map(normalizeRow).filter(Boolean);
  },
  proxied(url){
    const base = Config.api.proxyBase.replace(/\/$/,"");
    const u = encodeURIComponent(url||"");
    return `${base}/proxy?url=${u}`;
  }
};

/** =========================
 *  Estado + Filtros
 *  ========================= */
const State = { raw:[], get filtered(){
  const n = ($("#fNumero").value||"").trim().toLowerCase();
  const nombreQ = ($("#fNombre").value||"").trim().toLowerCase();
  const dr = $("#fFecha")._range || null;
  const dr2 = $("#fFechaRev")._range || null;
  const eVals = estadoMS? estadoMS.getSelected():[];
  const sVals = sectorMS? sectorMS.getSelected():[];
  return State.raw.filter(r=>{
    if(eVals.length && !eVals.includes(r.Estado||"")) return false;
    if(sVals.length && !sVals.includes(r.Sector||"")) return false;
    if(n && !String(r["Numero de Factura"]||"").toLowerCase().includes(n)) return false;
    if(nombreQ && !String(r.Nombre||"").toLowerCase().includes(nombreQ)) return false;
    if(dr){
      const f = new Date(String(r.Fecha||""));
      if(isNaN(f) || f < dr[0] || f > dr[1]) return false;
    }
    if(dr2){
      const fr = new Date(String(r.FechaRevision||""));
      if(isNaN(fr) || fr < dr2[0] || fr > dr2[1]) return false;
    }
    return true;
  });
}};

function getEstadoOptions(){
  const vals = Array.from(new Set(State.raw.map(r=>r.Estado).filter(Boolean)));
  const def = ["Registrada","Revisada","Anulada","Pagada"];
  return def.concat(vals.filter(v=>!def.includes(v)));
}
function estadoColor(v){
  if(v==="Anulada") return "var(--danger)";
  if(v==="Revisada") return "#2563eb";
  if(v==="Pagada") return "#0FA47E";
  return "#111827";
}

/** =========================
 *  MultiSelect simple
 *  ========================= */
function createMultiSelect(selector, placeholder="Seleccione…", onChange=()=>{}){
  const root = document.querySelector(selector);
  root.classList.add("msel");
  const toggle = document.createElement("button");
  toggle.type = "button";
  toggle.className = "input";
  toggle.style.display = "flex"; toggle.style.justifyContent = "space-between"; toggle.style.alignItems = "center";
  toggle.innerHTML = `<span class="label">${placeholder}</span><i class="lucide-chevron-down"></i>`;
  const panel = document.createElement("div");
  panel.className = "status-menu"; // reutilizamos estilos
  root.appendChild(toggle); root.appendChild(panel);

  let items=[]; const selected=new Set();
  function render(){
    if(selected.size===0){ toggle.innerHTML = `<span class="label">${placeholder}</span><i class="lucide-chevron-down"></i>`; }
    else{
      const vals = Array.from(selected);
      toggle.innerHTML = `<span>${vals.length<=2? vals.join(", "): (vals.length+" seleccionados")}</span><i class="lucide-chevron-down"></i>`;
    }
    panel.innerHTML = "";
    items.forEach(opt=>{
      const div = document.createElement("div"); div.className="status-item";
      const chk = document.createElement("input"); chk.type="checkbox"; chk.checked = selected.has(opt);
      const span = document.createElement("span"); span.textContent = opt;
      div.prepend(chk); div.appendChild(span);
      div.addEventListener("click", (ev)=>{
        const active = !selected.has(opt);
        if(active) selected.add(opt); else selected.delete(opt);
        render(); onChange();
        ev.stopPropagation();
      });
      panel.appendChild(div);
    });
  }
  toggle.addEventListener("click", ()=>{ panel.classList.toggle("open"); });
  document.addEventListener("click", (e)=>{ if(!root.contains(e.target)) panel.classList.remove("open"); });

  return {
    setItems(arr){ items = Array.from(new Set((arr||[]).filter(Boolean))); render(); },
    getSelected(){ return Array.from(selected); },
    clear(){ selected.clear(); render(); onChange(); },
    select(vals=[]){ selected.clear(); (vals||[]).forEach(v=> items.includes(v)&&selected.add(v)); render(); onChange(); }
  };
}

/** =========================
 *  Tabulator
 *  ========================= */
let table, sectorMS, estadoMS;

function buildTable(){
  if(table) return;
  table = new Tabulator("#tablaRevision", {
    height: Config.tablaHeight,
    data: State.filtered,
    layout:"fitColumns",
    selectable:true,
    reactiveData:false,
    columns:[
      { formatter:"rowSelection", titleFormatter:"rowSelection", hozAlign:"center", headerSort:false, width:40 },
      { title:"Sector", field:"Sector", width:120 },
      { title:"Placa", field:"Placa", width:110 },
      { title:"Proceso", field:"Proceso", width:130 },
      { title:"Nombre", field:"Nombre", width:180 },
      { title:"Identidad", field:"Identidad", width:150 },
      { title:"Total Gastado", field:"Total", hozAlign:"right", width:140, formatter:(c)=>fmt.money(c.getValue())},
      { title:"Fecha", field:"Fecha", width:120, formatter:(c)=>{ const v=c.getValue(); return v? String(v).slice(0,10):""; } },
      { title:"Fecha de Revisión", field:"FechaRevision", width:150, formatter:(c)=>{ const v=c.getValue(); return v? String(v).slice(0,10):""; } },
      { title:"Nombre del comercio", field:"Nombre del comercio", width:220, tooltip:true },
      { title:"Número de Factura", field:"Numero de Factura", width:150 },
      { title:"Enlace PDF", field:"Enlace PDF", width:110, formatter:(cell)=>{
          const v = cell.getValue() || cell.getRow().getData().Enlace || cell.getRow().getData().PDF || "";
          return v? `<a href="${API.proxied(v)}" target="_blank" title="Abrir PDF">📄</a>` : "";
      }},
      { title:"Km Actual", field:"Km Actual", width:110, hozAlign:"right" },
      { title:"Litros Consumidos", field:"Litros Consumidos", width:160, hozAlign:"right" },
      { title:"Estado", field:"Estado", width:150, formatter:(c)=>{
          const v = c.getValue()||"Registrada"; const color = estadoColor(v);
          const disabled = (v === "Pagada"); const cls = disabled? "status-pill disabled" : "status-pill";
          return `<span class="${cls}"><span class="dot" style="background:${color}"></span>${v}</span>`;
      } }
    ],
    dataLoaded:updateKpis, dataFiltered:updateKpis
  });
}

function updateKpis(){
  const rows = table? table.getData("active") : [];
  const total = rows.length;
  const revisadas = rows.filter(r=> (r.Estado||"") === "Revisada").length;
  const pagadas   = rows.filter(r=> (r.Estado||"") === "Pagada").length;
  const anuladas  = rows.filter(r=> (r.Estado||"") === "Anulada").length;
  $("#kpiRegistradas").textContent = total;
  $("#kpiRevisadas").textContent = revisadas;
  $("#kpiPagadas").textContent   = pagadas;
  $("#kpiAnuladas").textContent  = anuladas;
  $("#btnDescargar").disabled = total===0;
}

/** =========================
 *  Filtros (incluye fetch por rango)
 *  ========================= */
function setLastUpdatedNow(){
  const el = document.getElementById("lastUpdated"); if(!el) return;
  const now = new Date();
  const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,"0"), d=String(now.getDate()).padStart(2,"0");
  const hh=String(now.getHours()).padStart(2,"0"), mm=String(now.getMinutes()).padStart(2,"0");
  el.textContent = `Actualizado: ${y}-${m}-${d} ${hh}:${mm}`;
}

function initFilters(){
  // date pickers
  const fp = flatpickr("#fFecha", {
    mode:"range", dateFormat:"Y-m-d",
    onChange: async (selectedDates)=>{
      if(selectedDates.length===2){
        selectedDates[0].setHours(0,0,0,0);
        selectedDates[1].setHours(23,59,59,999);
        $("#fFecha")._range = selectedDates;
        await fetchAndRenderByCurrentRange();
      }
    }
  });
  const fpRev = flatpickr("#fFechaRev", {
    mode:"range", dateFormat:"Y-m-d",
    onChange: ()=>{ applyFiltersOnly(); }
  });

  // multiselects
  sectorMS = createMultiSelect("#msSector", "Sector", applyFiltersOnly);
  estadoMS = createMultiSelect("#msEstado", "Estado", applyFiltersOnly);

  // textos
  $("#fNumero").addEventListener("input", debounce(applyFiltersOnly, 250));
  $("#fNombre").addEventListener("input", debounce(applyFiltersOnly, 250));
  $("#btnLimpiar").addEventListener("click", async ()=>{
    sectorMS.clear(); estadoMS.clear();
    $("#fNumero").value = ""; $("#fNombre").value="";
    $("#fFecha")._range = null; $("#fFecha").value = "";
    $("#fFechaRev")._range = null; $("#fFechaRev").value = "";
    await setCurrentMonthInPicker(); // vuelve a mes actual y recarga
  });
  $("#btnActualizar").addEventListener("click", fetchAndRenderByCurrentRange);
}

function applyFiltersOnly(){
  if(!table) return;
  const maybe = table.replaceData(State.filtered);
  if(maybe && typeof maybe.then==="function"){ maybe.then(updateKpis); } else { updateKpis(); }
}

async function setCurrentMonthInPicker(){
  const now = new Date();
  const a = firstDayOfMonth(now), b = lastDayOfMonth(now);
  $("#fFecha")._range = [a,b];
  // set visible value
  const s = `${a.toISOString().slice(0,10)} to ${b.toISOString().slice(0,10)}`;
  document.getElementById("fFecha").value = s;
  await fetchAndRenderByCurrentRange();
}

async function fetchAndRenderByCurrentRange(){
  const dr = $("#fFecha")._range;
  let a,b;
  if(dr && dr.length===2){ a = dr[0]; b = dr[1]; }
  else{ const now = new Date(); a = firstDayOfMonth(now); b = lastDayOfMonth(now); }
  const start = a.toISOString().slice(0,10);
  const end   = b.toISOString().slice(0,10);
  overlay.show("Cargando facturas del rango…");
  try{
    const arr = await API.getFacturasByRange(start, end);
    State.raw = arr;
    if(!table) buildTable();
    // refrescamos opciones
    const sectores = Array.from(new Set(arr.map(r=>r.Sector).filter(Boolean))).sort((x,y)=>x.localeCompare(y));
    sectorMS.setItems(sectores);
    estadoMS.setItems(getEstadoOptions());
    const maybe = table.replaceData(State.filtered);
    if(maybe && typeof maybe.then==="function"){ await maybe; }
    updateKpis(); setLastUpdatedNow();
  }catch(e){
    alert("No fue posible cargar facturas.");
  }finally{
    overlay.hide();
  }
}

/** =========================
 *  Utilidades
 *  ========================= */
function debounce(fn, wait=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), wait); }; }

/** =========================
 *  Navegación
 *  ========================= */
function showOnly(sectionId){
  document.querySelectorAll('main > section').forEach(s => s.style.display='none');
  const tgt = document.getElementById(sectionId); if(tgt) tgt.style.display = 'block';
  document.querySelectorAll('.sidebar .nav-btn').forEach(a=>a.classList.remove('active'));
  const map = {secRevision:'#revision', secInicio:'#inicio'};
  const sel = map[sectionId]; if(sel){ const a = document.querySelector(`.sidebar .nav-btn[href="${sel}"]`); if(a) a.classList.add('active'); }
}
async function navigateTo(sectionId, loader){
  try{ showOnly(sectionId); if(typeof loader==='function'){ await loader(); } } finally {}
}
document.querySelectorAll('.sidebar .nav-btn').forEach(a=>{
  a.addEventListener('click', (ev)=>{
    ev.preventDefault();
    const href = a.getAttribute('href')||'';
    if(href==='#inicio') return navigateTo('secInicio');
    if(href==='#revision') return navigateTo('secRevision', async()=>{
      if(!table){ buildTable(); initFilters(); }
      await setCurrentMonthInPicker(); // <-- por defecto solo MES ACTUAL
    });
  });
});

// Arranque en inicio
showOnly('secInicio');
</script>
</body>
</html>
