<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Revisión de Facturas</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.6.2/dist/css/tabulator.min.css" rel="stylesheet" />

  <!-- Flatpickr CSS -->
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />

  <!-- Font Awesome (official CDNJS snippet with SRI) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg:#0f172a;            /* sidebar */
      --bg-2:#111827;          /* sidebar hover */
      --text:#e5e7eb;          /* sidebar text */
      --primary:#14b8a6;       /* teal */
      --accent:#f59e0b;        /* amber */
      --danger:#ef4444;        /* red */
      --card:#ffffff;          /* content cards */
      --muted:#6b7280;         /* gray */
      --content:#f3f4f6;       /* content bg */
      --border:#e5e7eb;        /* light border */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}

    /* Layout */
    .app{display:flex;min-height:100vh;background:var(--content)}
    .sidebar{width:260px;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
    .brand{display:flex;align-items:center;gap:.75rem;padding:1rem 1.25rem;border-bottom:1px solid rgba(255,255,255,.08)}
    .brand img{height:36px}
    .brand span{font-weight:700;letter-spacing:.4px}

    .nav{display:flex;flex-direction:column;padding:.5rem}
    .nav a{display:flex;align-items:center;gap:.75rem;color:var(--text);text-decoration:none;padding:.75rem 1rem;border-radius:.5rem}
    .nav a:hover{background:var(--bg-2)}
    .nav .active{background:rgba(20,184,166,.18);color:#d1faf5}

    .content{flex:1;display:flex;flex-direction:column;min-width:0}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:#fff;border-bottom:1px solid var(--border)}
    .title{font-size:1.1rem;font-weight:700;color:#111827}

    .page{padding:1rem;display:flex;flex-direction:column;gap:1rem}

    /* KPI cards */
    .kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:1rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
    .card h3{margin:.25rem 0 .5rem;font-size:.95rem;color:#111827}
    .kpi{font-size:1.4rem;font-weight:800}

    .filters{display:flex;flex-wrap:wrap;align-items:end;gap:.75rem;background:#fff;border:1px solid var(--border);border-radius:14px;padding:1rem}
    .field{display:flex;flex-direction:column;gap:.35rem}
    .field label{font-size:.8rem;color:var(--muted)}
    .field select,.field input{height:38px;padding:.4rem .6rem;border:1px solid var(--border);border-radius:.5rem;background:#fff;min-width:180px}

    .actions{margin-left:auto;display:flex;gap:.5rem}
    .btn{height:38px;display:inline-flex;align-items:center;gap:.5rem;padding:0 .9rem;border-radius:.6rem;border:1px solid var(--border);background:#fff;color:#111827;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#022c22}
    .btn.outline{background:transparent;color:#111827}

    /* Table */
    .table-card{background:#fff;border:1px solid var(--border);border-radius:14px;padding:1rem}
    #tablaRevision{width:100%}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:rgba(17,24,39,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .overlay.show{display:flex}
    .spinner{background:#fff;border-radius:12px;padding:1rem 1.25rem;display:flex;align-items:center;gap:.75rem;border:1px solid var(--border)}
    .spinner i{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Responsive */
    @media (max-width: 1024px){
      .sidebar{width:220px}
      .kpis{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <img src="https://dummyimage.com/120x36/14b8a6/ffffff&text=UTCD" alt="UTCD"/>
      <span>Aplicativo de Facturas</span>
    </div>
    <nav class="nav">
      <a href="#" class="active"><i class="fa-solid fa-file-invoice"></i><span>Revisión de Facturas</span></a>
      <a href="#pago"><i class="fa-solid fa-money-bill-wave"></i><span>Pago</span></a>
      <a href="#anticipos"><i class="fa-solid fa-sack-dollar"></i><span>Anticipos</span></a>
    </nav>
    <div style="margin-top:auto;padding:.75rem 1rem;color:#94a3b8;font-size:.8rem">© UTCD 2025</div>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="topbar">
      <div class="title">Revisión de Facturas</div>
      <div class="actions">
        <button id="btnRefresh" class="btn" aria-label="Actualizar"><i class="fa-solid fa-rotate"></i>Actualizar</button>
        <button id="btnZip" class="btn primary" aria-label="Descargar PDFs seleccionados"><i class="fa-solid fa-file-zipper"></i>Descargar PDFs</button>
      </div>
    </div>

    <section class="page">
      <!-- KPIs -->
      <div class="kpis">
        <div class="card"><h3>Registradas</h3><div id="kpi-registradas" class="kpi">0</div></div>
        <div class="card"><h3>Revisadas</h3><div id="kpi-revisadas" class="kpi">0</div></div>
        <div class="card"><h3>Anuladas</h3><div id="kpi-anuladas" class="kpi">0</div></div>
      </div>

      <!-- Filtros -->
      <div class="filters">
        <div class="field">
          <label for="f-sector">Sector</label>
          <select id="f-sector"><option value="">Todos</option></select>
        </div>
        <div class="field">
          <label for="f-estado">Estado</label>
          <select id="f-estado">
            <option value="">Todos</option>
            <option>Registrada</option>
            <option>Revisada</option>
            <option>Anulada</option>
            <option>Pagada</option>
          </select>
        </div>
        <div class="field">
          <label for="f-numero">Nº Factura</label>
          <input id="f-numero" type="text" placeholder="Buscar..." />
        </div>
        <div class="field">
          <label for="f-fecha">Fecha</label>
          <input id="f-fecha" type="text" placeholder="Rango" />
        </div>
        <div class="actions">
          <button id="btnLimpiar" class="btn outline" aria-label="Limpiar filtros"><i class="fa-solid fa-eraser"></i>Limpiar</button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="table-card">
        <div id="tablaRevision"></div>
      </div>
    </section>
  </main>
</div>

<!-- Overlays -->
<div id="ovl" class="overlay"><div class="spinner"><i class="fa-solid fa-circle-notch"></i><span id="ovl-text">Cargando…</span></div></div>

<!-- Libs (defer) -->
<script defer src="https://unpkg.com/tabulator-tables@5.6.2/dist/js/tabulator.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<!-- App -->
<script defer>
/******************************* CONFIG *******************************/
const API_ORIGIN = "https://repositorio-de-pruebas.pages.dev/api"; // ajusta si cambia
const urlLeerFacturas = API_ORIGIN + "/leer";
const urlGuardarFactura = API_ORIGIN + "/guardar";
const CORS_PROXY = API_ORIGIN + "/proxy?url="; // para PDFs

/****************************** HELPERS UI ****************************/ 
const $ = (s)=>document.querySelector(s);
const showOvl = (msg="Cargando…")=>{ document.getElementById('ovl-text').textContent=msg; document.getElementById('ovl').classList.add('show'); document.body.style.cursor='progress'; };
const hideOvl = ()=>{ document.getElementById('ovl').classList.remove('show'); document.body.style.cursor='default'; };

/******************************* ESTADO *******************************/
let tabla;             // instancia Tabulator
let datos = [];        // fuente de verdad en memoria

/***************************** SERVICIOS ******************************/
async function getJSON(url, opts={}){
  // cache-busting + abort support opcional
  const q = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  const r = await fetch(url + q, { headers: { 'cache-control': 'no-store' }, ...opts });
  if(!r.ok) throw new Error(`Error ${r.status}`);
  return r.json();
}
async function postJSON(url, body){
  const r = await fetch(url,{ method:'POST', headers:{ 'content-type':'application/json' }, body:JSON.stringify(body) });
  if(!r.ok) throw new Error('No se pudo guardar');
  return r.json();
}

/******************************* CARGA *******************************/
async function cargarInicial(){
  showOvl('Cargando facturas…');
  datos = await getJSON(urlLeerFacturas);
  poblarSectorSelect(datos);
  renderTabla();
  actualizarKpis();
  hideOvl();
}
function poblarSectorSelect(list){
  const sectores = Array.from(new Set(list.map(x=>x.Sector).filter(Boolean))).sort();
  const sel = document.getElementById('f-sector');
  sel.innerHTML = '';
  const def = document.createElement('option'); def.value=''; def.textContent='Todos'; sel.appendChild(def);
  for(const s of sectores){ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }
}

/******************************* TABLA *******************************/
function renderTabla(){
  if(tabla){ tabla.setData(datos); return; }
  tabla = new Tabulator('#tablaRevision',{
    data: datos,
    layout: 'fitDataStretch',
    height: '70vh',
    selectable: true,
    columns:[
      {title:"Sector", field:"Sector", width:140, headerFilter:true},
      {title:"Placa", field:"Placa", width:100},
      {title:"Proceso", field:"Proceso", width:110},
      {title:"Nombre", field:"Nombre", minWidth:180},
      {title:"Identidad", field:"Identidad", width:130},
      {title:"Total", field:"Total", hozAlign:"right", formatter:"money", formatterParams:{decimal:",",thousand:".",symbol:"L ",precision:2}, width:140},
      {title:"Fecha", field:"Fecha", width:120},
      {title:"Comercio", field:"Comercio", minWidth:160},
      {title:"# Factura", field:"Numero", width:120, headerFilter:true},
      {title:"Estado", field:"Estado", width:120, editor:"select", editorParams:{values:["Registrada","Revisada","Anulada","Pagada"]}},
      {title:"PDF", field:"PDF", width:90, formatter: pdfBtn, hozAlign:'center', headerSort:false},
    ],
    rowUpdated: actualizarKpis,
    dataFiltered: actualizarKpis,
    dataLoaded: actualizarKpis,
    cellEdited: onCellEdited,
  });
}
function pdfBtn(cell){
  const url = cell.getValue();
  if(!url) return "";
  const enc = encodeURIComponent(url);
  return `<button class="btn" style="height:28px" title="Descargar PDF" onclick="descargarPDF('${enc}')"><i class='fa-solid fa-download'></i></button>`;
}
// Exponer para el onclick del formatter
window.descargarPDF = async function(encUrl){
  const url = CORS_PROXY + encUrl; // proxy CORS
  const r = await fetch(url);
  const blob = await r.blob();
  const nombre = decodeURIComponent(encUrl).split('/').pop().split('?')[0] || 'factura.pdf';
  saveAs(blob, nombre);
};

/****************************** ACCIONES *****************************/
async function onCellEdited(cell){
  if(cell.getField() !== 'Estado') return;
  try{
    const fila = cell.getRow().getData();
    await postJSON(urlGuardarFactura, {accion:'actualizarEstado', id:fila.id, estado:fila.Estado});
  }catch(e){
    console.error(e);
    alert('No se pudo actualizar el estado.');
  }finally{ actualizarKpis(); }
}
function actualizarKpis(){
  const f = tabla ? tabla.getData(true) : datos;
  const cont = (estado)=> f.filter(x=>x.Estado===estado).length;
  document.getElementById('kpi-registradas').textContent = cont('Registrada');
  document.getElementById('kpi-revisadas').textContent  = cont('Revisada');
  document.getElementById('kpi-anuladas').textContent   = cont('Anulada');
}

/****************************** FILTROS ******************************/
let fp;
function prepararFiltros(){
  fp = flatpickr('#f-fecha', {mode:'range', dateFormat:'Y-m-d'});
  const aplicar = () =>{
    const filtros=[];
    const s = document.getElementById('f-sector').value; if(s) filtros.push({field:'Sector', type:'=', value:s});
    const e = document.getElementById('f-estado').value; if(e) filtros.push({field:'Estado', type:'=', value:e});
    const n = document.getElementById('f-numero').value; if(n) filtros.push({field:'Numero', type:'like', value:n});
    const rango = fp.selectedDates;
    if(rango && rango.length){
      const d1 = rango[0].toISOString().slice(0,10);
      const test = (v)=> v && v >= d1 && (!rango[1] || v <= rango[1].toISOString().slice(0,10));
      filtros.push({field:'Fecha', type:function(cellValue){return test(cellValue)}});
    }
    tabla.setFilter(filtros);
    actualizarKpis();
  };
  document.getElementById('f-sector').onchange = aplicar;
  document.getElementById('f-estado').onchange = aplicar;
  document.getElementById('f-numero').oninput  = debounce(aplicar, 250);
  document.getElementById('btnLimpiar').onclick = ()=>{ 
    document.getElementById('f-sector').value=''; 
    document.getElementById('f-estado').value=''; 
    document.getElementById('f-numero').value=''; 
    fp.clear(); 
    tabla.clearFilter(); 
    actualizarKpis();
  };
}

/****************************** UTIL ********************************/ 
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

/****************************** ZIP PDFs *****************************/
async function descargarZipSeleccion(){
  const filas = tabla.getSelectedRows().map(r=>r.getData()).filter(f=>f.PDF);
  if(!filas.length){ alert('Selecciona filas con PDF.'); return; }
  showOvl('Preparando ZIP…');
  const zip = new JSZip();
  for(const f of filas){
    try{
      const r = await fetch(CORS_PROXY + encodeURIComponent(f.PDF));
      const b = await r.blob();
      const name = (f.Numero ? `Factura_${f.Numero}` : 'factura') + '.pdf';
      zip.file(name, b);
    }catch(e){ console.warn('PDF falló', f.PDF); }
  }
  const blob = await zip.generateAsync({type:'blob'});
  saveAs(blob, `facturas_${Date.now()}.zip`);
  hideOvl();
}

/****************************** REFRESH ******************************/
let currentAbort;
async function refrescar(){
  currentAbort?.abort();
  currentAbort = new AbortController();
  showOvl('Actualizando…');
  try{ 
    datos = await getJSON(urlLeerFacturas, { signal: currentAbort.signal }); 
    poblarSectorSelect(datos);
    tabla.replaceData(datos); 
    actualizarKpis(); 
  }
  catch(e){ if(e.name !== 'AbortError'){ console.error(e); alert('No se pudo actualizar.'); } }
  finally{ hideOvl(); currentAbort = null; }
}

/****************************** INIT ********************************/
// Nos aseguramos que todas las librerías defer se hayan ejecutado
window.addEventListener('load', async()=>{
  prepararFiltros();
  await cargarInicial();
  document.getElementById('btnRefresh').onclick = refrescar;
  document.getElementById('btnZip').onclick = descargarZipSeleccion;
});
</script>
</body>
</html>
